<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.37">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Emilie Devijver">
<meta name="author" content="Adeline Samson">
<meta name="dcterms.date" content="2024-11-26">
<meta name="keywords" content="functional data, repeated data, confidence band, Kac-Rice formulae, bias, dimension selection">

<title>confband</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="ConfBand_files/libs/clipboard/clipboard.min.js"></script>
<script src="ConfBand_files/libs/quarto-html/quarto.js"></script>
<script src="ConfBand_files/libs/quarto-html/popper.min.js"></script>
<script src="ConfBand_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="ConfBand_files/libs/quarto-html/anchor.min.js"></script>
<link href="ConfBand_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="ConfBand_files/libs/quarto-html/quarto-syntax-highlighting-29e2c20b02301cfff04dc8050bf30c7e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="ConfBand_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="ConfBand_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="ConfBand_files/libs/bootstrap/bootstrap-fde21167b4fcf25904ffbfbc004f719d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Should we correct the bias in Confidence Bands for Repeated Functional Data?</h1>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Authors</div>
  <div class="quarto-title-meta-heading">Affiliations</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="https://lig-aptikal.imag.fr/~devijvee/">Emilie Devijver</a> <a href="mailto:emilie.devijver@univ-grenoble-alpes.fr" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            CNRS, Univ. Grenoble Alpes, Grenoble INP, LIG, 38000 Grenoble, France
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="http://adeline.e-samson.org">Adeline Samson</a> <a href="mailto:adeline.leclercq-samson@univ-grenoble-alpes.fr" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Univ. Grenoble Alpes, CNRS, Grenoble INP, LJK, 38000 Grenoble, France
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 26, 2024</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">November 26, 2024</p>
    </div>
  </div>
    
  </div>
  
<div>
  <div class="abstract">
    <div class="block-title">Abstract</div>
    <p>While confidence intervals for finite quantities are well-established, constructing confidence bands for objects of infinite dimension, such as functions, poses challenges. In this paper, we explore the concept of parametric confidence bands for functional data with an orthonormal basis. Specifically, we revisit the method proposed by Sun and Loader, which yields confidence bands for the projection of the regression function in a fixed-dimensional space. This approach can introduce bias in the confidence bands when the dimension of the basis is misspecified. Leveraging this insight, we introduce a corrected, unbiased confidence band. Surprisingly, our corrected band tends to be wider than what a naive approach would suggest. To address this, we propose a model selection criterion that allows for data-driven estimation of the basis dimension. The bias is then automatically corrected after dimension selection. We illustrate these strategies using an extensive simulation study. We conclude with an application to real data.</p>
  </div>
</div>

<div>
  <div class="keywords">
    <div class="block-title">Keywords</div>
    <p>functional data, repeated data, confidence band, Kac-Rice formulae, bias, dimension selection</p>
  </div>
</div>

</header>


<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>colorize <span class="ot">&lt;-</span> <span class="cf">function</span>(x, color) {</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span> (knitr<span class="sc">::</span><span class="fu">is_latex_output</span>()) {</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a> <span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">textcolor{%s}{%s}"</span>, color, x)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a> } <span class="cf">else</span> <span class="cf">if</span> (knitr<span class="sc">::</span><span class="fu">is_html_output</span>()) {</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a> <span class="fu">sprintf</span>(<span class="st">"&lt;span style='color: %s;'&gt;%s&lt;/span&gt;"</span>, color,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a> x)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a> } <span class="cf">else</span> x</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Functional data analysis is widely used for handling complex data with smooth shapes, finding applications in diverse fields such as neuroscience (e.g., EEG data, <span class="citation" data-cites="Zhang2020">@Zhang2020</span>), psychology (e.g., mouse-tracking data, <span class="citation" data-cites="Quinton-2017-escon">@Quinton-2017-escon</span>), and sensor data from daily-life activities (<span class="citation" data-cites="jacques2022">@jacques2022</span>).</p>
<p>We consider <span style="color: red;">several</span> <!-- multiple --> independent observations of the same function, <span style="color: red;">i.e.</span> <!-- yielding--> noisy functional data. To analyze <span style="color: red;">this</span> <!-- such--> data, a <span style="color: red;">classic</span><!-- common --> approach <!-- , typically in the parametric setting,--> involves projecting the data onto a functional space defined by a family of functions (<span class="citation" data-cites="LI2022104806">@LI2022104806</span>, <span class="citation" data-cites="kokoszka2017introduction">@kokoszka2017introduction</span> Chapter 3). When the family <span style="color: red;">is</span> an orthonormal basis, e.g., <span style="color: red;">the</span> Legendre <span style="color: red;">basis</span> (with the standard scalar product) or Fourier (with another scalar product), the projection is <span style="color: red;">explicit and it is possible to obtain theoretical results.</span> <!-- clearly understood. !--> <span style="color: red;">However, some families, such as splines, are not orthonormal for the standard scalar product.</span> <!--But families such as splines are not orthonormal for the standard scalar product !--> <span style="color: red;">We will discuss the impact of the choice of this family on estimation. We explain why the use of a </span> <!-- leveraging an approximate !--> functional space offers a key advantage: it <span style="color: red;">reduces the problem of inference to the estimation of</span> <!--simplifies the inference problem to estimating!--> coefficients, for example <span style="color: red;">by</span> <!--through methods like!--> least squares or maximum likelihood estimation. <span style="color: red;">The function estimator is then simply an average after projection onto the functional base.</span> <!--Subsequently, the function is estimated as the mean of the functional data following projection onto the functional basis.!--> <span style="color: red;">It is important to accompany the function estimate with a measure of the uncertainty of that estimate, usually</span> <!-- Measuring the uncertainty of an estimator is usually done! --> using confidence intervals <span style="color: red;">or bands</span>. In this paper, <span style="color: red;">we focus on constructing</span> <!--our focus lies specifically on providing!--> a simultaneous confidence band for the <span style="color: red;">mean of the</span> function<!-- means !-->, rather than point-wise confidence intervals. This task presents several challenges: the confidence band must effectively control the simultaneous functional type-I error rate, as opposed to point-wise rates; it must strike a balance between being sufficiently conservative to maintain a confidence level while not being overly so as to render it meaningless; and the method used to construct this confidence band should be computationally feasible for practical application.</p>
<p>Several developments have already been proposed to answer these questions. First, <span style="color: red;">let us</span> consider the case <span style="color: red;">of a single</span> <!--with only one!--> individual (no repetition) but with many time points. Some methods study the asymptotic distribution of the infinity norm between the true function and its estimator. The asymptotics in the number of time points is studied in <span class="citation" data-cites="Hall1991">@Hall1991</span>, <span class="citation" data-cites="Claeskens2003">@Claeskens2003</span>. This approach only works for large datasets in time and is likely to be too conservative otherwise. For small samples, bootstrap methods have been developed to compute the confidence band (<span class="citation" data-cites="Neumann1998">@Neumann1998</span>, <span class="citation" data-cites="Claeskens2003">@Claeskens2003</span>), but with a high computational cost. Another approach is to construct confidence bands based on the volume of the tube formula. <span class="citation" data-cites="sun1994">@sun1994</span> studied the tail probabilities of suprema of Gaussian random processes. This approach is based on an unbiased linear estimator of the regression function. <span class="citation" data-cites="Zhou1998">@Zhou1998</span> used the volume-of-tube formula for estimation by regression splines. <span class="citation" data-cites="Krivobokova2010">@Krivobokova2010</span> used this method for the construction of confidence bands by penalized spline estimators. They proposed to mix Bayesian and frequentist approaches, <span style="color: red;">in order to obtain</span> <!--to get!--> the good properties <span style="color: red;">of</span> <!--from!--> the Bayesian world <span style="color: red;">while</span> <!--but!--> reducing the variability to be less conservative using the frequentist approach. The bias is <span style="color: red;">taken into account by</span> <!--considered through!--> spline modeling, assuming <span style="color: red;">that enough</span> <!--sufficient!--> knots are considered.</p>
<p>Some papers, like ours, rely on several observations of the same function. <span class="citation" data-cites="Liebl2019">@Liebl2019</span> <!--have!--> proposed a method based <span style="color: red;">on the Kac-rice formula, </span> random field theory and the volume-of-tube formula. They provide a band with locally varying widths using an unbiased estimator. Their method does not require <!--the!--> estimation of the full covariance function of the estimator, but only its diagonal. This reduces the computational time. From a practical viewpoint, <span class="citation" data-cites="CB_survivalAnalysis2022">@CB_survivalAnalysis2022</span> introduced a package to popularize simultaneous confidence bands, in the context of survival analysis. <span class="citation" data-cites="bunea2011">@bunea2011</span> propose a threshold-type estimator and derive error bounds and simultaneous confidence bands, having an unbiased estimator. <span class="citation" data-cites="TELSCHOW202270">@TELSCHOW202270</span> propose a simultaneous confidence band based on the Gaussian kinematic formula. Again, it assumes access to an <span style="color: red;">asymptotically</span> unbiased estimator of the function of interest. <span style="color: red;">The coverage will thus be guaranteed in the asymptotic setting after removing the bias, by smoothing the data for example. Their paper considers the non-gaussian and non-stationary cases.</span> <span class="citation" data-cites="wang2022">@wang2022</span> proposed a simultaneous Kolmogorov-Smirnov confidence band by modeling the error distribution, thus avoiding the estimation of the covariance structure of the underlying stochastic process. They rely on B-splines for the estimation of the mean curve. Note that recent extensions have been proposed, <span style="color: red;">based on Lipschitz-Killing-Curvatures estimators</span> <!--to nonstationary random field !--> in <span class="citation" data-cites="Telschow2023">@Telschow2023</span>, based on conformal prediction in <span class="citation" data-cites="conformalPrediction2022">@conformalPrediction2022</span>, or having a prediction goal in mind in <span class="citation" data-cites="Jacques2023">@Jacques2023</span> by considering functional time series data set. <!-- These extensions are out of the scope of this paper, focusing on the simple functional case. !--></p>
<p>One limitation of all those approaches is that they do not <!-- generally !--> <span style="color: red;">clearly</span> take into account the bias of the functional estimator. <span style="color: red;">Taking account of bias is particularly important when working in a non-asymptotic context.</span> <span class="citation" data-cites="sun1994">@sun1994</span> proposed a bias correction for a particular class of functions but left the smoothing parameter choice open, leading to an unusable estimator. In the nonparametric framework, the bias is approximated using the estimator of the second derivative of the underlying mean function (<span class="citation" data-cites="Xia1998">@Xia1998</span>). But in general, there is a lack of discussion on how to handle the bias of the functional estimator, even in the simple case of a functional space of finite dimension.</p>
<p><span style="color: red;">Another issue is the selection of the dimension of the basis. Hard-thresholding approaches, cross-validation methods</span> (<span class="citation" data-cites="LI2022104806">@LI2022104806</span>) <span style="color: red;">or model selection framework could be used to select the best dimension.</span> <span style="color: red;">However, these approaches need to be adapted to the specific case of controlling the level of a confidence band. Few references exist on this subject. For example, while the model selection paradigm has been extensively studied in the literature, in multivariate statistics or functional data analysis (e.g.,</span> <span class="citation" data-cites="GoeppSubmitted">@GoeppSubmitted</span>, <span class="citation" data-cites="ANEIROS2022104871">@ANEIROS2022104871</span>, <span class="citation" data-cites="BASNA2022104868">@BASNA2022104868</span>), <span style="color: red;">it has not been explored in the context of confidence band construction.</span></p>
<p>The objective of this paper is to address the bias problem in confidence band construction for a general function, <span style="color: red;">in the non-asymptotic setting</span>, utilizing a finite functional orthonormal family <span style="color: red;">and to select the best band.</span> Our contributions are as follows:</p>
<ul>
<li>we disentangle the bias issue by explicitly defining the parameter of interest within the approach of <span class="citation" data-cites="sun1994">@sun1994</span>;</li>
<li>we propose a bias correction method in a new confidence band for the function of interest. <span style="color: red;">This provides a collection of debiased confidence bands. We also propose a criteria to select the best band, by splitting the sample into two sub-samples</span></li>
<li><!-- Finally !-->
<span style="color: red;">to avoid the loss of precision due to sample splitting,</span> we propose a second heuristic method for selecting the dimension of the approximation space, treating it as a model selection problem, with a trade-off between conservatism and confidence level assurance; <span style="color: red;">this approach does not correct the bias of each band of the collection but selects a band with a negligible bias;</span></li>
<li>we illustrate <!-- this confidence band, concluding on the conservatism of the procedure !--> <span style="color: red;">the proposed strategies and compare them to cross-validation or threshold approaches</span>;</li>
<li><span style="color: red;">we also illustrate the impact of the choice of the functional family, including non-orthonormal families.</span></li>
</ul>
<p>The paper is organized as follows: <a href="#sec-model" class="quarto-xref">Section&nbsp;2</a> introduces the functional regression model, the considered functional family and the corresponding approximate regression models, as well as an estimator defined in the finite space, along with descriptions of the error terms. In <a href="#sec-bandSun" class="quarto-xref">Section&nbsp;3</a>, we propose a confidence band for the approximate regression function in the space of finite dimension, where the dimension is fixed. <a href="#sec-band2" class="quarto-xref">Section&nbsp;4</a> proposes a strategy to construct a confidence band for the true function. This last confidence band being too conservative, <a href="#sec-modsel" class="quarto-xref">Section&nbsp;5</a> introduces a model selection criterion to select the best confidence band, doing a trade-off between conservatism and confidence level assurance. <a href="#sec-simulation" class="quarto-xref">Section&nbsp;6</a> <span style="color: red;"> illustrates the different estimating procedures of the confidence band.</span> <a href="#sec-realdata" class="quarto-xref">Section&nbsp;7</a> <span style="color: red;"> proposes an application on real data.</span> <a href="#sec-conc" class="quarto-xref">Section&nbsp;8</a> ends the paper by a conclusion and discussion of perspectives. <!--The different estimation procedures are illustrated throughout the sections. !--></p>
</section>
<section id="sec-model" class="level1">
<h1>Statistical Model</h1>
<p>In this paper, we consider time series as discrete measurements of functional curves. We first present the general functional regression model (<a href="#sec-functional_model" class="quarto-xref">Section&nbsp;2.1</a>) where the regression function belongs to a finite functional family of dimension <span class="math inline">\(L^*\)</span>. In practice, this dimension <span class="math inline">\(L^*\)</span> is unknown and we will work on functional space of dimension <span class="math inline">\(L\)</span>. The regression model on the finite family of functions is presented in <a href="#sec-projection_model" class="quarto-xref">Section&nbsp;2.2</a>, and an estimator is proposed in <a href="#sec-estim" class="quarto-xref">Section&nbsp;2.3</a>, with a description of the error terms.</p>
<p><span style="color: red;"> In the rest of the paper, we consider the space </span> <span class="math inline">\(L^2([0,1])\)</span> with its standard scalar product <span class="math inline">\(&lt;f_1,f_2&gt; = \int_0^1 |f_1(t)f_2(t)|dt\)</span>, for <span class="math inline">\(f_1,f_2 \in L^2([0,1])\)</span>. The notation <span class="math inline">\(Vect\)</span> denotes the linear span.</p>
<section id="sec-functional_model" class="level2">
<h2 class="anchored" data-anchor-id="sec-functional_model">Functional regression model</h2>
<p>Let <span class="math inline">\(y_{ij}\)</span> be the measure at fixed time <span class="math inline">\(t_{j} \in [a,b]\)</span> for individual <span class="math inline">\(i=1, \ldots, N\)</span>, with <span class="math inline">\(j=1, \ldots, n\)</span>. <span style="color: red;">The case with time observations dependent of the individuals is a natural extension of this case, but introduces a bias through the interpolation that is not easy to take into account. </span> We restrict ourselves to <span class="math inline">\([a,b] = [0,1]\)</span>, without loss of generality. We assume these observations are discrete-time measurements of individual curves, which are independent and noisy realisations of a common function <span class="math inline">\(f\)</span> that belongs to a functional space. Thus for each individual <span class="math inline">\(i\)</span>, we consider the following functional regression model <span class="math display">\[\begin{equation*}
y_{ij} = f(t_{j}) + \varepsilon_{ij},
\end{equation*}\]</span> where <span class="math inline">\(\varepsilon_{i.}=(\varepsilon_{i1}, \ldots, \varepsilon_{in})\)</span> is the <span style="color: red;">measurement</span> noise <!-- representing the individual functional variation around $f$.
We !-->assuming that the <span class="math inline">\(\varepsilon_{i}\)</span> are independent. <!-- Their distribution is detailed below. !--></p>
<p>For each individual <span class="math inline">\(i=1, \ldots, N\)</span>, we denote <span class="math inline">\(y_{i.}=(y_{i1}, \ldots, y_{in})\)</span> <!-- the $n\times 1$ vector of observations !-->, <span class="math inline">\(t_{.}=(t_{1}, \ldots, t_{n})\)</span> <!-- the $n \times 1$ vector of observation times !--> and <span class="math inline">\(f(t_{.})=(f(t_{1}), \ldots, f(t_{n}))\)</span> the <span class="math inline">\(n \times 1\)</span> vectors of the <span style="color: red;"> observations, times and </span> function <span class="math inline">\(f\)</span> evaluated in <span class="math inline">\(t_{.}\)</span>, respectively. We also denote <span class="math inline">\(\mathbf{y} = (y_{1.}, \ldots, y_{N.})\)</span> the whole matrix of observations.</p>
<p>Let us introduce the functional space <span class="math inline">\(\mathcal{S}^{L^*} = Vect((t \mapsto B_\ell^{L^*}(t))_{1\leq \ell \leq L^*})\)</span> with <span class="math inline">\(L^*\)</span> functions <span class="math inline">\((B_\ell^{L^*})_{1\leq \ell \leq L^*}\)</span> assumed to be linearly independent. Then, for any <span class="math inline">\(f \in \mathcal{S}^{L^*}\)</span>, there exists a unique vector of coefficients <span class="math inline">\((\mu_{\ell}^{L^*})_{1\leq \ell \leq L^*}\)</span> such that, for all <span class="math inline">\(t\)</span>, <span class="math inline">\(f(t) = \sum_{\ell =1}^{L^*} \mu_{\ell}^{L^*} B_\ell^{L^*}(t)\)</span>. The regression function <span class="math inline">\(f\)</span> verifies the following assumption:</p>
<p><strong>Assumption 1.</strong> The function <span class="math inline">\(f\)</span> belongs to the space <span class="math inline">\(\mathcal{S}^{L^*}\)</span> of dimension <span class="math inline">\(L^*\)</span>. It is denoted <span class="math inline">\({f}^{L^*}\)</span> and defined as: <span class="math display">\[f(t) = {f}^{L^*}(t) = \sum_{\ell = 1}^{L^*} \mu_\ell^{L^*} B^{L^*}_\ell(t). \]</span></p>
<p>Many functional spaces are available in the literature, as Splines, Fourier or Legendre families. We introduce the following assumption:</p>
<p><strong>Assumption 2.</strong> The functional family <span class="math inline">\((t \mapsto B^{L^*}_\ell(t))_{1\leq \ell\leq L^*}\)</span> is orthonormal with respect to the standard scalar product <span class="math inline">\(&lt;.,.&gt;\)</span>.</p>
<p>Note that if Assumption 2 holds, one get <span class="math inline">\(\mu_\ell^{L^*} = &lt;{f}^{L^*},B^{L^*}_\ell&gt;\)</span> for <span class="math inline">\(\ell = 1,\ldots, L^*\)</span>. The Legendre family is orthonormal, the Fourier family is orthogonal for the standard scalar product (but not orthonormal), and the B-splines family is not orthogonal. <span style="color: red;"> We will illustrate the impact of using one family or the other.</span></p>
<p>We also consider a functional noise through the following assumption.</p>
<p><strong>Assumption 3.</strong> The sequence <span class="math inline">\(\varepsilon_{i}\)</span> is functional and <span style="color: red;"> allows Karhunen-Lo√®ve <span class="math inline">\(L^2\)</span> representation:</span> there exists a sequence of coefficients <span class="math inline">\((c_{i\ell})_{1\leq \ell}\)</span> such that <span class="math display">\[\varepsilon_{ij} = \sum_{\ell \geq 1} c_{i\ell} \phi_\ell(t_{j}),\]</span> <span style="color: red;">where the functions</span> <span class="math inline">\((\phi_\ell)_{1\leq L}\)</span> <span style="color: red;"> can be written through eigenvalues and eigenfunctions of the covariance matrix </span> <span class="math inline">\(cov(\varepsilon_{ij}, \varepsilon_{ij'})\)</span>. <span style="color: red;">Practically, we assume this sum to be finite, as done for example in </span> <span class="citation" data-cites="Chen2015">@Chen2015</span>: there exists <span class="math inline">\(L^\varepsilon\)</span> such that <span class="math display">\[\varepsilon_{ij} = \sum_{1 \leq L \leq L^\varepsilon} c_{i\ell} \phi_\ell(t_{j}),\]</span></p>
<p>We also assume that the coefficients are Gaussian: for all <span class="math inline">\(i=1,\ldots, N\)</span> and <span class="math inline">\(\ell=1, \ldots, L^\varepsilon\)</span>, <span class="math display">\[c_{i \ell} \sim_{iid} \mathcal{N}(0,\sigma^2).\]</span></p>
<p>Assumption 1 and Assumption 3 imply that each curve <span class="math inline">\(y_i\)</span> belongs to a finite family: for <span class="math inline">\(j=1,\ldots,n\)</span>, <span class="math display">\[ y_{ij} = \sum_{\ell=1}^{L^*} \mu_{\ell}^{L^*} B_\ell^{L^*}(t_{j}) + \sum_{\ell=1}^{L^\varepsilon} c_{i\ell} \phi_\ell(t_{j}). \]</span></p>
<p>As the observations are recorded at discrete time points <span class="math inline">\((t_j)_{1\leq j \leq n}\)</span>, <!--we introduce the family of functions evaluated at the discrete times of observations. For!--> for <span class="math inline">\(L\in \mathbb{N}\)</span>, let us denote <span class="math inline">\(\mathbf{B}^L\)</span> the matrix of <span class="math inline">\(n\times L\)</span> with coefficient in row <span class="math inline">\(j\)</span> and column <span class="math inline">\(\ell\)</span> equal to <span class="math inline">\(B^L_\ell(t_{j})\)</span>, <span style="color: red;">and the basis for the noise</span> <span class="math inline">\(\Phi^{L^\varepsilon} = (\phi_\ell(t_j))_{1\leq \ell \leq L^\varepsilon, 1\leq j \leq n}\)</span>. Let us introduce <span class="math inline">\(c_{i.}=(c_{i1}, \ldots, c_{iL^\varepsilon})\)</span> the <span class="math inline">\(L^\varepsilon \times 1\)</span> vector. Then <span class="math inline">\(\varepsilon_{i.} = \Phi^{L^\varepsilon} c_{i.}\)</span>. The vectors <span class="math inline">\(y_{i.} \in \mathbb{R}^n\)</span> are thus independent and <span class="math inline">\(y_i\sim \mathcal{N}_n(f(t_{.}), \sigma^2 \Sigma^{L^\varepsilon})\)</span> with <span class="math inline">\(\Sigma^{L^\varepsilon} = \Phi^{L^\varepsilon} (\Phi^{L^\varepsilon})^T\)</span>.</p>
<p>The objective of this paper is to construct a tight confidence bound for <span class="math inline">\(f^{L^*}\)</span> using data <span class="math inline">\((y_{ij})_{ij}\)</span>. The main challenge is that the true dimension <span class="math inline">\(L^*\)</span> is unknown. In the rest of the paper, we will work with a collection of models defined on a finite family of dimension <span class="math inline">\(L\)</span> with <span class="math inline">\(L\in \{L_{\min}, \ldots, L_{\max}\}\)</span>, <span class="math inline">\(L_{\max}\)</span> being chosen to be sufficiently large by the user, expecting that <span class="math inline">\(L^*\leq L_{\max}\)</span>. <span class="math inline">\(L_{\max}\)</span> <span style="color: red;">has to be large enough to do overfitting.</span> Then we will propose different strategies to choose the best bandwidth among the different collections.</p>
<p>First, in <a href="#sec-projection_model" class="quarto-xref">Section&nbsp;2.2</a> and <a href="#sec-estim" class="quarto-xref">Section&nbsp;2.3</a>, we define for a fixed <span class="math inline">\(L\)</span> the corresponding regression model and its estimator. Then <a href="#sec-bandSun" class="quarto-xref">Section&nbsp;3</a>, <a href="#sec-band2" class="quarto-xref">Section&nbsp;4</a> and <a href="#sec-modsel" class="quarto-xref">Section&nbsp;5</a> will introduce the different bandwidths.</p>
</section>
<section id="sec-projection_model" class="level2">
<h2 class="anchored" data-anchor-id="sec-projection_model">Approximation of the model on a finite family</h2>
<p>Let <span class="math inline">\(f^{L^*} \in \mathcal{S}^{L^*}\)</span> with <span class="math inline">\(L^*\)</span> unknown, and consider the space <span class="math inline">\(\mathcal{S}^L\)</span> for <span class="math inline">\(L\)</span> fixed in <span class="math inline">\(\{L_{\min}, \ldots, L_{\max}\}\)</span>. As <span class="math inline">\(\mathcal{S}^L\)</span> is a family of linearly independent functions, there <span style="color: red;">is</span> always <!--exists!--> a unique vector <span class="math inline">\(\mu^{L,L^*}\)</span> of coefficients defining <span class="math inline">\(f^{L,L^*}(t) = \sum_{\ell_=1}^L \mu_\ell^{L,L^*} B_\ell^L(t)=B^L(t) \mu^{L,L^*}\)</span> such that <span class="math display">\[f^{L,L^*} = \arg\min_{f \in \mathcal{S}^L}\{\|f^{L^*} - f\|_2^2\}.\]</span> <!--and if !--> <span style="color: red;">If</span> the family is orthonormal<!--(Assumption 2)!-->, it corresponds to the projected coefficients <span class="math inline">\(\mu_{\ell}^{L,L^*}\)</span>: <span class="math display">\[\mu_{\ell}^{L,L^*} :=&lt;f^{L^*}, B_\ell^L&gt;.\]</span></p>
<p>We can prove the following property:</p>
<div id="prp-proj" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 1</strong></span> Under Assumption 1, <span class="math display">\[f^{L^*,L^*} = f^{L^*}.\]</span> Moreover, if Assumption 2 also holds, the projection coefficients verify <span class="math display">\[\mu_{\ell}^{L,L^*} = \mu_\ell^{L^*} \quad{ for }\; \ell =1, \ldots, \min(L, L^{*}).\]</span></p>
</div>
<p>In practice, data are observed at discrete time, we consider the operator <span class="math inline">\(\mathbf{P}^L\)</span> defined as the matrix <span class="math inline">\(\mathbf{P}^L = ((\mathbf{B}^L)^T \mathbf{B}^L)^{-1} (\mathbf{B}^L)^T\)</span> of size <span class="math inline">\(L\times n\)</span>. <span style="color: red;">This coincides with the orthogonal projection when we deal with an orthonormal basis, but it is also consistent for non orthonormal family, coming back to the least square estimator on a specified family.</span> <!--(this operator is a bit more complex when the functional family is not orthonormal wrt the standard scalar product). !--> Then we define the coefficients <span class="math inline">\(\underline{\mu}^{L,L^*}\)</span> which are the coefficients of <span class="math inline">\({\mu}^{L,L^*}\)</span> approximated on the vector space, denoted <span class="math inline">\(\mathbf{S}^L\)</span>, defined by the matrix <span class="math inline">\(\mathbf{B}^L\)</span>. <span class="math display">\[\underline{\mu}^{L,L^*} := \mathbf{P}^L \mathbf{B}^{L^*}\mu^{L^*}.\]</span></p>
<p>The corresponding finite approximated regression function is denoted <span class="math inline">\(\underline{f}^{L,L^*}\)</span> and is defined, for all <span class="math inline">\(t\in [0,1]\)</span>, as <span class="math display">\[\underline{f}^{L,L^*}(t) = B^L(t) \underline{\mu}^{L,L^*}.\]</span></p>
<p>We can prove the following properties linking <span class="math inline">\(L, L^*\)</span> and the number of timepoints <span class="math inline">\(n\)</span>:</p>
<div id="prp-proj2" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 2</strong></span> Under Assumption 1 and Assumption 2, <span style="color: red;">the diagonal elements of </span> <span class="math inline">\(\mathbf{P}^L \mathbf{B}^{L^*}\)</span> <span style="color: red;">are such that for</span> <span class="math inline">\(\ell=1, \ldots, \min(L, L^*),\)</span> <span class="math display">\[[\mathbf{P}^L \mathbf{B}^{L^*}]_{\ell\ell}=1.\]</span></p>
<ul>
<li>When <span class="math inline">\(L\geq L^*\)</span>, <!--$\mathbf{P}^L \mathbf{B}^{L^*}$ has $L^*$ diagonal elements equal to 1 and other non-diagonal elements close to 0.!--> <span style="color: red;">when <span class="math inline">\(n&gt;L\)</span>, we have</span> for <span class="math inline">\(\ell=1, \ldots, L^*\)</span>,</li>
</ul>
<p><span class="math display">\[ \underline{\mu}^{L,L^*}_\ell = \mu^{L^*}_\ell.\]</span></p>
<!--The first $L^*$ elements of $\underline{\mu}^{L,L^*}$ are equal to $\mu^{L^*}$ when $n>L$.!-->
<ul>
<li>When <span class="math inline">\(L&lt;L^*\)</span>, <!--$\mathbf{P}^L\mathbf{B}^{L^*}$ has $L$ diagonal elements equal to 1.!--> <span style="color: red;">for</span> <span class="math inline">\(\ell =1, \ldots, L\)</span>, <span class="math display">\[\underline{\mu}^{L,L^*}_\ell \neq \mu^{L^*}_\ell.\]</span></li>
</ul>
<!-- The first $L$ elements of $\underline{\mu}^{L,L^*}$ are different to $\mu_\ell^{L^*}$.!-->
<ul>
<li>When <span class="math inline">\(n\rightarrow\infty\)</span>, <span style="color: red;">for</span> <span class="math inline">\(\ell = 1,\ldots, L\)</span> <span class="math display">\[\underline{\mu}_\ell^{L,L^*}\rightarrow \mu_\ell^{L^*}. \]</span></li>
<li>If <span class="math inline">\(n&gt;L^*\)</span>, then <span class="math inline">\(f^{L^*} = f^{L^*,L^*} = \underline{f}^{L^*,L^*}\)</span>.</li>
</ul>
</div>
</section>
<section id="sec-estim" class="level2">
<h2 class="anchored" data-anchor-id="sec-estim">Estimator</h2>
<p>Let <span class="math inline">\(L\in \{L_{\min}, \ldots, L_{\max}\}\)</span>. This section presents the least square estimator of the regression function on the space of dimension <span class="math inline">\(L\)</span> defined by the family <span class="math inline">\(\mathbf{B}^L\)</span> and discusses its error.</p>
<section id="estimation-of-the-regression-function" class="level3">
<h3 class="anchored" data-anchor-id="estimation-of-the-regression-function">Estimation of the regression function</h3>
<p>When considering the estimation of the regression function <span class="math inline">\(f^{L^*}\)</span> on the space of dimension <span class="math inline">\(L\)</span> defined by the family <span class="math inline">\(\mathbf{B}^L\)</span>, we do not directly estimate <span class="math inline">\(f^{L^*}\)</span> but its projection on this finite space, which corresponds to the projected function <span class="math inline">\(\underline{f}^{L,L^*}(t)\)</span> and its associated coefficients <span class="math inline">\((\underline{\mu}_\ell^{L,L^*})_{1 \leq \ell \leq L}\)</span>.</p>
<div id="def-proj2" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 1</strong></span> The vector of coefficients <span class="math inline">\((\underline{\mu}_\ell^{L,L^*})_{1 \leq \ell \leq L}\)</span> is estimated by the least square estimator <span class="math inline">\(\hat{\underline{\mu}}^{L, L^*}\)</span> defined as: <span class="math display">\[\begin{align*}
\hat{\underline{\mu}}^{L, L^*}:=\frac1N \sum_{i=1}^N
\mathbf{P}^L y_{i.}.
\end{align*}\]</span></p>
<p>For a fixed <span class="math inline">\(t \in [0,1]\)</span>, the estimator of the function <span class="math inline">\(\underline{f}^{L,L^*}(t)\)</span> is defined by:</p>
<p><span id="eq-fhatL"><span class="math display">\[ \underline{\hat{f}_{}}^{L,L^*}(t) = \sum_{\ell=1}^L \underline{\hat \mu}_\ell^{L,L^*} B^L_\ell(t)= B^L(t)\hat{\underline{\mu}}^{L,L^*}.
\tag{1}\]</span></span></p>
</div>
<p><a href="#eq-fhatL" class="quarto-xref">Equation&nbsp;1</a> directly implies that the estimator is thus the empirical mean of the functional approximation of each individual vector of observations. Because we work with least squares estimators, we can easily study the error of estimation of <span class="math inline">\(\hat{\underline{\mu}}^{L, L^*}\)</span> and <span class="math inline">\(\underline{\hat{f}_{}}^{L,L^*}\)</span>.</p>
<div id="prp-error" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 3</strong></span> Under Assumption 1 and Assumption 3, we have <span class="math display">\[\begin{align*}
\hat{\underline{\mu}}^{L, L^*}
&amp;\sim \mathcal{N}_L\left(\underline{\mu}^{L, L^*}, \frac{\sigma^2}N\Sigma_{B}^{L,L^\varepsilon}
\right),
\end{align*}\]</span> where the <span class="math inline">\(L\times L\)</span> covariance matrix <span class="math inline">\(\Sigma_{B}^{L,L^{\varepsilon}}\)</span> is defined as <span class="math inline">\(\Sigma_{B}^{L,L^\varepsilon}:=\mathbf{P}^L \Sigma^{L^\varepsilon} (\mathbf{P}^L)^T\)</span> with <span class="math inline">\(\Sigma^{L^\varepsilon}= \Phi^{L^\varepsilon} (\Phi^{L^\varepsilon})^T\)</span>.</p>
<p>Moreover, <span class="math inline">\(B^L()\mathbf{P}^L y_i\)</span> is a Gaussian process with mean <span class="math inline">\(\underline{f}^{L,L^*}()\)</span> and covariance function <span class="math inline">\((s,t) \mapsto \sigma^2 B^L(s) \Sigma_{B}^{L,L^\varepsilon} (B^L(t))^T\)</span>, and <span class="math inline">\((\underline{\hat{f}_{}}^{L,L^*}- \underline{f}^{L,L^*})()\)</span> is a centered Gaussian process with covariance function <span class="math inline">\(C^{L,L^*}: (s,t) \mapsto \frac{\sigma^2}N B^L(s) \Sigma_{B}^{L,L^\varepsilon} B^L(t)^T\)</span>.</p>
</div>
<p>The proof is given in Appendix.</p>
<p>Even if the estimator <span class="math inline">\(\underline{\hat{f}_{}}^{L,L^*}\)</span> is defined on the functional space associated to <span class="math inline">\(\mathbf{S}^L\)</span>, it can also be seen as an estimator of the function <span class="math inline">\(f^{ L^*}\)</span> which lies in the space <span class="math inline">\(\mathcal{S}^{L^*}\)</span>. In that case, the error includes a functional approximation term due to the approximation of <span class="math inline">\(f^{ L^*}\)</span> on the space <span class="math inline">\(\mathcal{S}^L\)</span>, which will be nonzero if <span class="math inline">\(L\neq L^*\)</span>. It corresponds to the bias of the estimator <span class="math inline">\(\underline{\hat{f}_{}}^{L,L^*}\)</span>, i.e.&nbsp;the difference between its expectation and the true <span class="math inline">\(f^{ L^*}\)</span>. Indeed, recalling that <span class="math inline">\(f^{L^*} = \underline{f}^{L^*,L^*}\)</span>, the error of estimation can be decomposed into <span id="eq-decomposition"><span class="math display">\[
\underline{\hat{f}}^{L, L^*}(t) -f^{L^*}(t)
= \underline{\hat{f}}^{L, L^*}(t) - \underline{f}^{L, L^*}(t) + \underline{f}^{L, L^*}(t) - \underline{f}^{L^*,L^*}(t) =: Stat_{L,L^*}(t) + Bias_{L,L^*}(t),
\tag{2}\]</span></span></p>
<p>The first term <span class="math inline">\(Stat_{L,L^*}(t) = \underline{\hat{f}}^{L, L^*}(t) - \underline{f}^{L, L^*}(t)\)</span> is the (unrescaled) statistics of the model. The second term <span class="math inline">\(Bias_{L,L^*}(t) = \mathbb{E}(\underline{\hat{f}}^{L, L^*}(t)) - \underline{f}^{L^*,L^*}(t)\)</span> is the bias of the estimator <span class="math inline">\(\underline{\hat{f}}^{L, L^*}(t)\)</span> when estimating the true function <span class="math inline">\(\underline{f}^{L^*,L^*}(t)\)</span>.</p>
<p>Let us remark that this bias is different than the bias of the estimator <span class="math inline">\(\underline{\hat{f}}^{L, L^*}(t)\)</span> when estimating the projected function <span class="math inline">\(\underline{f}^{L,L^*}=f^{ L^*}\)</span>, which is 0. The two terms defined in <a href="#eq-decomposition" class="quarto-xref">Equation&nbsp;2</a> are more detailed in the two next subsections.</p>
</section>
<section id="statistics" class="level3">
<h3 class="anchored" data-anchor-id="statistics">Statistics</h3>
<p>The statistics of the model, <span class="math inline">\(t\mapsto Stat_{L,L^*}(t) = \underline{\hat{f}}^{L, L^*}(t) - \underline{f}^{L, L^*}(t)\)</span>, is a random functional quantity which depends on the estimator <span class="math inline">\(\underline{\hat{f}}^{L, L^*}\)</span>. From <a href="#prp-error" class="quarto-xref">Proposition&nbsp;3</a>, for any <span class="math inline">\(t\in [0,1]\)</span>, we define the centered and rescaled statistics <span class="math inline">\(Z_L(t)\)</span>: <!--such that: !--> <span class="math display">\[Z_L(t):= \frac{Stat_{L,L^*}(t)}{\sqrt{\text{Var}(Stat_{L,L^*}(t))}}
= \frac{\underline{\hat{f}}^{L, L^*}(t) - \underline{f}^{L, L^*}(t)}{\sqrt{C^{L, L^*}(t,t)}}\sim \mathcal{N}(0,1). \]</span></p>
<p>The covariance function can be naturally estimated using the observations <span class="math inline">\(y_{i.}\)</span> as <span class="math display">\[\hat C^{L, L^*}(s,t) = \frac1{N-1}\sum_{i=1}^{N} (B^L(s)\mathbf{P}^L y_{i.} - \underline{\hat{f}_{}}^{L,L^*}(s))(B^L(t)\mathbf{P}^L y_{i.} - \underline{\hat{f}_{}}^{L,L^*}(t)).\]</span></p>
</section>
<section id="bias" class="level3">
<h3 class="anchored" data-anchor-id="bias">Bias</h3>
<p>The bias is due to the fact that the estimation is potentially performed in a different (finite) space than the space where the true function <span class="math inline">\(\underline{f}^{L^*,L^*}\)</span> lives. This is a functional bias, which is not random. It corresponds to the approximation of <span class="math inline">\(f^{L^*}\)</span> from <span class="math inline">\(\mathcal{S}^{L^*}\)</span> to the space <span class="math inline">\(\mathcal{S}^{L}\)</span>. It can be written as follows: <span class="math display">\[Bias_{L,L^*}(t) = B^L(t) \underline{\mu} ^{L,L^*} - B^{L^*}(t) \mu^{L^*}.\]</span> Thus, when <span class="math inline">\(L&lt;L^*\)</span> and the family is orthonormal, <span style="color: red;">the approximation is the orthogonal projection and we can deduce that</span> <!-- (Assumption 2 holds), !--> <span class="math display">\[Bias_{L,L^*}(t)= \sum_{\ell=1}^L B_\ell^L(t)\underline{\mu}_\ell^{L,L^*} - \sum_{\ell=1}^{L^*} B_\ell^{L^*}(t)\underline{\mu}_\ell^{L^*} = \sum_{\ell = L+1}^{L^*} B_\ell^{L^*}(t)\underline{\mu}_\ell^{L^*}.\]</span></p>
<p>From <a href="#prp-error" class="quarto-xref">Proposition&nbsp;3</a>, we can directly deduce the following proposition:</p>
<div id="prp-bias" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 4</strong></span> Under Assumption 1 and Assumption 3, the bias is, for all <span class="math inline">\(t\in [0,1]\)</span>,</p>
<ul>
<li>for <span class="math inline">\(L&lt;L^*\)</span>, <span class="math inline">\(Bias_{L,L^*}(t)\neq 0\)</span>,</li>
<li>for <span class="math inline">\(L\geq L^*\)</span>, <span class="math inline">\(Bias_{L,L^*}(t) = 0\)</span>.</li>
</ul>
</div>
<p>In the next section, we explain how we use this property to derive confidence bands of <span class="math inline">\(\underline{f}^{L, L^*}\)</span> and <span class="math inline">\(f^{L, L^*}\)</span>.</p>
</section>
</section>
</section>
<section id="sec-bandSun" class="level1">
<h1>Confidence Bands of <span class="math inline">\(\underline{f}^{L, L^*}\)</span> and <span class="math inline">\(f^{L, L^*}\)</span> for a fixed <span class="math inline">\(L\)</span></h1>
<p>The objective is to construct a confidence band for the two functions <span class="math inline">\(\underline{f}^{L, L^*}\)</span> and <span class="math inline">\(f^{L, L^*}\)</span>, based on the observations <span class="math inline">\(\mathbf{y}\)</span>, for a given value <span class="math inline">\(L\in \{L_{\min}, \ldots, L_{\max}\}\)</span>. The band for <span class="math inline">\(\underline{f}^{L, L^*}\)</span> enters the framework proposed by <span class="citation" data-cites="sun1994">@sun1994</span> which relies on an unbiased and linear estimator of the function<!--. This is the case for !--> <span style="color: red;">as</span> the estimator <span class="math inline">\(\underline{\hat f}^{L, L^*}\)</span> <!--which!--> is an unbiased estimator of <span class="math inline">\(\underline{f}^{L, L^*}\)</span>. We recall in <a href="#sec-bandSun2" class="quarto-xref">Section&nbsp;3.1</a> the construction of this confidence band which attains a given confidence level in a non-asymptotic setting, that is for a finite number of observations <span class="math inline">\(n\)</span> for each individual. Then in <a href="#sec-bandfLLstar" class="quarto-xref">Section&nbsp;3.2</a>, we prove that the confidence band proposed by <span class="citation" data-cites="sun1994">@sun1994</span> can be viewed as a confidence band for <span class="math inline">\(f^{L, L^*}\)</span> with an asymptotic confidence level, the asymptotic framework being considered when <span class="math inline">\(n\rightarrow\infty\)</span>.</p>
<section id="sec-bandSun2" class="level2">
<h2 class="anchored" data-anchor-id="sec-bandSun2">Confidence band for <span class="math inline">\(\underline{f}^{L,L^*}\)</span></h2>
<!-- Let $L\in \{L_{\min}, \ldots, L_{\max}\}$. !-->
<p>Consider <span class="math inline">\(1-\alpha\)</span> <!--as!--> a fixed confidence level. The aim is to find a function <span class="math inline">\(d^L()\)</span> such that <span class="math display">\[\mathbb{P}\left( \forall t \in [0,1],\; \underline{\hat{f}_{}}^{L,L^*}(t) -d^L(t)\leq \underline{f}^{L,L^*}(t)\leq \underline{\hat{f}_{}}^{L,L^*}(t) +d^L(t)\right) = 1-\alpha.\]</span> Consider the normalized statistics <span class="math inline">\(Z_L(t)\)</span> which is a centered and reduced Gaussian process. We want to find the quantile <span class="math inline">\(q^L\)</span> satisfying</p>
<p><span id="eq-qL"><span class="math display">\[q^L =\arg\min_{q} \left\{ \mathbb{P}\left(\max_{t \in [0,1]} \left|Z_L(t)\right| \leq q \right) = 1 - \alpha\right\}. \tag{3}\]</span></span></p>
<p>Then we can take <span class="math inline">\(d^L(t) = q^L \sqrt{C^{L, L^*}(t,t)}\)</span>. The covariance function <span class="math inline">\(C^{L, L^*}(t,t)\)</span> can be replaced by its estimator <span class="math inline">\(\hat{C}^{L,L^*}(t,t)\)</span>, making the distribution a Student‚Äôs distribution with <span class="math inline">\(N-1\)</span> degrees of freedom. Thus, it only requires to be able to compute the critical value <span class="math inline">\(q^L\)</span>.</p>
<p>This can be done following <span class="citation" data-cites="sun1994">@sun1994</span> who propose a confidence band for a centered Gaussian process. Their procedure is based on an unbiased linear estimator of the function of interest, which is the case for <span class="math inline">\(\underline{\hat{f}_{}}^{L,L^*}\)</span> when we consider a band for <span class="math inline">\(\underline{f}^{L,L^*}\)</span>. We recall their result in the following proposition, the computation of the value <span class="math inline">\(q^L\)</span> is detailed thereafter.</p>
<div id="thm-sunLoader" class="theorem">
<p><span class="theorem-title"><strong>Theorem 1 (<span class="citation" data-cites="sun1994">@sun1994</span>)</strong></span> Set Assumption 1 and Assumption 3 and a probability <span class="math inline">\(\alpha\in [0,1]\)</span>. Then, we have <span class="math display">\[\mathbb{P}\left(\forall t \in [0,1], \left|\underline{\hat{f}}^{L, L^*}(t)-\underline{f}^{L,L^*}(t)\right| \leq \hat d^L(t)\right) = 1- \alpha\]</span> with <span class="math display">\[\begin{align*}
\hat d^L(t) = \hat q^L \sqrt{\hat C^{L,L^*}(t,t)/N}
\end{align*}\]</span> and <span class="math inline">\(\hat q^L\)</span> defined as the solution of the following equation, seen as a function of <span class="math inline">\(q^L\)</span>: <span id="eq-cL"><span class="math display">\[
\alpha = \mathbb{P}\left(|t_{N-1}|&gt;q^L\right) +\frac{\| \tau^L\|_1}{\pi}\left( 1+\frac{(q^L)^2}{N-1}\right)^{-(N-1)/2} ,
\tag{4}\]</span></span> with <span class="math inline">\((\tau^L)^2(t)= \partial_{12} c(t,t) = Var(Z_L(t))'\)</span> where we denote <span class="math inline">\(\partial_{12}c(t,t)\)</span> the partial derivatives of a function <span class="math inline">\(c(t,s)\)</span> in the first and second coordinates and then evaluated at <span class="math inline">\(t=s\)</span>.</p>
</div>
<p>We can thus deduce a confidence band of level <span class="math inline">\(1-\alpha\)</span> for <span class="math inline">\(\underline{f}^{L,L^*}\)</span>: <span class="math display">\[\begin{align*}
CB_1(\underline{f}^{L,L^*})&amp; = \left\{ \forall t\in [0,1], \left [\underline{\hat{f}}^{L, L^*}(t) -\hat d^L(t) ; \underline{\hat{f}}^{L, L^*}(t) +\hat d^L(t) \right ]\right\}.
\end{align*}\]</span></p>
<p>The value <span class="math inline">\(\hat q^L\)</span> is defined implicitly in <a href="#eq-cL" class="quarto-xref">Equation&nbsp;4</a> which involves the unknown and not explicit quantity <span class="math inline">\(t\mapsto \tau^L(t)\)</span>. <span class="citation" data-cites="Liebl2019">@Liebl2019</span> propose to estimate <span class="math inline">\(\tau^L(t)\)</span>, for all <span class="math inline">\(t\)</span>, by <span class="math display">\[\begin{align*}
\hat \tau^L(t) &amp;= \left(\widehat{Var}(({U}^{L})'_{1}(t), \ldots, ({U}^{L})'_{N}(t)\right)^{1/2}\\
&amp;= \left(\frac{1}{N-1}\sum_{i=1}^N\left(({U}^{L})'_{i}(t)-\frac1N\sum_{j=1}^N({U}^{L})'_{j}(t)\right)^2\right)^{1/2},
\end{align*}\]</span> where <span class="math inline">\({U}^L_{i}(t) = (P^L y_{i.}(t)-\underline{\hat{f}}^{L, L^*}(t))/(\hat C^{L,L^*}(t))^{1/2}\)</span> and <span class="math inline">\(({U}^{L})'_{i}\)</span> is a smooth version of the differentiated function <span class="math inline">\({U}^L_{i}\)</span>. Then we take the <span class="math inline">\(L_1\)</span>-norm of <span class="math inline">\(\hat \tau^L\)</span>.</p>
<p>Let us describe the behavior of <span class="math inline">\(\hat d^L\)</span>:</p>
<ul>
<li><span class="math inline">\(\|\hat d^L\|_\infty\)</span> increases with <span class="math inline">\(L\)</span>.</li>
<li>When the functions <span class="math inline">\((B_\ell^L)_{1\leq \ell \leq L}\)</span> <!--consists in!--> <span style="color: red;">form</span> an orthonormal family, <span class="math inline">\(\|\hat d^L\|_\infty\)</span> increases with <span class="math inline">\(L\)</span> until <span class="math inline">\(L=L^*\)</span> and then <span class="math inline">\(\|\hat d^L\|_\infty\)</span> is constant with <span class="math inline">\(L\)</span>.</li>
</ul>
<p><span style="color: red;"> Their behavior will be illustrated with different function families in</span> <a href="#sec-simulation" class="quarto-xref">Section&nbsp;6</a>.</p>
</section>
<section id="sec-bandfLLstar" class="level2">
<h2 class="anchored" data-anchor-id="sec-bandfLLstar">Asymptotic confidence band for <span class="math inline">\(f^{L,L^*}\)</span></h2>
<p>Note that <!-- if one works !--> in the asymptotic framework <span class="math inline">\(n\rightarrow\infty\)</span>, the previous definition of <span class="math inline">\(\hat d^L\)</span> induces a natural asymptotic confidence band for the function <span class="math inline">\(f^{L,L^*}\)</span>. Indeed, we can prove that</p>
<div id="thm-CB_Liebl_asymptotic" class="theorem">
<p><span class="theorem-title"><strong>Theorem 2</strong></span> Set Assumption 1 and Assumption 3 and a probability <span class="math inline">\(\alpha\in [0,1]\)</span>. Then, we have, <span class="math display">\[\lim_{n \rightarrow +\infty} \mathbb{P}\left(\forall t \in [0,1], |\underline{\hat{f}}^{L, L^*}(t)-f^{L,L^*}(t)| \leq \hat d^L(t)\right) = 1-\alpha,\]</span> with <span class="math inline">\(\hat d^L(t) = \hat q^L \sqrt{\hat C^{L,L^*}(t,t)/N}\)</span> and <span class="math inline">\(\hat q^L\)</span> is defined as the solution of <a href="#eq-cL" class="quarto-xref">Equation&nbsp;4</a>.</p>
</div>
<p>The proof is given in Appendix.</p>
<p>Then a confidence band for <span class="math inline">\(f^{L,L^*}\)</span> at the asymptotic confidence level <span class="math inline">\(1-\alpha\)</span> for a large number of observations <span class="math inline">\(n\)</span> is given by <span class="math display">\[\begin{align*}
CB(f^{L,L^*})&amp; = \left\{ \forall t\in [0,1], \left[\underline{\hat{f}}^{L, L^*}(t) -\hat d^L(t) ; \underline{\hat{f}}^{L, L^*}(t) +\hat d^L(t) \right]\right\}.
\end{align*}\]</span></p>
<!-- We do not provide any illustration of this property, as it would be similar than the previous ones. Indeed, we notice that the asymptotic is achieved even when $n$ is small on our examples. !-->
</section>
</section>
<section id="sec-band2" class="level1">
<h1>Confidence Band of <span class="math inline">\(f^{L^*}\)</span> by correcting the bias</h1>
<p>The function of interest is <span class="math inline">\(f^{L^*}=\underline{f}^{L^*, L^*}\)</span>, rather than <span class="math inline">\(\underline{f}^{L,L^*}\)</span>. Therefore, our objective is to construct a confidence <span style="color: red;">band</span> for <span class="math inline">\(f^{L^*}\)</span>. However, an unbiased estimator of <span class="math inline">\(f^{L^*}\)</span> is <span style="color: red;">not</span> <!--un!-->available by definition, since the true dimension <span class="math inline">\(L^*\)</span> is unknown. <!--Instead, we propose!--> <span style="color: red;">We propose instead</span> to work with the estimator <span class="math inline">\(\underline{\hat f}^{L,L^*}\)</span> and to debias the corresponding confidence band.</p>
<p>To <span style="color: red;">do</span> <!--achieve!--> this, we use the decomposition <!--outlined in @eq-decomposition!--> between the bias term and the statistical term, <span style="color: red;">outlined in</span> <a href="#eq-decomposition" class="quarto-xref">Equation&nbsp;2</a>. The idea is to bound the infinit<span style="color: red;">e</span> norm of these two terms. A first strategy <span style="color: red;">is to bound</span> <!--consists in bounding!--> each term separately, <!-- and!--> then <span style="color: red;">add</span> <!--summing!--> the two bounds to construct the confidence band. However, this approach tends to produce a band that is too large and <span style="color: red;">too</span> conservative. <span style="color: red;">This is because</span> <!--The reason is that!--> applying the infinite norm <span style="color: red;">to</span> <!--on!--> each term before bounding them does not take into account the functional nature of the two terms.</p>
<p>A second strategy <span style="color: red;">is to retain</span> <!--consists in keeping!--> the functional aspect by bounding the infinity norm of the sum of the <!--functional!--> two <span style="color: red;">functional</span> terms. This approach is detailed in this section. In <a href="#sec-construction2" class="quarto-xref">Section&nbsp;4.1</a>, we first rewrite the band as a band around <span class="math inline">\(\underline{f}^{L,L^*}(t)\)</span>. <span style="color: red;">We need to estimate the band bound and the bias. To do this, we divide the sample into two sub-samples. This choice is not ideal because it increases the variability of the estimators. But at least, it provides independence between the estimators of the two quantities, which makes it possible to establish the theoretical coverage of the final band. More precisely </span> we use a first subsample <span class="math inline">\(\mathbf{y}^1\)</span> to estimate the bound <!--as!--> defined in <a href="#sec-bandSun" class="quarto-xref">Section&nbsp;3</a>. A second subsample <span class="math inline">\(\mathbf{y}^2\)</span> is used to estimate the bias term (without the infinite norm). This <span style="color: red;">results in</span> <!--yields!--> a pointwise correction of the bias, and the final confidence band is centered around <span class="math inline">\(\underline{\hat{f}}^{L_{\max},L^*}\)</span>. This procedure provides a collection of confidence bands, for <span class="math inline">\(L\in \{L_{\min}, \ldots, L_{\max}\}\)</span> with <span style="color: red;">variable</span> <!--varying!--> width. Then, in <a href="#sec-SelectionL2" class="quarto-xref">Section&nbsp;4.2</a>, we propose a criterion to select the ‚Äúbest‚Äù band by minimizing its width. <span style="color: red;"> We discuss the band thus obtained at the end of the section and its limits. </span></p>
<section id="sec-construction2" class="level2">
<h2 class="anchored" data-anchor-id="sec-construction2">Construction of the band of <span class="math inline">\(f^{L^*}\)</span> for a given <span class="math inline">\(L\)</span></h2>
<p>We introduce two independent sub-samples <span class="math inline">\(\mathbf{y}^1\)</span> and <span class="math inline">\(\mathbf{y}^2\)</span> of <span class="math inline">\(\mathbf{y}\)</span> of length <span class="math inline">\(N_1\)</span> and <span class="math inline">\(N_2\)</span> such that <span class="math inline">\(N_1+N_2=N\)</span>.</p>
<p>We use the first sub-sample <span class="math inline">\(\mathbf{y}^1\)</span> to calculate <span class="math inline">\(\underline{\hat{f}_1}^{L,L^*}(t)\)</span>, an estimator of <span class="math inline">\(\underline{f}^{L,L^*}(t)\)</span> and a functional bound denoted <span class="math inline">\(\hat d_1^L\)</span> that controls the bias term <span class="math inline">\(\underline{f}^{L,L^*}(t)-\underline{\hat{f}_1}^{L,L^*}(t)\)</span>. This bound is defined in <a href="#sec-bandSun" class="quarto-xref">Section&nbsp;3</a> applied on <span class="math inline">\(\mathbf{y}^1\)</span>, for a given level <span class="math inline">\(\alpha\)</span>, such that:</p>
<p><span id="eq-def-dL1"><span class="math display">\[
\mathbb{P}\left(\forall t\in[0,1], -\hat d_1^L(t) \leq \underline{f}^{L,L^*}(t) - \underline{\hat{f}}_1^{L,L^*}(t) \leq \hat d_1^L(t)\right) = 1-\alpha.
\tag{5}\]</span></span></p>
<p><span style="color: red;">Next,</span> <!--Then,!--> we need to control the bias <span class="math inline">\(Bias_{L,L^*}(t) = \underline{f}^{L,L^*}(t)-f^{L^*}(t)\)</span>. Recall tha<span style="color: red;">t</span> <!--n!--> when <span class="math inline">\(L_{\max}\)</span> is <span style="color: red;">sufficiently</span> large <!--enough!--> and <span class="math inline">\(n&gt; L_{\max}\)</span>, <span style="color: red;">we have</span> <span class="math inline">\(f^{L^*} = \underline{f}^{L_{\max},L^*}\)</span>. <span style="color: red;">We therefore need</span> <!--Therefore, we want!--> to control the <span class="math inline">\(Bias_{L,L^*}(t) = \underline{f}^{L,L^*}(t) - \underline{f}^{L_{\max},L^*}(t)\)</span>. It would be tempting to replace <span class="math inline">\(Bias_{L,L^*}(t)\)</span> by its estimation based on the second sample <span class="math inline">\(\mathbf{y}^2\)</span>. But this would introduce an estimation error that we also need to control, in the same spirit <span style="color: red;">as</span> <!--than!--> what is done in <span class="citation" data-cites="Pascal2017">@Pascal2017</span>. We can <span style="color: red;">again</span> use <!--again!--> <a href="#sec-bandSun" class="quarto-xref">Section&nbsp;3</a> to compute the function <span class="math inline">\(\hat d_2^{L,L_{\max}}(t)\)</span> on the sample <span class="math inline">\(\mathbf{y}^2\)</span>, and the functional estimators <span class="math inline">\(\underline{\hat{f}}_2^{L,L^*}(t)\)</span> and <span class="math inline">\(\underline{\hat f}_2^{L_{\max}, L^*}(t)\)</span> of <span class="math inline">\(\underline{f}^{L,L^*}(t)\)</span> and <span class="math inline">\(\underline{ f}^{L_{\max}, L^*}(t)\)</span>, respectively. This allows <span style="color: red;">us</span> to construct the following band for <span class="math inline">\(\underline{f}^{L,L^*}(t) - \underline{f}^{L_{\max},L^*}\)</span> for a confidence level <span class="math inline">\(1-\beta\)</span>,</p>
<p><span id="eq-def-dL2"><span class="math display">\[
\mathbb{P}\left(\forall t\in[0,1], - \hat d_2^{L,L_{\max}}(t) \leq \underline{ f}^{L_{\max}, L^*}(t)- \underline{ f}^{L, L^*}(t) - (\underline{\hat f}_2^{L_{\max}, L^*}(t)-\underline{\hat f}_2^{L, L^*}(t)) \leq \hat d_2^{L,L_{\max}}(t)\right) = 1-\beta.
\tag{6}\]</span></span></p>
<p>Combining <a href="#eq-def-dL1" class="quarto-xref">Equation&nbsp;5</a> and <a href="#eq-def-dL2" class="quarto-xref">Equation&nbsp;6</a>, we can provide a debiased confidence band of <span class="math inline">\(f^{L^*}(t)\)</span>.</p>
<div id="prp-CBf" class="theorem proposition">
<p><span class="theorem-title"><strong>Proposition 5</strong></span> Let us define <span class="math display">\[\begin{align*}
\hat\theta_1^L(t) &amp;:= -\hat d_1^L(t) - \hat d_2^{L,L_{\max}}(t) +\underline{\hat f}_2^{L_{\max}, L^*}(t)-\underline{\hat f}_2^{L, L^*}(t) \\
\hat\theta_2^L(t)&amp;:= \hat d_1^L(t) + \hat d_2^{L,L_{\max}}(t) +\underline{\hat f}_2^{L_{\max}, L^*}(t) - \underline{\hat f}_2^{L, L^*}(t),
\end{align*}\]</span> where <span class="math inline">\(\hat d_1^L(t)\)</span> is defined on sample <span class="math inline">\(\mathbf{y}^1\)</span> by <a href="#eq-def-dL1" class="quarto-xref">Equation&nbsp;5</a> for a level <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\hat d_2^{L,L_{\max}}(t)\)</span> is defined on sample <span class="math inline">\(\mathbf{y}^2\)</span> by <a href="#eq-def-dL2" class="quarto-xref">Equation&nbsp;6</a> for a level <span class="math inline">\(\beta\)</span>. Then we have <span class="math display">\[\begin{align*}
\mathbb{P}\left(\forall t \in [0,1], \quad \hat \theta_1^L(t) \leq f^{L^*}(t)- \underline{\hat f}_1^{L, L^*}(t)\leq \hat\theta_2^L(t)\right)\geq 1-\alpha\beta.
\end{align*}\]</span></p>
</div>
<p>The proof is given in Appendix.</p>
<p>This defines a confidence band which can be defined either around <span class="math inline">\(\underline{\hat{f}_{1}}^{L,L^*}\)</span>: <span class="math display">\[\begin{align*}
CB_2(\underline{f}^{L^*})=\left\{\forall t\in[0,1], \left[\underline{\hat{f}_1}^{ L, L^*}(t) + \hat\theta_1^{ L}(t) \, ;\, \underline{\hat{f}_1}^{ L, L^*}(t) + \hat\theta_2^{ L}(t) \right] \right\}
\end{align*}\]</span> or around <span class="math inline">\(\underline{\hat f}_2^{ L_{\max}, L^*}\)</span>: <span class="math display">\[\begin{align*}
CB_2(\underline{f}^{L^*})=\left\{\forall t\in[0,1], \left[\underline{\hat f_2}^{ L_{\max}, L^*}(t) + \bar \theta_1^L(t) \, ; \, \underline{\hat f_2}^{ L_{\max}, L^*}(t) +\bar \theta_2^L(t) \right]\right\}.
\end{align*}\]</span></p>
<p>with <span class="math inline">\(\bar \theta_1^L(t) = \underline{\hat{f}_{1}}^{L,L^*}(t)-\underline{\hat f_2}^{ L, L^*}(t) -\hat d_1^L(t) - \hat d_2^{L,L_{\max}}(t)\)</span> and <span class="math inline">\(\bar \theta_2^L(t) = \underline{\hat{f}_{1}}^{L,L^*}(t)-\underline{\hat f_2}^{ L, L^*}(t) + \hat d_1^L(t) + \hat d_2^{L,L_{\max}}(t)\)</span>.</p>
<div id="rem-dLLmax" class="proof remark">
<p><span class="proof-title"><em>Remark 1</em>. </span>The two functions <span class="math inline">\(\hat d_1^L(t)\)</span> and <span class="math inline">\(\hat d_2^{L,L_{\max}}(t)\)</span> are of the same order <span style="color: red;">because</span> <!--as!--> they are <span style="color: red;">constructed using</span> <!--built with!--> the same approach. They depend on the length of the samples. To obtain the thinnest band, the best strategy is to <span style="color: red;">divide</span> <!--split!--> the sample in two sub-samples of equal length <span style="color: red;"><span class="math inline">\(N_1=N_2=N/2\)</span>.</span> <!--$n_1=n_2= n/2$. !--></p>
</div>
<p>The behavior of <span class="math inline">\(\hat d_1^L\)</span> <span style="color: red;">was</span> <!--has been!--> described in <a href="#sec-bandSun" class="quarto-xref">Section&nbsp;3</a>. Let us describe the behavior of <span class="math inline">\(\hat d_2^{L,L_{\max}}\)</span>:</p>
<ul>
<li><span class="math inline">\(\|\hat d_2^{L,L_{\max}}\|_\infty\)</span> decreases with <span class="math inline">\(L\)</span>.</li>
<li>When <span class="math inline">\(L&gt;L^\varepsilon\)</span>, <span class="math inline">\(\|\hat d_2^{L,L_{\max}}\|_\infty\)</span> is constant with <span class="math inline">\(L\)</span> and the probability in <a href="#eq-def-dL2" class="quarto-xref">Equation&nbsp;6</a> is equal to <span class="math inline">\(1\)</span>.</li>
<li>When <span class="math inline">\(L^{*}&lt;L&lt;L^\varepsilon\)</span>, <span class="math inline">\(\|\hat d_2^{L,L_{\max}}\|_\infty\)</span> is constant with <span class="math inline">\(L\)</span> when the functions <span class="math inline">\(B_\ell^L\)</span> <span style="color: red;">form</span> <!--consists in!--> an orthonormal family. Otherwise, the behavior is erratic.</li>
</ul>
<!--It!-->
<p><span style="color: red;">This</span> means that when the band defined in <a href="#prp-CBf" class="quarto-xref">Proposition&nbsp;5</a> is calculated for <span class="math inline">\(L&gt;L^\varepsilon\)</span>, the confidence level is <span class="math inline">\(1-\alpha\)</span> instead of <span class="math inline">\(1-\alpha\beta\)</span>.</p>
<p>The advantage<!--s!--> of this approach is that the <span style="color: red;">band</span> bias <!--of the band!--> is corrected and the level for the true function <span class="math inline">\(f^{L^*}\)</span> is guaranteed when <span class="math inline">\(L^\varepsilon\)</span> is large. This was the main <span style="color: red;">aim</span> <!--objective!--> of the paper. <span style="color: red;">The main limit of this approach is that the band is constructed with samples with half sizes, leading to less precision. This will be illustrated in </span> <a href="#sec-simulation" class="quarto-xref">Section&nbsp;6</a>. <span style="color: red;">Nevertheless, this method gives finer confidence bands than cross-validation, and with the right level of confidence. </span></p>
<p><span style="color: red;">A natural question is then the choice of the dimension <span class="math inline">\(L\)</span>. This is the purpose of the next section. </span></p>
</section>
<section id="sec-SelectionL2" class="level2">
<h2 class="anchored" data-anchor-id="sec-SelectionL2">Influence of <span class="math inline">\(L\)</span></h2>
<p>This approach <span style="color: red;">produces</span> <!--gives!--> a collection of <span style="color: red;">debiased</span> confidence bands for different values of <span class="math inline">\(L\)</span>. The confidence bands have different widths but a same confidence level <span class="math inline">\(1-\alpha\beta\)</span>. It is <span style="color: red;">therefore</span> <!--thus!--> natural to want to select one of them. This means <span style="color: red;">that</span> we want to select the best dimension <span class="math inline">\(L\)</span> among the collection <span class="math inline">\(\{L_{\min}, \ldots, L_{\max}\}\)</span>. We need to define what ‚Äúbest‚Äù means. It is quite intuitive to <span style="color: red;">want</span> <!--focus!--> on the <span style="color: red;">finest</span> band, <span style="color: red;">fine in the sense of a certain norm</span>. <!-- that is the thinnest. Thinnest could be thought in different norms.!--> Here we consider the infinite norm of the width of the confidence band. <span style="color: red;">This</span> <!--which!--> gives <!--a!--> preference to smooth bands. We <span style="color: red;">therefore</span> <!--thus!--> define the following criteria <span style="color: red;">of selection of <span class="math inline">\(L\)</span></span></p>
<p><span id="eq-def-Lhat"><span class="math display">\[
\hat L = \arg\min_L \left\{\sup_{t} |\hat\theta_2^L(t)-\hat\theta_1^L(t)|\right\} = \arg\min_L \left\{\sup_t | \hat d^L(t) + \hat d^{L,L_{\max}}(t)|\right\}.
\tag{7}\]</span></span></p>
<p><span style="color: red;">This global approach guarantees that each band of the collection is debiased and then the dimension is selected. It will be illustrated in </span> <a href="#sec-simulation" class="quarto-xref">Section&nbsp;6</a>.</p>
<p><span style="color: red;">In the next section, instead of debiasing each band, we employ another strategy focusing on the construction of a selection criteria that will guarantee that the bias is negligible.</span></p>
</section>
</section>
<section id="sec-modsel" class="level1">
<h1>Selection of the best confidence band with a criteria taking into account the bias</h1>
<p>In this section, we want to use the collection of confidence bands defined in <a href="#sec-bandSun" class="quarto-xref">Section&nbsp;3</a> without correcting their bias, but <!--instead!--> by proposing a selection criterion that is a trade-off between this bias and the dimension of the basis. To do this, we propose a new heuristic criterion <span style="color: red;">linked</span> <!--going back!--> to the definition of the band itself, <span style="color: red;">considering the estimation of the band</span> <!--seen!--> as the estimation of a quantile of a certain empirical process. The criterion is inspired by model selection tools <span style="color: red;">for choosing</span> <!--to select!--> the best dimension <span class="math inline">\(L\)</span>. In the following, we assume that <span class="math inline">\(L_{\max}\)</span> is large enough such that <span class="math inline">\(\underline f^{L_{\max},L^*}=f^{L^*}\)</span>.</p>
<p>We work on the quantile <span class="math inline">\(q^L\)</span> introduced in <a href="#eq-qL" class="quarto-xref">Equation&nbsp;3</a>, its oracle version <span class="math inline">\(q^{L^*}\)</span> for <!--the!--> level <span class="math inline">\(L^*\)</span> and <span style="color: red;">its</span> <!--the!--> estimate <span class="math inline">\(\hat q^L\)</span>. All <span style="color: red;">are scalars, belonging to a collection indexed by</span> <!--of them are scalar, in a collection of scalars, with!--> <span class="math inline">\(L=L_{\min}, \ldots, L_{\max}\)</span>. A natural criterion <span style="color: red;">for choosing</span> <!--to choose!--> the best <span class="math inline">\(L\)</span> is <!--such!--> that the estimator <span class="math inline">\(\hat q^L\)</span> minimizes the quadratic error <span class="math inline">\(\mathbb{E}\left( \|q^{L^*}-\hat q^L\|^2\right)\)</span>. However, this quadratic error is unknown as <span class="math inline">\(q^{L^*}\)</span> is unknown. We can not <!--directly!--> use it <span style="color: red;">directly</span>.</p>
<p>Instead, we study <span class="math inline">\(\|\hat{q}^{L_{\max}}-\hat q^L\|^2\)</span>. While the theoretical quadratic error <span class="math inline">\(\mathbb{E}\left( \|q^{L^*}-\hat q^L\|^2\right)\)</span> decreases when <span class="math inline">\(L&lt;L^*\)</span> and increases when <span class="math inline">\(L&gt;L^*\)</span>, the <span class="math inline">\(\|\hat{q}^{L_{\max}}-\hat q^L\|^2\)</span> approximation to this error <span style="color: red;">always decreases</span> <!--is still decreasing!--> when <span class="math inline">\(L&gt;L^*\)</span>, as illustrated in <a href="#sec-simulation" class="quarto-xref">Section&nbsp;6</a>.</p>
<p>We <span style="color: red;">see</span> <!--recognize!--> a behavior similar to a bias, high when <span style="color: red;">the</span> dimension is small, and small when <span style="color: red;">the</span> dimension is large. Selecting a dimension using this criterion will always overfit the data. <span style="color: red;">We therefore</span> <!--Thus, we!--> propose to penalize this quantity by the dimension <span class="math inline">\(L\)</span> divided by the sample size <span class="math inline">\(N\)</span>, as usual in model selection criterion. <span style="color: red;">To do this</span> <!--For that,!--> we introduce a regularisation parameter <span class="math inline">\(\lambda&gt;0\)</span> which balances the two terms. A natural criteria to select the best <span class="math inline">\(L\)</span> is then <span class="math display">\[\widetilde{crit}(L) = \|\hat q^{L_{\max}}-\hat q^L\|^2 +\lambda \frac{L}{N}.\]</span></p>
<p>Then we define <span class="math display">\[\tilde L = \arg\min_L \widetilde{crit}(L),\]</span> and take the band centered around <span class="math inline">\(\underline{\hat{f}}^{\tilde L, L^*}\)</span>: <span class="math display">\[CB_3(\underline{f} ^{L^*}) = CB_1(\underline{f}^{\tilde L, L^*})\]</span></p>
<p><span style="color: red;"> This criterion is illustrated in</span> <a href="#sec-simumodsel" class="quarto-xref">Section&nbsp;6.4</a>. <span style="color: red;"> We also compare with two other standard approaches, heuristic as well, namely the cross-validation approach used to select the dimension <span class="math inline">\(L\)</span> which minimizes the reconstruction error, and a thresholding method which keeps the higher dimension <span class="math inline">\(L\)</span> with large enough coefficients. These two methods are less oriented to the objective of controling the level of the selected confidence band.</span></p>
</section>
<section id="sec-simulation" class="level1">
<h1><span style="color: red;"> Simulation study</span></h1>
<p>In this section, we illustrate the different statements provided along the paper on generated data. First, in <a href="#sec-dgp" class="quarto-xref">Section&nbsp;6.1</a>, we describe the generating data process and illustrate the linear estimator considered in this paper. In <a href="#sec-simu-band" class="quarto-xref">Section&nbsp;6.2</a>, we illustrate the first confidence band, for a fixed level, as introduced in <a href="#sec-bandSun" class="quarto-xref">Section&nbsp;3</a>. Then, we illustrate the debiased confidence band in <a href="#sec-simudebias" class="quarto-xref">Section&nbsp;6.3</a>, and discuss the model selection criterion in <a href="#sec-simumodsel" class="quarto-xref">Section&nbsp;6.4</a>. We finally study the generalization of the method out of the class of models in <a href="#sec-gen" class="quarto-xref">Section&nbsp;6.5</a>.</p>
<section id="sec-dgp" class="level2">
<h2 class="anchored" data-anchor-id="sec-dgp">Generating data process</h2>
<p>To illustrate the model, we simulate a regression functional model with <span class="math inline">\(n=50\)</span> points per individual and <span class="math inline">\(N=40\)</span> individuals. In <a href="#fig-BasisModel" class="quarto-xref">Figure&nbsp;1</a>, the function <span class="math inline">\(f\)</span> (red curve) belongs to the Fourier (resp. Legendre and Spline) family with <span class="math inline">\(L^*=11\)</span> and the noisy observations <span class="math inline">\(y_{ij}\)</span> (black curves) have a functional noise in dimension <span class="math inline">\(L^{\varepsilon}=20\)</span>, also in the Fourier (resp. Legendre and Spline) family on the left plot (resp. middle and right).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fda)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(orthopolynom)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(wavelets)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(basefun)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fields)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>func.basis <span class="ot">=</span> <span class="cf">function</span>(time, L, basis){</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (basis <span class="sc">==</span> <span class="st">'Splines'</span>){</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    B <span class="ot">=</span> <span class="fu">bsplineS</span>(time,<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="fu">min</span>(time), <span class="fu">max</span>(time), <span class="at">length.out =</span> L<span class="dv">-1</span>), <span class="at">norder =</span> <span class="dv">3</span>, <span class="dv">0</span>) </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (basis <span class="sc">==</span> <span class="st">'Fourier'</span>){</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    B <span class="ot">=</span> <span class="fu">fourier</span>(time,<span class="at">nbasis =</span> L) </span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (basis <span class="sc">==</span> <span class="st">'Legendre'</span>){</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    B <span class="ot">=</span> <span class="fu">Legendre_basis</span>(<span class="fu">numeric_var</span>(<span class="st">"x"</span>, <span class="at">support =</span> <span class="fu">c</span>(<span class="fu">min</span>(time), <span class="fu">max</span>(time))), </span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>                       <span class="at">order =</span> L<span class="dv">-1</span>)(time)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(B)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>dgp <span class="ot">=</span> <span class="cf">function</span>(<span class="at">n=</span><span class="dv">50</span>,<span class="at">N=</span><span class="dv">40</span>,<span class="at">sd=</span><span class="dv">1</span>,<span class="at">L.star=</span><span class="dv">11</span>, <span class="at">L.eps =</span> <span class="dv">20</span>, <span class="at">alpha.mu =</span> <span class="cn">NULL</span>, <span class="at">basis =</span> <span class="st">'Fourier'</span>, <span class="at">f.true =</span> <span class="cn">NULL</span>){ </span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="do">### n: number of timepoints</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="do">### N: number of individuals</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  <span class="do">### sd: noise level (standard deviation)</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  <span class="do">### L: number of functional basis for the signal</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  <span class="do">### L.eps: number of functional basis for the noise</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  <span class="do">### alpha.mu: vector of coefficients</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  <span class="do">### basis: functional basis, to be chosen in 'Legendre', 'Fourier', 'Splines'</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  <span class="do">### f.true: if one wants to fix the true function</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> n)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (basis <span class="sc">==</span> <span class="st">'Fourier'</span>){</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (L.star<span class="sc">%%</span><span class="dv">2</span> <span class="sc">==</span> <span class="dv">0</span>){ L.star <span class="ot">=</span> L.star<span class="sc">+</span><span class="dv">1</span>}</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (L.eps<span class="sc">%%</span><span class="dv">2</span> <span class="sc">==</span> <span class="dv">0</span>){ L.eps <span class="ot">=</span> L.eps<span class="sc">+</span><span class="dv">1</span>}</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(f.true)){</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    <span class="do">### Create the functional basis </span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    B <span class="ot">=</span> <span class="fu">func.basis</span>(time, L.star, basis)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    <span class="do">### Generate randomly coefficients, if needed</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(alpha.mu)){</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>      alpha.mu <span class="ot">=</span> <span class="fu">sample</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span><span class="sc">:-</span><span class="dv">2</span>, <span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>),<span class="at">size=</span>L.star,<span class="at">replace=</span><span class="cn">TRUE</span>)} </span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (basis <span class="sc">==</span> <span class="st">'Fourier'</span>){</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>      alpha.mu <span class="ot">=</span> alpha.mu <span class="sc">/</span> <span class="dv">3</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>      sd <span class="ot">=</span> sd<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>,<span class="at">nrow =</span> N, <span class="at">ncol =</span> n)</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    f.true <span class="ot">=</span> B <span class="sc">%*%</span> alpha.mu</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>  B.eps <span class="ot">=</span> <span class="fu">func.basis</span>(time, L.eps, basis)</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>,<span class="at">nrow =</span> N, <span class="at">ncol =</span> n)</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>    y[i,] <span class="ot">=</span> f.true <span class="sc">+</span> B.eps <span class="sc">%*%</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(L.eps, <span class="dv">0</span>, sd))</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">y =</span> <span class="fu">t</span>(y), <span class="at">alpha.mu =</span> alpha.mu, <span class="at">time =</span> time, <span class="at">L.star=</span>L.star, <span class="at">f.true =</span> f.true))</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>n<span class="ot">=</span><span class="dv">50</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>N<span class="ot">=</span><span class="dv">40</span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>sd<span class="ot">=</span><span class="dv">1</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>L.star<span class="ot">=</span><span class="dv">11</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>L.eps <span class="ot">=</span> <span class="dv">20</span></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>alpha.mu <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>basis <span class="ot">=</span> <span class="st">"Legendre"</span></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">dgp</span>(<span class="at">n=</span>n,<span class="at">N=</span>N,<span class="at">sd=</span>sd,<span class="at">L.star=</span>L.star, <span class="at">L.eps =</span> L.eps, <span class="at">alpha.mu =</span> alpha.mu, <span class="at">basis =</span> basis, <span class="at">f.true =</span> <span class="cn">NULL</span>)</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>dfLegendre <span class="ot">=</span> <span class="fu">data.frame</span>( <span class="at">Time =</span> <span class="fu">rep</span>(data<span class="sc">$</span>time,N<span class="sc">+</span><span class="dv">1</span>),</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>                         <span class="at">basis =</span> <span class="fu">rep</span>(basis, (N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">*</span><span class="fu">length</span>(data<span class="sc">$</span>time)),</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>                         <span class="at">f =</span> <span class="fu">c</span>(data<span class="sc">$</span>y, data<span class="sc">$</span>f.true),</span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>                         <span class="at">type =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"obs"</span>, N), <span class="st">"True"</span>), <span class="at">each =</span> n), <span class="at">ind =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>(N<span class="sc">+</span><span class="dv">1</span>), <span class="at">each =</span> n))</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>basis <span class="ot">=</span> <span class="st">"Fourier"</span></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">dgp</span>(<span class="at">n=</span>n,<span class="at">N=</span>N,<span class="at">sd=</span>sd,<span class="at">L.star=</span>L.star, <span class="at">L.eps =</span> L.eps, <span class="at">alpha.mu =</span> alpha.mu, <span class="at">basis =</span> basis, <span class="at">f.true =</span> <span class="cn">NULL</span>)</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>dfFourier <span class="ot">=</span> <span class="fu">data.frame</span>( <span class="at">Time =</span> <span class="fu">rep</span>(data<span class="sc">$</span>time,N<span class="sc">+</span><span class="dv">1</span>),</span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>                        <span class="at">basis =</span> <span class="fu">rep</span>(basis, (N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">*</span><span class="fu">length</span>(data<span class="sc">$</span>time)),</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>                        <span class="at">f =</span> <span class="fu">c</span>(data<span class="sc">$</span>y, data<span class="sc">$</span>f.true),</span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>                        <span class="at">type =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"obs"</span>, N), <span class="st">"True"</span>), <span class="at">each =</span> n), <span class="at">ind =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>(N<span class="sc">+</span><span class="dv">1</span>), <span class="at">each =</span> n))</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>basis <span class="ot">=</span> <span class="st">"Splines"</span></span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">dgp</span>(<span class="at">n=</span>n,<span class="at">N=</span>N,<span class="at">sd=</span><span class="dv">2</span><span class="sc">*</span>sd,<span class="at">L.star=</span>L.star, <span class="at">L.eps =</span> L.eps, <span class="at">alpha.mu =</span> alpha.mu, <span class="at">basis =</span> basis, <span class="at">f.true =</span> <span class="cn">NULL</span>)</span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>dfSplines <span class="ot">=</span> <span class="fu">data.frame</span>( <span class="at">Time =</span> <span class="fu">rep</span>(data<span class="sc">$</span>time,N<span class="sc">+</span><span class="dv">1</span>),</span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>                        <span class="at">basis =</span> <span class="fu">rep</span>(basis, (N<span class="sc">+</span><span class="dv">1</span>)<span class="sc">*</span><span class="fu">length</span>(data<span class="sc">$</span>time)),</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>                        <span class="at">f =</span> <span class="fu">c</span>(data<span class="sc">$</span>y,data<span class="sc">$</span>f.true),</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>                        <span class="at">type =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"obs"</span>, N), <span class="st">"True"</span>), <span class="at">each =</span> n), <span class="at">ind =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>(N<span class="sc">+</span><span class="dv">1</span>), <span class="at">each =</span> n))</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">rbind</span>(dfLegendre, dfFourier, dfSplines)</span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> df, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> f, <span class="at">color =</span> type, <span class="at">group =</span> ind)) <span class="sc">+</span> </span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth=</span> <span class="fl">0.5</span>)<span class="sc">+</span></span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"obs"</span> <span class="ot">=</span> <span class="st">"lightgrey"</span>,<span class="st">"True"</span> <span class="ot">=</span> <span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>basis)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-BasisModel" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-BasisModel-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="ConfBand_files/figure-html/fig-BasisModel-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-BasisModel-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Illustrative example. We generate a regression functional model in the Fourier (left), Legendre (middle) and Splines (right) families. The red curve corresponds to the true function, and the gray curves correspond to noisy observations.
</figcaption>
</figure>
</div>
</div>
</div>
<p><a href="#prp-proj" class="quarto-xref">Proposition&nbsp;1</a> and <a href="#prp-proj2" class="quarto-xref">Proposition&nbsp;2</a> are illustrated in Appendix.</p>
<!--@fig-estimatorL displays estimators calculated with different dimensions $L$. Data are generated with $L^*=11$, $L^\varepsilon=20$, $n=50$ and $N=40$. The true function and its projection $\underline f^{L,L^*}$ are in cyan, and the estimator $\underline{\hat{f}_{}}^{L,L^*}$ is in red. We compute it for the three families, Legendre, Fourier and splines. 
In all cases, the estimators are very precise when considering the relevant dimension, but estimating a function of dimension $L^*$ with a function of dimension $L<L^*$ is not consistent. Note that the performance of the estimator for the spline family is also good, even if the family is not orthonormal, because we work here at the level of the function (and not at the level of the coefficients). 




::: {.cell}

```{.r .cell-code}
estimator = function(data, basis, L){
  ### data: the observations, only the timepoints and the individual functions
  ### basis: functional basis, to be chosen in 'Fourier', 'Splines'
  ### L: number of functional basis for the signal
  
  if (basis == 'Fourier'){
    if (L%%2 == 0){ L = L+1}
  }
  B = func.basis(data$time, L, basis)
  
  ### Data projection
  Hi = solve(t(B) %*% B) %*% t(B) %*% data$y
  mu.hat = rowMeans(Hi)
  f.hat = c(B %*% mu.hat)
  data.proj = data
  data.proj$y = B %*% Hi
  cov.emp = crossprod(t(data.proj$y - f.hat)) / ncol(data.proj$y)
  
  return(list(f.hat=f.hat, mu.hat = mu.hat, cov.emp = cov.emp, data.proj = data.proj))
}

set.seed(1)
basis = "Legendre"
data = dgp(n=50,N=40,sd=1,L.star=11, L.eps = 20, alpha.mu = NULL, basis = basis, f.true = NULL)
B = func.basis(data$time, L=5, basis)
f.true.L5 = t(B %*% solve(t(B) %*% B) %*% t(B) %*% data$f.true)
est5 = estimator(data, basis, L=5)
est11 = estimator(data, basis, L=11)
dfLegendre = data.frame( Time = rep(data$time,4),
                         basis = rep(basis, 4*length(data$time)),
                         f = c(data$f.true, c(f.true.L5), est5$f.hat, est11$f.hat),
                         L = rep(c("L = 11", "L = 5", "L = 5", "L = 11"), each = length(data$time)),
                         type = rep(c("True", "True", "Estimated", "Estimated"), each = length(data$time)))

basis = "Fourier"
data = dgp(n=50,N=40,sd=1,L.star=11, L.eps = 20, alpha.mu = NULL, basis = basis, f.true = NULL)
B = func.basis(data$time, L=5, basis)
f.true.L5 = t(B %*% solve(t(B) %*% B) %*% t(B) %*% data$f.true)
est5 = estimator(data, basis, L=5)
est11 = estimator(data, basis, L=11)
dfFourier = data.frame( Time = rep(data$time,4),
                        basis = rep(basis, 4*length(data$time)),
                        f = c(data$f.true, c(f.true.L5), est5$f.hat, est11$f.hat),
                        L = rep(c("L = 11", "L = 5", "L = 5", "L = 11"), each = length(data$time)),
                        type = rep(c("True", "True", "Estimated", "Estimated"), each = length(data$time)))

basis = "Splines"
data = dgp(n=50,N=40,sd=2*1,L.star=11, L.eps = 20, alpha.mu = NULL, basis = basis, f.true = NULL)
B = func.basis(data$time, L=5, basis)
f.true.L5 = t(B %*% solve(t(B) %*% B) %*% t(B) %*% data$f.true)
est5 = estimator(data, basis, L=5)
est11 = estimator(data, basis, L=11)
dfSplines = data.frame( Time = rep(data$time,4),
                        basis = rep(basis, 4*length(data$time)),
                        f = c(data$f.true, c(f.true.L5), est5$f.hat, est11$f.hat),
                        L = rep(c("L = 11", "L = 5", "L = 5", "L = 11"), each = length(data$time)),
                        type = rep(c("True", "True", "Estimated", "Estimated"), each = length(data$time)))

df = rbind(dfLegendre, dfFourier, dfSplines)
ggplot(data = df, aes(x = Time, y = f, color = type)) + 
  geom_line(aes(linetype = type), linewidth= 0.5)+
  facet_grid(L~basis)
```

::: {.cell-output-display}
![Illustrative example. For each family (Fourier which is orthogonal, Legendre which is orthonormal and the splines which are not orthogonal wrt the standard scalar product), we consider a function with true dimension 11 (top), and its projection on the space of dimension 5 (bottom), displayed in cyan. The estimators in dimensions 11 and 5 are displayed in red.](ConfBand_files/figure-html/fig-estimatorL-1.png){#fig-estimatorL width=672 height=50%}
:::
:::


!-->
</section>
<section id="sec-simu-band" class="level2">
<h2 class="anchored" data-anchor-id="sec-simu-band">Confidence band for a fixed level</h2>
<p>The band derived in <a href="#thm-sunLoader" class="quarto-xref">Theorem&nbsp;1</a> is illustrated on <a href="#fig-bandL" class="quarto-xref">Figure&nbsp;2</a>. It displays on the top row several functional data generated under either the Fourier family (left), Legendre (middle) or Spline (right), on the middle row the confidence bands of <span class="math inline">\(\underline f^{L,L^*}\)</span> for different values of <span class="math inline">\(L=3,5\)</span> and <span class="math inline">\(11\)</span>, and on the bottom row the bound <span class="math inline">\(\hat d^L\)</span>. The true functions <span class="math inline">\(\underline f^{L,L^*}\)</span> are displayed in cyan and the confidence bands in purple. The bands are very precise for each <span class="math inline">\(L\)</span>. The behavior of <span class="math inline">\(\hat d^L\)</span> increases with <span class="math inline">\(L\)</span>. As <span class="math inline">\(d^L\)</span> can be seen as a variance, <span class="math inline">\(\hat d^L(t)\)</span> is larger on the boundary of the time domain, as there are less observations near 0 and 1.</p>
<p>We also evaluate numerically the levels of the obtained confidence bands. For this, 1000 datasets are simulated, the confidence band is estimated for each of them. The empirical confidence level is then evaluated as the proportion of confidence bands that contain the true function. <a href="#tbl-levelL" class="quarto-xref">Table&nbsp;1</a> presents the empirical confidence levels for different values of <span class="math inline">\(L\)</span> and two sample sizes <span class="math inline">\(n=50\)</span> and <span class="math inline">\(n=150\)</span>, with <span class="math inline">\(N=10\)</span>, <span class="math inline">\(N=40\)</span> and <span class="math inline">\(N=60\)</span>. When <span class="math inline">\(N=40\)</span> and <span class="math inline">\(N=60\)</span>, the level is the expected one whatever the value of <span class="math inline">\(L\)</span>, especially when <span class="math inline">\(L&lt;L^*\)</span> and <span class="math inline">\(N=40\)</span>, but also when <span class="math inline">\(L&gt;L^\varepsilon\)</span>. We will see in the next sections that this will not be the case for the debiased confidence band. When <span class="math inline">\(N=10\)</span>, the level is too small, especially when <span class="math inline">\(L\)</span> is large. This might be due to the the large number of parameters to be estimated in the covariance matrix <span class="math inline">\(C\)</span>, with a small number of observations <span class="math inline">\(N\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>compute.c.L <span class="ot">=</span> <span class="cf">function</span>(data.scl, <span class="at">alpha =</span> <span class="fl">0.05</span>){</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">### data.scl: the rescaled data </span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">### alpha: the level for the confidence band</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  x_approx <span class="ot">=</span> <span class="fu">apply</span>(data.scl<span class="sc">$</span>y, <span class="dv">2</span>,<span class="at">FUN=</span><span class="cf">function</span>(yy){</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    fn <span class="ot">=</span> stats<span class="sc">::</span><span class="fu">splinefun</span>(<span class="at">x =</span> data.scl<span class="sc">$</span>time, <span class="at">y =</span> yy, <span class="at">method =</span> <span class="st">"natural"</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    pracma<span class="sc">::</span><span class="fu">fderiv</span>(<span class="at">f =</span> fn, <span class="at">x =</span> data.scl<span class="sc">$</span>time, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">h =</span> <span class="fl">1e-6</span>, <span class="at">method =</span> <span class="st">"central"</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">=</span> <span class="fu">ncol</span>(data.scl<span class="sc">$</span>y)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  hat.tau <span class="ot">=</span> <span class="fu">apply</span>(x_approx, <span class="dv">1</span>, stats<span class="sc">::</span>sd) </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  hat.tau[<span class="fu">which</span>(<span class="fu">is.na</span>(hat.tau))] <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  tau_01 <span class="ot">=</span> (hat.tau)[<span class="sc">-</span><span class="dv">1</span>]<span class="sc">%*%</span><span class="fu">diff</span>(data.scl<span class="sc">$</span>time)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  myfun <span class="ot">=</span> <span class="cf">function</span>(c){stats<span class="sc">::</span><span class="fu">pt</span>(c, <span class="at">lower.tail =</span> <span class="cn">FALSE</span>, <span class="at">df =</span> N<span class="dv">-1</span>) <span class="sc">+</span> tau_01 <span class="sc">*</span> </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>      (<span class="dv">1</span> <span class="sc">+</span> c<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span>(N<span class="dv">-1</span>))<span class="sc">^</span>(<span class="sc">-</span>(N<span class="dv">-1</span>)<span class="sc">/</span><span class="dv">2</span>)<span class="sc">/</span>(<span class="dv">2</span> <span class="sc">*</span> pi) <span class="sc">-</span> alpha<span class="sc">/</span><span class="dv">2</span>}</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  c.L <span class="ot">=</span> stats<span class="sc">::</span><span class="fu">uniroot</span>(<span class="at">f =</span> myfun,<span class="at">interval =</span> <span class="fu">c</span>(.<span class="dv">5</span>,<span class="dv">8</span>))<span class="sc">$</span>root</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(c.L)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>CB1 <span class="ot">=</span> <span class="cf">function</span>(data, basis, L, <span class="at">alpha =</span> <span class="fl">0.05</span>){</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="do">### data: the observations, only the timepoints and the individual functions</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="do">### basis: functional basis, to be chosen in 'Fourier', 'Splines'</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="do">### L: number of functional basis for the signal</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  <span class="do">### alpha: the level for the confidence band</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  est <span class="ot">=</span> <span class="fu">estimator</span>(data, basis, L)</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  data.proj <span class="ot">=</span> est<span class="sc">$</span>data.proj</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  data.scl <span class="ot">=</span> data.proj</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  data.scl<span class="sc">$</span>y <span class="ot">=</span> (data.proj<span class="sc">$</span>y <span class="sc">-</span> est<span class="sc">$</span>f.hat)<span class="sc">/</span><span class="fu">sqrt</span>(<span class="fu">diag</span>(est<span class="sc">$</span>cov.emp))</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  c.L <span class="ot">=</span> <span class="fu">compute.c.L</span>(data.scl, alpha)</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  d.L <span class="ot">=</span> c.L <span class="sc">%*%</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(est<span class="sc">$</span>cov.emp)<span class="sc">/</span><span class="fu">ncol</span>(data.scl<span class="sc">$</span>y))</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  f.hat.up <span class="ot">=</span> est<span class="sc">$</span>f.hat <span class="sc">+</span> d.L</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  f.hat.low <span class="ot">=</span> est<span class="sc">$</span>f.hat <span class="sc">-</span> d.L</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">f.hat.up =</span> f.hat.up, <span class="at">f.hat.low =</span> f.hat.low, <span class="at">d.L =</span> d.L, <span class="at">c.L =</span> c.L, <span class="at">width =</span> <span class="fu">max</span>(<span class="fu">abs</span>(f.hat.up<span class="sc">-</span>f.hat.low))))</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>d.L.Lmax <span class="ot">=</span> <span class="cf">function</span>(data, basis, L, <span class="at">Lmax=</span><span class="dv">30</span>, <span class="at">alpha =</span> <span class="fl">0.05</span>){</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>  est.<span class="fl">2.</span>f <span class="ot">=</span> <span class="fu">estimator</span>(data, basis, L)</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>  data.<span class="fl">2.</span>proj <span class="ot">=</span> est.<span class="fl">2.</span>f<span class="sc">$</span>data.proj</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>  est.<span class="fl">2.</span>f.Lmax <span class="ot">=</span> <span class="fu">estimator</span>(data, basis, Lmax)</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>  data.<span class="fl">2.</span>proj.Lmax <span class="ot">=</span> est.<span class="fl">2.</span>f.Lmax<span class="sc">$</span>data.proj</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>  residuals.L.Lmax <span class="ot">=</span> data.<span class="fl">2.</span>proj.Lmax<span class="sc">$</span>y <span class="sc">-</span> data.<span class="fl">2.</span>proj<span class="sc">$</span>y <span class="sc">-</span> (est.<span class="fl">2.</span>f.Lmax<span class="sc">$</span>f.hat <span class="sc">-</span> est.<span class="fl">2.</span>f<span class="sc">$</span>f.hat) </span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>  cov.emp.rest <span class="ot">=</span> <span class="fu">crossprod</span>(<span class="fu">t</span>(residuals.L.Lmax)) <span class="sc">/</span> <span class="fu">ncol</span>(residuals.L.Lmax)</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>  data.<span class="fl">2.</span>scl <span class="ot">=</span> data.<span class="fl">2.</span>proj</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>  data.<span class="fl">2.</span>scl<span class="sc">$</span>y <span class="ot">=</span> residuals.L.Lmax<span class="sc">/</span><span class="fu">sqrt</span>(cov.emp.rest)</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>  c.L.Lmax<span class="fl">.2</span> <span class="ot">=</span> <span class="fu">compute.c.L</span>(data.<span class="fl">2.</span>scl, alpha)</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>  d.L.Lmax<span class="fl">.2</span> <span class="ot">=</span> c.L.Lmax<span class="fl">.2</span> <span class="sc">%*%</span> <span class="fu">sqrt</span>(cov.emp.rest<span class="sc">/</span><span class="fu">ncol</span>(data.<span class="fl">2.</span>scl<span class="sc">$</span>y))</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(c.L.Lmax<span class="fl">.2</span>)</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>dfObs <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">Time =</span> <span class="fu">double</span>(),</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">basis =</span> <span class="fu">character</span>(),</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">f =</span> <span class="fu">double</span>(),</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">ind =</span> <span class="fu">integer</span>())</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>dfTrue <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">Time =</span> <span class="fu">double</span>(),</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">basis =</span> <span class="fu">character</span>(),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">f =</span> <span class="fu">double</span>())</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>dfTrueProjected <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">Time =</span> <span class="fu">double</span>(),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>                             <span class="at">basis =</span> <span class="fu">character</span>(),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>                             <span class="at">f =</span> <span class="fu">double</span>(),</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>                             <span class="at">dimension =</span> <span class="fu">character</span>())</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>dfBand <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Time =</span> <span class="fu">double</span>(),</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>                     <span class="at">basis =</span> <span class="fu">character</span>(),</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>                     <span class="at">flow =</span> <span class="fu">double</span>(),</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>                     <span class="at">fup =</span> <span class="fu">double</span>(),</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">dimension =</span> <span class="fu">character</span>())</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>dfdL <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Time =</span> <span class="fu">double</span>(),</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>                   <span class="at">basis =</span> <span class="fu">character</span>(),</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>                   <span class="at">dL =</span> <span class="fu">double</span>(),</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>                   <span class="at">dimension =</span> <span class="fu">character</span>())</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>vec.L <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">11</span>)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (basis <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"Legendre"</span>, <span class="st">"Fourier"</span>, <span class="st">"Splines"</span>)){</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">=</span> <span class="dv">40</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (basis <span class="sc">==</span> <span class="st">"Splines"</span>){</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">=</span> <span class="fu">dgp</span>(<span class="at">n=</span><span class="dv">50</span>,<span class="at">N=</span>N,<span class="at">sd=</span><span class="dv">2</span><span class="sc">*</span><span class="dv">1</span>,<span class="at">L.star=</span><span class="dv">10</span>, <span class="at">L.eps =</span> <span class="dv">20</span>, <span class="at">alpha.mu =</span> <span class="cn">NULL</span>, <span class="at">basis =</span> basis, <span class="at">f.true =</span> <span class="cn">NULL</span>)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span>  {data <span class="ot">=</span> <span class="fu">dgp</span>(<span class="at">n=</span><span class="dv">50</span>,<span class="at">N=</span>N,<span class="at">sd=</span><span class="dv">1</span>,<span class="at">L.star=</span><span class="dv">10</span>, <span class="at">L.eps =</span> <span class="dv">20</span>, <span class="at">alpha.mu =</span> <span class="cn">NULL</span>, <span class="at">basis =</span> basis, <span class="at">f.true =</span> <span class="cn">NULL</span>)}</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>  dfObs <span class="ot">=</span> <span class="fu">rbind</span>(dfObs,<span class="fu">data.frame</span>(<span class="at">Time =</span> <span class="fu">rep</span>(data<span class="sc">$</span>time, N),</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">basis =</span> <span class="fu">rep</span>(basis, <span class="fu">length</span>(<span class="fu">c</span>(data<span class="sc">$</span>y))),</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">f =</span> <span class="fu">c</span>(data<span class="sc">$</span>y),</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">ind =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>N, <span class="at">each =</span> <span class="fu">length</span>(data<span class="sc">$</span>time))))</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>  dfTrue <span class="ot">=</span> <span class="fu">rbind</span>(dfTrue,<span class="fu">data.frame</span>(<span class="at">Time =</span> data<span class="sc">$</span>time,</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">basis =</span> <span class="fu">rep</span>(basis, <span class="fu">length</span>(data<span class="sc">$</span>time)),</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">f =</span> data<span class="sc">$</span>f.true))</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (L <span class="cf">in</span> vec.L){</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    conf.band <span class="ot">=</span> <span class="fu">CB1</span>(data, basis, L)</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    B <span class="ot">=</span> <span class="fu">func.basis</span>(data<span class="sc">$</span>time, L, basis)</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    f.true.L <span class="ot">=</span> <span class="fu">t</span>(B <span class="sc">%*%</span> <span class="fu">solve</span>(<span class="fu">t</span>(B) <span class="sc">%*%</span> B) <span class="sc">%*%</span> <span class="fu">t</span>(B) <span class="sc">%*%</span> data<span class="sc">$</span>f.true)</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    dfBand <span class="ot">=</span> <span class="fu">rbind</span>(dfBand, <span class="fu">data.frame</span>(<span class="at">Time =</span> data<span class="sc">$</span>time,</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">basis =</span> <span class="fu">rep</span>(basis, <span class="fu">length</span>(data<span class="sc">$</span>time)),</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">flow =</span> <span class="fu">c</span>(conf.band<span class="sc">$</span>f.hat.low), </span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">fup =</span> <span class="fu">c</span>(conf.band<span class="sc">$</span>f.hat.up), </span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">dimension =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(L, <span class="fu">length</span>(data<span class="sc">$</span>time)))))</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>    dfTrueProjected <span class="ot">=</span> <span class="fu">rbind</span>(dfTrueProjected, <span class="fu">data.frame</span>(<span class="at">Time =</span> data<span class="sc">$</span>time,</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>                                                        <span class="at">basis =</span> <span class="fu">rep</span>(basis, <span class="fu">length</span>(data<span class="sc">$</span>time)),</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>                                                        <span class="at">f =</span> <span class="fu">c</span>(f.true.L), </span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>                                                        <span class="at">dimension =</span> <span class="fu">rep</span>(L, <span class="fu">length</span>(data<span class="sc">$</span>time))))</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>    dfdL <span class="ot">=</span> <span class="fu">rbind</span>(dfdL, <span class="fu">data.frame</span>(<span class="at">Time =</span> data<span class="sc">$</span>time,</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">basis =</span> <span class="fu">rep</span>(basis, <span class="fu">length</span>(data<span class="sc">$</span>time)),</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">dL =</span> <span class="fu">c</span>(conf.band<span class="sc">$</span>d.L),</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">dimension =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(L,<span class="fu">length</span>(data<span class="sc">$</span>time)))))</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>  } </span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> dfObs, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> f, <span class="at">group =</span> ind), <span class="at">linewidth =</span> <span class="fl">0.1</span>, <span class="at">color =</span> <span class="st">"grey"</span>) <span class="sc">+</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> dfTrue, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> f), <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>basis)</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> dfBand, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> flow, <span class="at">group =</span> dimension, <span class="at">color =</span> dimension), <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> dfBand, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> fup, <span class="at">group =</span> dimension, <span class="at">color =</span> dimension), <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span> </span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> dfTrueProjected, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> f, <span class="at">group =</span> dimension), <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="fl">0.2</span>)<span class="sc">+</span> </span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>basis) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"confidence band"</span>)</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> dfdL, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> dL, <span class="at">group =</span> dimension, <span class="at">color =</span> dimension)) <span class="sc">+</span></span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>basis)</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a><span class="fu">ggarrange</span>(p1, p2, p3, <span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">common.legend =</span> <span class="cn">TRUE</span>, <span class="at">legend =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-bandL" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-bandL-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="ConfBand_files/figure-html/fig-bandL-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-bandL-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Illustrative example. For the three families, resp. Fourier, Legendre and the splines, we display on the top row the observed functional data, on the middle row the confidence bands for different values of L (3, 5 and 11), and on the bottom row the bound dL.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>run <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>vec.L <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">11</span>,<span class="dv">15</span>,<span class="dv">21</span>, <span class="dv">25</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>vec.n <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">150</span>) </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>vec.N <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">40</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (run <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  nb.repeat <span class="ot">=</span> <span class="dv">1000</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  n.test <span class="ot">=</span> <span class="dv">5000</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  vec.L <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">11</span>,<span class="dv">15</span>,<span class="dv">21</span>, <span class="dv">25</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  vec.n <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">150</span>) </span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  vec.N <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">40</span>, <span class="dv">60</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  vec.basis <span class="ot">=</span> <span class="fu">c</span>(<span class="st">'Fourier'</span>, <span class="st">"Legendre"</span>, <span class="st">"Splines"</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">=</span> <span class="fu">seq</span>(<span class="fu">min</span>(data<span class="sc">$</span>time), <span class="fu">max</span>(data<span class="sc">$</span>time), <span class="at">length.out =</span> n.test)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  perf <span class="ot">=</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">c</span>(<span class="fu">max</span>(vec.L),<span class="fu">length</span>(vec.n),<span class="fu">length</span>(vec.N), <span class="fu">length</span>(vec.basis)))</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (ind.basis <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(vec.basis)){</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (ind.n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(vec.n)){</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (ind.N <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(vec.N)){</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (L <span class="cf">in</span> vec.L){</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>          cpt <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (rep <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nb.repeat){</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>            <span class="fu">set.seed</span>(rep)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (vec.basis[ind.basis] <span class="sc">==</span> <span class="st">"Splines"</span>){           data <span class="ot">=</span> <span class="fu">dgp</span>(<span class="at">n=</span>vec.n[ind.n], <span class="at">N =</span> vec.N[ind.N], <span class="at">basis =</span> vec.basis[ind.basis], <span class="at">sd =</span> <span class="dv">2</span>)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>            } <span class="cf">else</span> { data <span class="ot">=</span> <span class="fu">dgp</span>(<span class="at">n=</span>vec.n[ind.n], <span class="at">N =</span> vec.N[ind.N], <span class="at">basis =</span> vec.basis[ind.basis]) }</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>            conf.band <span class="ot">=</span> <span class="fu">CB1</span>(data, vec.basis[ind.basis], L, <span class="at">alpha=</span> <span class="fl">0.05</span>)</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (vec.basis[ind.basis] <span class="sc">==</span> <span class="st">'Fourier'</span>){</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> (L<span class="sc">%%</span><span class="dv">2</span> <span class="sc">==</span> <span class="dv">0</span>){ L <span class="ot">=</span> L<span class="sc">+</span><span class="dv">1</span>}</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>            B.old <span class="ot">=</span> <span class="fu">func.basis</span>(data<span class="sc">$</span>time, L, vec.basis[ind.basis])</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>            B <span class="ot">=</span> <span class="fu">func.basis</span>(time, L, vec.basis[ind.basis])</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>            f.true.L <span class="ot">=</span> <span class="fu">t</span>(B <span class="sc">%*%</span> <span class="fu">solve</span>(<span class="fu">t</span>(B.old) <span class="sc">%*%</span> B.old) <span class="sc">%*%</span> <span class="fu">t</span>(B.old) <span class="sc">%*%</span> data<span class="sc">$</span>f.true)</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>            f.hat.up <span class="ot">=</span> stats<span class="sc">::</span><span class="fu">spline</span>(<span class="at">x =</span> data<span class="sc">$</span>time, <span class="at">y =</span> conf.band<span class="sc">$</span>f.hat.up, <span class="at">xout =</span> time, <span class="at">method =</span> <span class="st">"natural"</span>)<span class="sc">$</span>y</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>            f.hat.low <span class="ot">=</span> stats<span class="sc">::</span><span class="fu">spline</span>(<span class="at">x =</span> data<span class="sc">$</span>time, <span class="at">y =</span> conf.band<span class="sc">$</span>f.hat.low, <span class="at">xout =</span> time, <span class="at">method =</span> <span class="st">"natural"</span>)<span class="sc">$</span>y</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="fu">sum</span>(f.true.L<span class="sc">&lt;</span> f.hat.up)<span class="sc">+</span><span class="fu">sum</span>(f.true.L<span class="sc">&gt;</span> f.hat.low) <span class="sc">==</span> <span class="dv">2</span><span class="sc">*</span>n.test){</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>              cpt <span class="ot">=</span> cpt<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>            } </span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>          perf[L,ind.n, ind.N, ind.basis] <span class="ot">=</span> cpt<span class="sc">/</span>nb.repeat</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(perf, <span class="at">file =</span> <span class="st">"Res_Tab1.RData"</span>)</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {<span class="fu">load</span>(<span class="st">"res_Tab1.RData"</span>) } <span class="do">### charger les donn√©es</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>perf.F <span class="ot">=</span> <span class="fu">cbind</span>(perf[vec.L,,<span class="dv">1</span>,<span class="dv">1</span>],perf[vec.L,,<span class="dv">2</span>,<span class="dv">1</span>],perf[vec.L,,<span class="dv">3</span>,<span class="dv">1</span>])</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>perf.L <span class="ot">=</span> <span class="fu">cbind</span>(perf[vec.L,,<span class="dv">1</span>,<span class="dv">2</span>],perf[vec.L,,<span class="dv">2</span>,<span class="dv">2</span>],perf[vec.L,,<span class="dv">3</span>,<span class="dv">2</span>])</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>perf.S <span class="ot">=</span> <span class="fu">cbind</span>(perf[vec.L,,<span class="dv">1</span>,<span class="dv">3</span>],perf[vec.L,,<span class="dv">2</span>,<span class="dv">3</span>],perf[vec.L,,<span class="dv">3</span>,<span class="dv">3</span>])</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(perf.F) <span class="ot">=</span> vec.L</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(perf.L) <span class="ot">=</span> vec.L</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(perf.S) <span class="ot">=</span> vec.L</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(perf.F) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">'50/10'</span>, <span class="st">'150/10'</span>, <span class="st">'50/40'</span>, <span class="st">'150/40'</span>, <span class="st">'50/60'</span>, <span class="st">'150/60'</span>)</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(perf.L) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">'50/10'</span>, <span class="st">'150/10'</span>, <span class="st">'50/40'</span>, <span class="st">'150/40'</span>, <span class="st">'50/60'</span>, <span class="st">'150/60'</span>)</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(perf.S) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">'50/10'</span>, <span class="st">'150/10'</span>, <span class="st">'50/40'</span>, <span class="st">'150/40'</span>, <span class="st">'50/60'</span>, <span class="st">'150/60'</span>)</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a><span class="co">#kable(perf)</span></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>perf.F <span class="sc">%&gt;%</span></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="st">"latex"</span>, <span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_header_above</span>(<span class="fu">c</span>(<span class="st">"L"</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">"n/N"</span> <span class="ot">=</span> <span class="dv">6</span>))</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>perf.L <span class="sc">%&gt;%</span></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="st">"latex"</span>, <span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_header_above</span>(<span class="fu">c</span>(<span class="st">"L"</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">"n/N"</span> <span class="ot">=</span> <span class="dv">6</span>))</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>perf.S <span class="sc">%&gt;%</span></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="st">"latex"</span>, <span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_header_above</span>(<span class="fu">c</span>(<span class="st">"L"</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">"n/N"</span> <span class="ot">=</span> <span class="dv">6</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tbl-levelL" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-levelL-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: The confidence level of the confidence band CB is evaluated from 1000 repetitions. Confidence bands are calculated with the Fourier family (a), Legendre family (b) and Splines family (c), for several L in rows and several n and N in columns, for alpha = 0.05.
</figcaption>
<div aria-describedby="tbl-levelL-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">

</div>
<div class="cell-output-display">

</div>
<div class="cell-output-display">

</div>
</div>
</figure>
</div>
</div>
</section>
<section id="sec-simudebias" class="level2">
<h2 class="anchored" data-anchor-id="sec-simudebias">Confidence bands by correcting the bias</h2>
<p>We illustrate the results given in <a href="#prp-CBf" class="quarto-xref">Proposition&nbsp;5</a>. In <a href="#fig-Lstar" class="quarto-xref">Figure&nbsp;3</a>, top row, we plot the confidence bands obtained for different dimensions <span class="math inline">\(L \in \{3,5,11,15,21\}\)</span> with Fourier, Legendre and Splines families and <span class="math inline">\(\alpha=\beta=\sqrt{0.05}\approx 0.22\)</span>. We can see that all the confidence bands are alike. Especially, they are unbiased, even for <span class="math inline">\(L=3\)</span>. A larger dimension <span class="math inline">\(L\)</span> provides a smoother band. On the middle and bottom rows of <a href="#fig-Lstar" class="quarto-xref">Figure&nbsp;3</a>, we illustrate the two terms that enter the confidence band, <span class="math inline">\(t \mapsto \hat d_1^L(t)\)</span> and <span class="math inline">\(t\mapsto \hat d_2^{L,L_{\max}}(t)\)</span>. Their behavior is the same along time. The function <span class="math inline">\(\hat d_1^L(t)\)</span> can be seen as a variance, this is why it is larger near 0 and 1 where there are less observations. The function <span class="math inline">\(\hat d_2^{L,L_{\max}}(t)\)</span> is smaller than <span class="math inline">\(\hat d_1^L(t)\)</span> because it controls the remaining rest after the projection. Note that as expected when <span class="math inline">\(L&gt;L^\varepsilon\)</span>, <span class="math inline">\(\hat d_2^{L,L_{\max}}(t)\)</span> is close to 0. As explained before, the influence of <span class="math inline">\(L\)</span> is not the same for the two functions. When <span class="math inline">\(L\)</span> increases, <span class="math inline">\(\hat d_1^L(t)\)</span> increases while <span class="math inline">\(\hat d_2^{L,L_{\max}}(t)\)</span> decreases.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>CB2 <span class="ot">=</span> <span class="cf">function</span>(data, basis, L, <span class="at">Lmax =</span> <span class="dv">30</span>, <span class="at">alpha =</span> <span class="fl">0.05</span>, <span class="at">beta =</span> <span class="fl">0.05</span>){</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">### data: the observations, only the time-points and the individual functions</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">### basis: functional basis, to be chosen in 'Fourier', 'Splines'</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">### L: number of functional basis for the signal</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="do">### alpha: the level for the confidence band</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  data<span class="fl">.1</span> <span class="ot">=</span> data<span class="fl">.2</span> <span class="ot">=</span> data</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  ind<span class="fl">.1</span> <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">dim</span>(data<span class="sc">$</span>y)[<span class="dv">2</span>], <span class="fu">dim</span>(data<span class="sc">$</span>y)[<span class="dv">2</span>]<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  data<span class="fl">.1</span><span class="sc">$</span>y <span class="ot">=</span> data<span class="sc">$</span>y[,ind<span class="fl">.1</span>]</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  data<span class="fl">.2</span><span class="sc">$</span>y <span class="ot">=</span> data<span class="sc">$</span>y[,<span class="sc">-</span>ind<span class="fl">.1</span>]</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="do">### d.L.1</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  est.<span class="fl">1.</span>f <span class="ot">=</span> <span class="fu">estimator</span>(data<span class="fl">.1</span>, basis, L)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  data.<span class="fl">1.</span>proj <span class="ot">=</span> est.<span class="fl">1.</span>f<span class="sc">$</span>data.proj</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  data.<span class="fl">1.</span>scl <span class="ot">=</span> data.<span class="fl">1.</span>proj</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  data.<span class="fl">1.</span>scl<span class="sc">$</span>y <span class="ot">=</span> (data.<span class="fl">1.</span>proj<span class="sc">$</span>y <span class="sc">-</span> est.<span class="fl">1.</span>f<span class="sc">$</span>f.hat)<span class="sc">/</span><span class="fu">sqrt</span>(<span class="fu">diag</span>(est.<span class="fl">1.</span>f<span class="sc">$</span>cov.emp))</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  c.L<span class="fl">.1</span> <span class="ot">=</span> <span class="fu">compute.c.L</span>(data.<span class="fl">1.</span>scl, alpha)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  d.L<span class="fl">.1</span> <span class="ot">=</span> c.L<span class="fl">.1</span> <span class="sc">%*%</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(est.<span class="fl">1.</span>f<span class="sc">$</span>cov.emp)<span class="sc">/</span><span class="fu">ncol</span>(data.<span class="fl">1.</span>scl<span class="sc">$</span>y))</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  <span class="do">### d.L.2</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  est.<span class="fl">2.</span>f <span class="ot">=</span> <span class="fu">estimator</span>(data<span class="fl">.2</span>, basis, L)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  data.<span class="fl">2.</span>proj <span class="ot">=</span> est.<span class="fl">2.</span>f<span class="sc">$</span>data.proj</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  est.<span class="fl">2.</span>f.Lmax <span class="ot">=</span> <span class="fu">estimator</span>(data<span class="fl">.2</span>, basis, Lmax)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>  data.<span class="fl">2.</span>proj.Lmax <span class="ot">=</span> est.<span class="fl">2.</span>f.Lmax<span class="sc">$</span>data.proj</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>  residuals.L.Lmax <span class="ot">=</span> data.<span class="fl">2.</span>proj.Lmax<span class="sc">$</span>y <span class="sc">-</span> data.<span class="fl">2.</span>proj<span class="sc">$</span>y <span class="sc">-</span> (est.<span class="fl">2.</span>f.Lmax<span class="sc">$</span>f.hat <span class="sc">-</span> est.<span class="fl">2.</span>f<span class="sc">$</span>f.hat) </span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>  cov.emp.rest <span class="ot">=</span> <span class="fu">crossprod</span>(<span class="fu">t</span>(residuals.L.Lmax)) <span class="sc">/</span> <span class="fu">ncol</span>(residuals.L.Lmax)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>  data.<span class="fl">2.</span>scl <span class="ot">=</span> data.<span class="fl">2.</span>proj</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>  data.<span class="fl">2.</span>scl<span class="sc">$</span>y <span class="ot">=</span> residuals.L.Lmax<span class="sc">/</span><span class="fu">sqrt</span>(<span class="fu">diag</span>(cov.emp.rest))</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>  c.L.Lmax<span class="fl">.2</span> <span class="ot">=</span> <span class="fu">compute.c.L</span>(data.<span class="fl">2.</span>scl, beta)</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>  d.L.Lmax<span class="fl">.2</span> <span class="ot">=</span> c.L.Lmax<span class="fl">.2</span> <span class="sc">%*%</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(cov.emp.rest)<span class="sc">/</span><span class="fu">ncol</span>(data.<span class="fl">2.</span>scl<span class="sc">$</span>y))</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>  f.hat.up <span class="ot">=</span> est.<span class="fl">2.</span>f.Lmax<span class="sc">$</span>f.hat <span class="sc">-</span> est.<span class="fl">2.</span>f<span class="sc">$</span>f.hat <span class="sc">+</span> est.<span class="fl">1.</span>f<span class="sc">$</span>f.hat <span class="sc">+</span> d.L<span class="fl">.1</span> <span class="sc">+</span> d.L.Lmax<span class="fl">.2</span> </span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>  f.hat.low <span class="ot">=</span> est.<span class="fl">2.</span>f.Lmax<span class="sc">$</span>f.hat <span class="sc">-</span> est.<span class="fl">2.</span>f<span class="sc">$</span>f.hat <span class="sc">+</span> est.<span class="fl">1.</span>f<span class="sc">$</span>f.hat <span class="sc">-</span> d.L<span class="fl">.1</span> <span class="sc">-</span> d.L.Lmax<span class="fl">.2</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">f.hat.up =</span> f.hat.up, <span class="at">f.hat.low =</span> f.hat.low, <span class="at">d.L =</span> d.L<span class="fl">.1</span>, <span class="at">d.L.Lmax =</span> d.L.Lmax<span class="fl">.2</span>, <span class="at">width =</span> <span class="fu">max</span>(<span class="fu">abs</span>(f.hat.up<span class="sc">-</span>f.hat.low))))</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>dfTrue <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">Time =</span> <span class="fu">double</span>(),</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>                    <span class="at">f =</span> <span class="fu">double</span>(),</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>                    <span class="at">basis =</span> <span class="fu">character</span>()</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>dfBandup <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">Time =</span> <span class="fu">double</span>(),</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>                      <span class="at">bandup =</span> <span class="fu">double</span>(),</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>                      <span class="at">basis =</span> <span class="fu">character</span>(),</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>                      <span class="at">dimension =</span> <span class="fu">character</span>()</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>dfBandlow <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">Time =</span> <span class="fu">double</span>(),</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>                       <span class="at">bandlow =</span> <span class="fu">double</span>(),</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>                       <span class="at">basis =</span> <span class="fu">character</span>(),</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>                       <span class="at">dimension =</span> <span class="fu">character</span>()</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>dfdL <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">Time =</span> <span class="fu">double</span>(),</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dLLmax =</span> <span class="fu">double</span>(),</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>                  <span class="at">basis =</span> <span class="fu">character</span>(),</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dimension =</span> <span class="fu">character</span>()</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>dfdLLmax <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">Time =</span> <span class="fu">double</span>(),</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>                      <span class="at">dL =</span> <span class="fu">double</span>(),</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>                      <span class="at">basis =</span> <span class="fu">character</span>(),</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>                      <span class="at">dimension =</span> <span class="fu">character</span>()</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>vec.L <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">11</span>,<span class="dv">15</span>,<span class="dv">21</span>)</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (basis <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"Legendre"</span>, <span class="st">"Fourier"</span>, <span class="st">"Splines"</span>)){</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (basis <span class="sc">==</span> <span class="st">"Splines"</span>){ data <span class="ot">=</span> <span class="fu">dgp</span>(<span class="at">n=</span><span class="dv">50</span>,<span class="at">N=</span><span class="dv">40</span>,<span class="at">sd=</span><span class="dv">2</span><span class="sc">*</span><span class="dv">1</span>,<span class="at">L.star=</span><span class="dv">10</span>, <span class="at">L.eps =</span> <span class="dv">20</span>, <span class="at">alpha.mu =</span> <span class="cn">NULL</span>, <span class="at">basis =</span> basis, <span class="at">f.true =</span> <span class="cn">NULL</span>)</span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> { data <span class="ot">=</span> <span class="fu">dgp</span>(<span class="at">n=</span><span class="dv">50</span>,<span class="at">N=</span><span class="dv">40</span>,<span class="at">sd=</span><span class="dv">1</span>,<span class="at">L.star=</span><span class="dv">10</span>, <span class="at">L.eps =</span> <span class="dv">20</span>, <span class="at">alpha.mu =</span> <span class="cn">NULL</span>, <span class="at">basis =</span> basis, <span class="at">f.true =</span> <span class="cn">NULL</span>)}</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>  dfTrue <span class="ot">=</span> <span class="fu">rbind</span>(dfTrue, <span class="fu">data.frame</span>(<span class="at">Time =</span> data<span class="sc">$</span>time,</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">f =</span> data<span class="sc">$</span>f.true,</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">basis =</span> <span class="fu">rep</span>(basis, <span class="fu">length</span>(data<span class="sc">$</span>time))))</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>  crit.sel <span class="ot">=</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">nrow =</span> <span class="dv">30</span>)</span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (L <span class="cf">in</span> vec.L){</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>    conf.band.L.star<span class="fl">.2</span> <span class="ot">=</span> <span class="fu">CB2</span>(data, basis, L, <span class="at">Lmax =</span> <span class="dv">30</span>, <span class="at">alpha =</span> <span class="fl">0.05</span>)</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>    crit.sel[L,] <span class="ot">=</span><span class="fu">c</span>(<span class="fu">max</span>(conf.band.L.star<span class="fl">.2</span><span class="sc">$</span>d.L), <span class="fu">max</span>(conf.band.L.star<span class="fl">.2</span><span class="sc">$</span>d.L.Lmax),</span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">sum</span>(<span class="fu">abs</span>(conf.band.L.star<span class="fl">.2</span><span class="sc">$</span>d.L<span class="sc">+</span>conf.band.L.star<span class="fl">.2</span><span class="sc">$</span>d.L.Lmax)))</span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>    dfBandup <span class="ot">=</span> <span class="fu">rbind</span>(dfBandup, <span class="fu">data.frame</span>(<span class="at">Time =</span> data<span class="sc">$</span>time,</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">bandup =</span> <span class="fu">t</span>(conf.band.L.star<span class="fl">.2</span><span class="sc">$</span>f.hat.up),</span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">basis =</span> <span class="fu">rep</span>(basis, <span class="fu">length</span>(data<span class="sc">$</span>time)),</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">dimension =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(L, <span class="fu">length</span>(data<span class="sc">$</span>time)))))</span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>    dfBandlow <span class="ot">=</span> <span class="fu">rbind</span>(dfBandlow, <span class="fu">data.frame</span>(<span class="at">Time =</span> data<span class="sc">$</span>time,</span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">bandlow =</span> <span class="fu">t</span>(conf.band.L.star<span class="fl">.2</span><span class="sc">$</span>f.hat.low),</span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">basis =</span> <span class="fu">rep</span>(basis, <span class="fu">length</span>(data<span class="sc">$</span>time)),</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">dimension =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(L, <span class="fu">length</span>(data<span class="sc">$</span>time)))))</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>    dfdL <span class="ot">=</span> <span class="fu">rbind</span>(dfdL, <span class="fu">data.frame</span>(<span class="at">Time =</span> data<span class="sc">$</span>time,</span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">dL =</span> <span class="fu">t</span>(conf.band.L.star<span class="fl">.2</span><span class="sc">$</span>d.L),</span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">basis =</span> <span class="fu">rep</span>(basis, <span class="fu">length</span>(data<span class="sc">$</span>time)),</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">dimension =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(L, <span class="fu">length</span>(data<span class="sc">$</span>time)))))</span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>    dfdLLmax <span class="ot">=</span> <span class="fu">rbind</span>(dfdLLmax, <span class="fu">data.frame</span>(<span class="at">Time =</span> data<span class="sc">$</span>time,</span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">dLLmax =</span> <span class="fu">t</span>(conf.band.L.star<span class="fl">.2</span><span class="sc">$</span>d.L.Lmax),</span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">basis =</span> <span class="fu">rep</span>(basis, <span class="fu">length</span>(data<span class="sc">$</span>time)),</span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">dimension =</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(L, <span class="fu">length</span>(data<span class="sc">$</span>time)))))</span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> dfTrue, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> f)) <span class="sc">+</span></span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> dfBandup, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> bandup, <span class="at">group =</span> dimension, <span class="at">color =</span> dimension), <span class="at">linewidth =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> dfBandlow, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> bandlow, <span class="at">group =</span> dimension, <span class="at">color =</span> dimension), <span class="at">linewidth =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span> basis)</span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> dfdL, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> dL, <span class="at">group =</span> dimension, <span class="at">color =</span> dimension), <span class="at">linewidth =</span> <span class="fl">0.4</span>) <span class="sc">+</span> </span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>( <span class="sc">~</span> basis) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"d.L"</span>)</span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> dfdLLmax, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> dLLmax, <span class="at">group =</span> dimension, <span class="at">color =</span> dimension), <span class="at">linewidth =</span> <span class="fl">0.4</span>) <span class="sc">+</span> </span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>( <span class="sc">~</span> basis) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"d.L.Lmax"</span>)</span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true" tabindex="-1"></a><span class="fu">ggarrange</span>(p1, p2, p3, <span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">common.legend =</span> <span class="cn">TRUE</span>, <span class="at">legend =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-Lstar" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-Lstar-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="ConfBand_files/figure-html/fig-Lstar-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Lstar-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Illustrative example. For a given dataset, we plot several confidence bands (top row), functions dL (middle row) and dLLmax (bottom row). Bands and functions are estimated with Fourier (left column), Legendre (middle column) and Spline (right column) basis and several dimensions L (3, 5, 11, 15, 21).
</figcaption>
</figure>
</div>
</div>
</div>
<p>In <a href="#tbl-levLstar" class="quarto-xref">Table&nbsp;2</a>, we simulate 1000 repeated datasets with the Legendre family and with two sample sizes <span class="math inline">\(n=50\)</span> and <span class="math inline">\(n=150\)</span> and <span class="math inline">\(N=40\)</span>. For each dataset, we compute the confidence band defined in <a href="#prp-CBf" class="quarto-xref">Proposition&nbsp;5</a> with a theoretical confidence level of <span class="math inline">\(1-\alpha\beta=0.95\)</span> and for different values of <span class="math inline">\(L\)</span>. Then the confidence level is approximated as the proportion of confidence bands containing the true function <span class="math inline">\(f\)</span>. Remark that when <span class="math inline">\(L&lt;L^{\varepsilon}\)</span>, the level is the expected one, that is 0.95. When <span class="math inline">\(L&gt;L^{\varepsilon}\)</span>, the level is not more ensured, as explained before. Indeed the term <span class="math inline">\(d^{L,L^{\max}}\)</span> is mainly equal to 0, and the level is close to <span class="math inline">\(1-\alpha\)</span> instead of <span class="math inline">\(1-\alpha\beta\)</span>. This is not the case for the band in <a href="#sec-bandSun" class="quarto-xref">Section&nbsp;3</a>, as this is due to the correction of the bias.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>run <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (run <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  nb.repeat <span class="ot">=</span> <span class="dv">1000</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  n.test <span class="ot">=</span> <span class="dv">5000</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  vec.L <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">5</span>,<span class="dv">11</span>,<span class="dv">15</span>,<span class="dv">21</span>, <span class="dv">25</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  vec.n <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">150</span>) </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  basis <span class="ot">=</span> <span class="st">"Legendre"</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">=</span> <span class="fu">seq</span>(<span class="fu">min</span>(data<span class="sc">$</span>time), <span class="fu">max</span>(data<span class="sc">$</span>time), <span class="at">length.out =</span> n.test)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  perf <span class="ot">=</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">max</span>(vec.L), <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (ind.n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(vec.n)){</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (L <span class="cf">in</span> vec.L){</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>      cpt <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (rep <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nb.repeat){</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">set.seed</span>(rep)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>        data <span class="ot">=</span> <span class="fu">dgp</span>(<span class="at">n=</span>vec.n[ind.n], <span class="at">basis =</span> <span class="st">"Legendre"</span>)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        conf.band.L.star<span class="fl">.2</span> <span class="ot">=</span> <span class="fu">CB2</span>(data, basis, L, <span class="at">Lmax =</span> <span class="dv">30</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">beta=</span><span class="fl">0.2</span>)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>        f.true <span class="ot">=</span> stats<span class="sc">::</span><span class="fu">spline</span>(<span class="at">x =</span> data<span class="sc">$</span>time, <span class="at">y =</span> data<span class="sc">$</span>f.true, <span class="at">xout =</span> time, <span class="at">method =</span> <span class="st">"natural"</span>)<span class="sc">$</span>y</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>        f.hat.up <span class="ot">=</span> stats<span class="sc">::</span><span class="fu">spline</span>(<span class="at">x =</span> data<span class="sc">$</span>time, <span class="at">y =</span> conf.band.L.star<span class="fl">.2</span><span class="sc">$</span>f.hat.up, <span class="at">xout =</span> time, <span class="at">method =</span> <span class="st">"natural"</span>)<span class="sc">$</span>y</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        f.hat.low <span class="ot">=</span> stats<span class="sc">::</span><span class="fu">spline</span>(<span class="at">x =</span> data<span class="sc">$</span>time, <span class="at">y =</span> conf.band.L.star<span class="fl">.2</span><span class="sc">$</span>f.hat.low, <span class="at">xout =</span> time, <span class="at">method =</span> <span class="st">"natural"</span>)<span class="sc">$</span>y</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">sum</span>(f.true<span class="sc">&lt;</span> f.hat.up)<span class="sc">+</span><span class="fu">sum</span>(f.true<span class="sc">&gt;</span> f.hat.low) <span class="sc">==</span> <span class="dv">2</span><span class="sc">*</span>n.test){</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>          cpt <span class="ot">=</span> cpt<span class="sc">+</span><span class="dv">1</span>} </span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>      perf[L,ind.n] <span class="ot">=</span> cpt<span class="sc">/</span>nb.repeat</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>  perf <span class="ot">=</span> perf[vec.L,]</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(perf) <span class="ot">=</span> vec.L</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(perf) <span class="ot">=</span> vec.n</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(perf, <span class="at">file =</span> <span class="st">"res_Tab2.RData"</span>)</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {<span class="fu">load</span>(<span class="st">'res_Tab2.RData'</span>)}</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>perf <span class="sc">%&gt;%</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="st">"latex"</span>, <span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_header_above</span>(<span class="fu">c</span>(<span class="st">"L"</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">"n"</span> <span class="ot">=</span> <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tbl-levLstar" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-levLstar-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Illustrative example. We display the level of confidence for the proposed confidence band CB2, for several L in rows and several n in columns, N=40, for alpha=0.2 and beta=0.2 (and then in total the confidence band reaches the level 0.95), and considering the Legendre family.
</figcaption>
<div aria-describedby="tbl-levLstar-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">

</div>
</div>
</figure>
</div>
</div>
<p>We illustrate the different terms involved in <a href="#eq-def-Lhat" class="quarto-xref">Equation&nbsp;7</a>. In <a href="#fig-dLLmax" class="quarto-xref">Figure&nbsp;4</a>, we plot for a given dataset, the infinity norm of the width of the band <span class="math inline">\(\hat d^L(t) + \hat d^{L,L_{\max}}(t)\)</span> (top), of <span class="math inline">\(\hat d^L(t)\)</span> (middle) and <span class="math inline">\(\hat d^{L,L_{\max}}(t)\)</span> (bottom) functions obtained with the Fourier (left column), Legendre (middle column) and Spline (right column) basis. As already said, <span class="math inline">\(\|\hat d^L\|_{\infty}\)</span> increases with <span class="math inline">\(L\)</span> while <span class="math inline">\(\|\hat d^{L,L_{\max}}\|_{\infty}\)</span> decreases (and is zero when <span class="math inline">\(L&gt;L^{\varepsilon}\)</span>). The width of the band wrt <span class="math inline">\(L\)</span> does not have a <span class="math inline">\(U\)</span>-shape, as expected. It is thus difficult to minimize this criterion and the selection of <span class="math inline">\(\hat L\)</span> is thus not stable. But again, whatever the value of <span class="math inline">\(\hat L\)</span>, the corresponding band is debiased in the collection. <span style="color: red;">We will see in the next section that its width is smaller than standard approaches.</span> The performance of the selection is <span style="color: red;">also</span> illustrated in the next section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">Norm =</span> <span class="fu">double</span>(),</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">type =</span> <span class="fu">character</span>(),</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">basis =</span> <span class="fu">character</span>(),</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">dimension =</span> <span class="fu">integer</span>()</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>L.max <span class="ot">=</span> <span class="dv">30</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (basis <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"Legendre"</span>, <span class="st">"Fourier"</span>, <span class="st">"Splines"</span>)){</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  vec.L <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">3</span>,<span class="dv">29</span>, <span class="at">by=</span><span class="dv">1</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (basis <span class="sc">==</span> <span class="st">'Fourier'</span>){ vec.L <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">3</span>,<span class="dv">29</span>, <span class="at">by=</span><span class="dv">2</span>)}</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (basis <span class="sc">==</span> <span class="st">"Splines"</span>){   data <span class="ot">=</span> <span class="fu">dgp</span>(<span class="at">n=</span><span class="dv">50</span>,<span class="at">N=</span><span class="dv">40</span>, <span class="at">basis =</span> basis, <span class="at">sd =</span> <span class="dv">2</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> data <span class="ot">=</span> <span class="fu">dgp</span>(<span class="at">n=</span><span class="dv">50</span>,<span class="at">N=</span><span class="dv">40</span>, <span class="at">basis =</span> basis)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  length.band <span class="ot">=</span> d.L <span class="ot">=</span> d.L.Lmax <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (L <span class="cf">in</span> vec.L){</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    conf.band.L.star<span class="fl">.2</span> <span class="ot">=</span> <span class="fu">CB2</span>(data, basis, L, <span class="at">Lmax =</span> L.max, <span class="at">alpha =</span> <span class="fu">sqrt</span>(<span class="fl">0.05</span>), <span class="at">beta =</span> <span class="fu">sqrt</span>(<span class="fl">0.05</span>))</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    length.band <span class="ot">=</span> <span class="fu">c</span>(length.band, conf.band.L.star<span class="fl">.2</span><span class="sc">$</span>width)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    d.L <span class="ot">=</span> <span class="fu">c</span>(d.L, <span class="fu">max</span>(conf.band.L.star<span class="fl">.2</span><span class="sc">$</span>d.L))</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    d.L.Lmax <span class="ot">=</span> <span class="fu">c</span>(d.L.Lmax, <span class="fu">max</span>(conf.band.L.star<span class="fl">.2</span><span class="sc">$</span>d.L.Lmax))</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">=</span> <span class="fu">rbind</span>(df, <span class="fu">data.frame</span> (<span class="at">Norm =</span> <span class="fu">c</span>(length.band, d.L, d.L.Lmax),</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>                             <span class="at">type =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Band width norm"</span>, <span class="st">"d.L norm"</span>, <span class="st">"d.L.Lmax norm"</span>), <span class="at">each =</span> <span class="fu">length</span>(vec.L)),</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>                             <span class="at">basis =</span> <span class="fu">rep</span>(basis, <span class="dv">3</span><span class="sc">*</span> <span class="fu">length</span>(vec.L)),</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>                             <span class="at">dimension =</span> <span class="fu">rep</span>(vec.L, <span class="dv">3</span>)))</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> dimension, <span class="at">y =</span> Norm, <span class="at">fill =</span> type)) <span class="sc">+</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(type <span class="sc">~</span> basis, <span class="at">scales =</span> <span class="st">'free'</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"L"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-dLLmax" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dLLmax-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="ConfBand_files/figure-html/fig-dLLmax-1.png" style="height:50.0%" width="672" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dLLmax-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Illustrative example. For a given dataset, we calculate the norm of the width of the confidence band (top), of the dL function (middle) and the dLLmax function (bottom), for several dimensions L and for Fourier (left column), Legendre (middle column) and Splines (right column) basis.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="sec-simumodsel" class="level2">
<h2 class="anchored" data-anchor-id="sec-simumodsel">Model selection criterion</h2>
<p>We <span style="color: red;">want to</span> evaluate the performance of the <span style="color: red;">two</span> selection criteria introduced in this paper.</p>
<p><span style="color: red;">First, we consider the second approach presented in <strong>?@sec-modesel</strong>. </span> In <a href="#fig-critlast" class="quarto-xref">Figure&nbsp;5</a>, we illustrate the behavior of the selection criterion introduced in <a href="#sec-modsel" class="quarto-xref">Section&nbsp;5</a> on simulated data, with <span class="math inline">\(\lambda=1\)</span> for the three basis. We can see that <span class="math inline">\(\tilde L\)</span> is overestimated. When considering nested spaces, it ensures that <span class="math inline">\(\tilde L\)</span> tends to be larger than <span class="math inline">\(L^*\)</span> and thus the confidence band is automatically unbiased.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>L.max <span class="ot">=</span> <span class="dv">30</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>dfCriterion <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">criterion =</span> <span class="fu">double</span>(),</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">dimension =</span> <span class="fu">integer</span>(),</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">basis =</span> <span class="fu">character</span>())</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (basis <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"Legendre"</span>,<span class="st">"Fourier"</span>, <span class="st">"Splines"</span>)){</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  vec.L <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">3</span>,<span class="dv">29</span>, <span class="at">by=</span><span class="dv">1</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (basis <span class="sc">==</span> <span class="st">'Fourier'</span>){ vec.L <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">3</span>,<span class="dv">29</span>, <span class="at">by=</span><span class="dv">2</span>) }</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  length.band <span class="ot">=</span> c.L <span class="ot">=</span> c.L.Lmax <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (basis <span class="sc">==</span> <span class="st">"Splines"</span>){  data <span class="ot">=</span> <span class="fu">dgp</span>(<span class="at">n=</span><span class="dv">50</span>,<span class="at">N=</span><span class="dv">40</span>, <span class="at">basis =</span> basis, <span class="at">L.eps =</span> <span class="dv">28</span>, <span class="at">sd=</span><span class="dv">2</span>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {  data <span class="ot">=</span> <span class="fu">dgp</span>(<span class="at">n=</span><span class="dv">50</span>,<span class="at">N=</span><span class="dv">40</span>, <span class="at">basis =</span> basis, <span class="at">L.eps =</span> <span class="dv">28</span>, <span class="at">sd =</span> <span class="dv">1</span>)}</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  conf.band.L.max <span class="ot">=</span> <span class="fu">CB1</span>(data, basis, <span class="at">L =</span> L.max, <span class="at">alpha =</span> <span class="fl">0.05</span>)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  c.Lmax <span class="ot">=</span> conf.band.L.max<span class="sc">$</span>c.L </span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (L <span class="cf">in</span> vec.L){</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    conf.band.L <span class="ot">=</span> <span class="fu">CB1</span>(data, basis, L, <span class="at">alpha =</span> (<span class="fl">0.05</span>))</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    length.band[L] <span class="ot">=</span> conf.band.L<span class="sc">$</span>width</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    c.L[L] <span class="ot">=</span> <span class="fu">max</span>(conf.band.L<span class="sc">$</span>c.L)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (lambda <span class="cf">in</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">2</span>)){</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    crit <span class="ot">=</span> <span class="fu">abs</span>(<span class="fu">rep</span>(c.Lmax, <span class="fu">length</span>(vec.L)) <span class="sc">-</span> c.L[vec.L]) <span class="sc">+</span> lambda <span class="sc">*</span> vec.L<span class="sc">/</span>((<span class="fu">dim</span>(data<span class="sc">$</span>y)[<span class="dv">1</span>]))</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    dfCriterion <span class="ot">=</span> <span class="fu">rbind</span>(dfCriterion, <span class="fu">data.frame</span>(<span class="at">criterion =</span> crit,</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">dimension =</span> vec.L,</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">lambdas =</span> lambda,</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">basis =</span> <span class="fu">rep</span>(basis, <span class="fu">length</span>(vec.L))))</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dfCriterion, <span class="fu">aes</span>(<span class="at">x =</span> dimension, <span class="at">y =</span> criterion, <span class="at">color =</span> lambdas)) <span class="sc">+</span> </span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>basis)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-critlast" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-critlast-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="ConfBand_files/figure-html/fig-critlast-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-critlast-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Illustrative example. For a given simulated dataset, we show the behavior of the criteria as a function of dimension L, for several lambdas, for Fourier (left), Legendre (middle) and Splines (right) basis.
</figcaption>
</figure>
</div>
</div>
</div>
<p><span style="color: red;">We compare the two strategies <span class="math inline">\(CB_2\)</span> and <span class="math inline">\(CB_3\)</span> with some standard approaches. More precisely, </span> we simulate 100 repeated datasets. The different confidence bands and the norm of their widths are computed for several <span class="math inline">\(L\)</span>. We apply the selection criteria and plot the distribution of the estimated dimension in <a href="#fig-modelsel" class="quarto-xref">Figure&nbsp;6</a>, for the three basis families, for several model selection criteria: <span class="math inline">\(\hat L\)</span>, <span class="math inline">\(\tilde L\)</span>, cross validation and hard thresholding. The dimension <span class="math inline">\(\hat L\)</span> is almost always larger than the true <span class="math inline">\(L^*=11\)</span>. The fact that it is larger is not a problem because the selected band is unbiased and has the correct level as soon as <span class="math inline">\(L^\varepsilon\)</span> is large. However, the criterion tends to select a band that is (too) smooth. We can see that the selected dimension <span class="math inline">\(\tilde{L}\)</span> is smaller in distribution, and closer to the true value than <span class="math inline">\(\hat{L}\)</span>. In addition, as we then use the confidence band of <a href="#sec-bandSun" class="quarto-xref">Section&nbsp;3</a>, the confidence level is guaranteed to be as expected. The model selected by cross validation is rather good, for all the basis considered. On the other hand, the model selected by hard thresholding is not good, particularly for a non orthonormal basis, which makes sense in relation to <a href="#prp-proj" class="quarto-xref">Proposition&nbsp;1</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#| </span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>run <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (run <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  repet <span class="ot">=</span> <span class="dv">100</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  length.CBL.CV <span class="ot">=</span> length.CBL.L0 <span class="ot">=</span> <span class="fu">c</span>(<span class="cn">NA</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  dfLengthSelect.CV <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">length =</span> <span class="fu">double</span>(), <span class="at">basis =</span> <span class="fu">character</span>())</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  dfLhatSelect.CV <span class="ot">=</span> dfLhatSelect.L0 <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">Lhat =</span> <span class="fu">double</span>(), <span class="at">L =</span> <span class="fu">integer</span>(), <span class="at">basis =</span> <span class="fu">character</span>())</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  dfBandWidth <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">Band.width =</span> <span class="fu">double</span>(),</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>                           <span class="at">basis =</span> <span class="fu">character</span>(),</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>                           <span class="at">dimension =</span> <span class="fu">integer</span>())</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  dfLhat <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">Lhat =</span> <span class="fu">double</span>(), <span class="at">L =</span> <span class="fu">integer</span>(), <span class="at">basis =</span> <span class="fu">character</span>())</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  ind.basis <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  cpt <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="dv">6</span>, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (basis <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"Legendre"</span>, <span class="st">"Fourier"</span>, <span class="st">"Splines"</span>)){</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    ind.basis <span class="ot">=</span> ind.basis <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    vec.L <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">3</span>,<span class="dv">29</span>, <span class="at">by=</span><span class="dv">1</span>)</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    mod.sel <span class="ot">=</span> mod.sel.L0 <span class="ot">=</span> mod.sel.CV <span class="ot">=</span> coeff.L0 <span class="ot">=</span> err <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (basis <span class="sc">==</span> <span class="st">'Fourier'</span>){ vec.L <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">3</span>,<span class="dv">29</span>, <span class="at">by=</span><span class="dv">2</span>)}</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    mod.sel <span class="ot">=</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> repet, <span class="at">ncol =</span> <span class="dv">5</span>)</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    L.mod.sel <span class="ot">=</span> c.L <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    Lmax <span class="ot">=</span> <span class="dv">30</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    ind <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (rep <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>repet){<span class="fu">print</span>(rep)</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set.seed</span>(rep)</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (basis <span class="sc">==</span> <span class="st">"Splines"</span>){      data <span class="ot">=</span> <span class="fu">dgp</span>(<span class="at">n=</span><span class="dv">50</span>, <span class="at">N=</span><span class="dv">40</span>, <span class="at">basis =</span> basis, <span class="at">sd =</span> <span class="dv">2</span>)</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span>  {data <span class="ot">=</span> <span class="fu">dgp</span>(<span class="at">n=</span><span class="dv">50</span>, <span class="at">N=</span><span class="dv">40</span>, <span class="at">basis =</span> basis)}</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>      length.band <span class="ot">=</span> <span class="cn">NULL</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>      data.train <span class="ot">=</span> data.test <span class="ot">=</span> data</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>      data.train<span class="sc">$</span>y <span class="ot">=</span> data<span class="sc">$</span>y[, <span class="dv">1</span><span class="sc">:</span>(<span class="fu">dim</span>(data<span class="sc">$</span>y)[<span class="dv">2</span>]<span class="sc">/</span><span class="dv">2</span>)]</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>      data.test<span class="sc">$</span>y <span class="ot">=</span> data<span class="sc">$</span>y[,(<span class="fu">dim</span>(data<span class="sc">$</span>y)[<span class="dv">2</span>]<span class="sc">/</span><span class="dv">2</span><span class="sc">+</span><span class="dv">1</span>) <span class="sc">:</span> (<span class="fu">dim</span>(data<span class="sc">$</span>y)[<span class="dv">2</span>])]</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>      tot.VC <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">each =</span> <span class="fu">dim</span>(data.train<span class="sc">$</span>y)[<span class="dv">2</span>] <span class="sc">/</span> <span class="dv">10</span>)</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>      err <span class="ot">&lt;-</span> <span class="fu">sapply</span>(vec.L, <span class="cf">function</span>(L) {</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mean</span>(<span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="cf">function</span>(VC) {</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>          train <span class="ot">&lt;-</span> data.train</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>          train<span class="sc">$</span>y <span class="ot">&lt;-</span> train<span class="sc">$</span>y[,<span class="sc">-</span><span class="fu">which</span>(tot.VC <span class="sc">==</span> VC)]</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>          test <span class="ot">&lt;-</span> data.train</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>          test<span class="sc">$</span>y <span class="ot">&lt;-</span> test<span class="sc">$</span>y[, <span class="fu">which</span>(tot.VC <span class="sc">==</span> VC)]</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>          est.L <span class="ot">&lt;-</span> <span class="fu">estimator</span>(train, basis, L)</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>          <span class="fu">sqrt</span>(<span class="fu">mean</span>((test<span class="sc">$</span>y <span class="sc">-</span> est.L<span class="sc">$</span>f.hat)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (L <span class="cf">in</span> vec.L){</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>        CB2.L <span class="ot">=</span> <span class="fu">CB2</span>(data, <span class="at">basis =</span> basis, L, <span class="at">Lmax =</span> <span class="dv">30</span>, <span class="at">alpha =</span> <span class="fu">sqrt</span>(<span class="fl">0.05</span>), <span class="at">beta =</span> <span class="fu">sqrt</span>(<span class="fl">0.05</span>))</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>        length.band <span class="ot">=</span> <span class="fu">c</span>(length.band, CB2.L<span class="sc">$</span>width)</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>        conf.band.L <span class="ot">=</span> <span class="fu">CB1</span>(data, basis, L, <span class="at">alpha =</span> (<span class="fl">0.05</span>))</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>        c.L[L] <span class="ot">=</span> <span class="fu">max</span>(conf.band.L<span class="sc">$</span>c.L)</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>        est.L <span class="ot">=</span> <span class="fu">estimator</span>(data.train, basis, L)</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>        coeff.L0[L] <span class="ot">=</span> <span class="fu">sum</span>(<span class="fu">abs</span>(est.L<span class="sc">$</span>mu.hat) <span class="sc">&gt;</span> <span class="fl">0.1</span>)</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>      mod.sel[rep,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">min</span>(length.band), vec.L[<span class="fu">which.min</span>(length.band)])</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>      CB2.Lhat <span class="ot">=</span> <span class="fu">CB2</span>(data, <span class="at">basis =</span> basis, mod.sel[rep,<span class="dv">2</span>], <span class="at">Lmax =</span> <span class="dv">30</span>, <span class="at">alpha =</span> <span class="fu">sqrt</span>(<span class="fl">0.05</span>), <span class="at">beta =</span> <span class="fu">sqrt</span>(<span class="fl">0.05</span>))</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>      conf.band.L.max <span class="ot">=</span> <span class="fu">CB1</span>(data, basis, <span class="at">L =</span> Lmax, <span class="at">alpha =</span> <span class="fl">0.05</span>)</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>      c.Lmax <span class="ot">=</span> conf.band.L.max<span class="sc">$</span>c.L </span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>      mod.sel[rep,<span class="dv">3</span>] <span class="ot">=</span> conf.band.L.max<span class="sc">$</span>width</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>      conf.band.L.star <span class="ot">=</span> <span class="fu">CB1</span>(data, basis, <span class="at">L =</span> <span class="dv">11</span>, <span class="at">alpha =</span> <span class="fl">0.05</span>)</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>      mod.sel[rep,<span class="dv">4</span>] <span class="ot">=</span> conf.band.L.star<span class="sc">$</span>width</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>      lambda <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>      crit <span class="ot">=</span> <span class="fu">abs</span>(<span class="fu">rep</span>(c.Lmax, <span class="fu">length</span>(vec.L)) <span class="sc">-</span> c.L[vec.L]) <span class="sc">+</span> lambda <span class="sc">*</span> vec.L<span class="sc">/</span>((<span class="fu">dim</span>(data<span class="sc">$</span>y)[<span class="dv">1</span>]))</span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>      L.mod.sel[rep] <span class="ot">=</span> vec.L[<span class="fu">which.min</span>(crit)]</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>      CB3 <span class="ot">=</span> <span class="fu">CB1</span>(data, basis, <span class="at">L =</span> L.mod.sel[rep], <span class="at">alpha =</span> <span class="fl">0.05</span>)</span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>      mod.sel[rep,<span class="dv">5</span>] <span class="ot">=</span> CB3<span class="sc">$</span>width</span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>      mod.sel.CV[rep] <span class="ot">=</span> vec.L[<span class="fu">which.min</span>(err)]</span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>      conf.band.CV <span class="ot">=</span> <span class="fu">CB1</span>(data.test, basis, mod.sel.CV[rep], <span class="at">alpha =</span> (<span class="fl">0.05</span>))</span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>      length.CBL.CV[rep] <span class="ot">=</span> conf.band.CV<span class="sc">$</span>width</span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>      mod.sel.L0[rep] <span class="ot">=</span> <span class="fu">max</span>(coeff.L0, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>      conf.band.L0 <span class="ot">=</span> <span class="fu">CB1</span>(data.test, basis, mod.sel.L0[rep], <span class="at">alpha =</span> (<span class="fl">0.05</span>))</span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>      length.CBL.L0[rep] <span class="ot">=</span> conf.band.L0<span class="sc">$</span>width</span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>      <span class="do">## coverage</span></span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>      n.test <span class="ot">=</span> <span class="dv">5000</span></span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>      time <span class="ot">=</span> <span class="fu">seq</span>(<span class="fu">min</span>(data<span class="sc">$</span>time), <span class="fu">max</span>(data<span class="sc">$</span>time), <span class="at">length.out =</span> n.test)</span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>      f.true <span class="ot">=</span> stats<span class="sc">::</span><span class="fu">spline</span>(<span class="at">x =</span> data<span class="sc">$</span>time, <span class="at">y =</span> data<span class="sc">$</span>f.true, <span class="at">xout =</span> time, <span class="at">method =</span> <span class="st">"natural"</span>)<span class="sc">$</span>y</span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>      models <span class="ot">=</span> <span class="fu">list</span>(CB2.Lhat, conf.band.L.max, conf.band.L.star, CB3, conf.band.CV, conf.band.L0)</span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (mod <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>){</span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>        f.hat.up <span class="ot">=</span> stats<span class="sc">::</span><span class="fu">spline</span>(<span class="at">x =</span> data<span class="sc">$</span>time, <span class="at">y =</span> models[[mod]]<span class="sc">$</span>f.hat.up, <span class="at">xout =</span> time, <span class="at">method =</span> <span class="st">"natural"</span>)<span class="sc">$</span>y</span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>        f.hat.low <span class="ot">=</span> stats<span class="sc">::</span><span class="fu">spline</span>(<span class="at">x =</span> data<span class="sc">$</span>time, <span class="at">y =</span> models[[mod]]<span class="sc">$</span>f.hat.low, <span class="at">xout =</span> time, <span class="at">method =</span> <span class="st">"natural"</span>)<span class="sc">$</span>y</span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">sum</span>(f.true<span class="sc">&lt;</span> f.hat.up)<span class="sc">+</span><span class="fu">sum</span>(f.true<span class="sc">&gt;</span> f.hat.low) <span class="sc">==</span> <span class="dv">2</span><span class="sc">*</span>n.test){cpt[mod,ind.basis] <span class="ot">=</span> cpt[mod,ind.basis] <span class="sc">+</span><span class="dv">1</span></span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> { <span class="cf">if</span>(mod <span class="sc">==</span> <span class="dv">4</span>){ind <span class="ot">=</span> <span class="fu">c</span>(ind, rep)}}</span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a>    dfBandWidth <span class="ot">=</span> <span class="fu">rbind</span>(dfBandWidth, <span class="fu">data.frame</span>(<span class="at">Band.width =</span> <span class="fu">c</span>(mod.sel[ ,<span class="dv">1</span>], mod.sel[ ,<span class="dv">3</span>], mod.sel[ ,<span class="dv">4</span>], mod.sel[ ,<span class="dv">5</span>], length.CBL.CV, length.CBL.L0),</span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">basis =</span> <span class="fu">rep</span>(basis, repet<span class="sc">*</span><span class="dv">6</span>), <span class="at">dimension =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Lhat"</span>, <span class="st">"Lmax"</span>, <span class="st">"Lstar"</span>,<span class="st">"Ltilde"</span>, <span class="st">"L.CV"</span>, <span class="st">"L.L0"</span>), </span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a>                                                                                             <span class="at">each =</span> repet))) </span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a>    dfLhat <span class="ot">=</span> <span class="fu">rbind</span>(dfLhat, <span class="fu">data.frame</span>(</span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a>      <span class="at">L =</span> vec.L,</span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a>      <span class="at">Lhat =</span> <span class="fu">matrix</span>(<span class="fu">table</span>(<span class="fu">factor</span>(mod.sel[,<span class="dv">2</span>], <span class="at">levels =</span> vec.L))),</span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a>      <span class="at">Lhat.CV =</span> <span class="fu">matrix</span>(<span class="fu">table</span>(<span class="fu">factor</span>(mod.sel.CV, <span class="at">levels =</span> vec.L))),      </span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a>      <span class="at">Lhat.L0 =</span> <span class="fu">matrix</span>(<span class="fu">table</span>(<span class="fu">factor</span>(mod.sel.L0, <span class="at">levels =</span> vec.L))),</span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a>      <span class="at">L.tilde =</span> <span class="fu">matrix</span>(<span class="fu">table</span>(<span class="fu">factor</span>(L.mod.sel, <span class="at">levels =</span> vec.L))),</span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a>      <span class="at">basis =</span> <span class="fu">rep</span>(basis, <span class="fu">length</span>(vec.L))))</span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a>  cpt <span class="ot">=</span> cpt<span class="sc">/</span>repet</span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(cpt, <span class="at">file =</span> <span class="st">"Res_Tab4.RData"</span>)</span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(dfBandWidth, <span class="at">file =</span> <span class="st">"Res_Tab3_BandWidth.RData"</span>)</span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(dfLhat, <span class="at">file =</span> <span class="st">"Res_Tab3_Lhat.RData"</span>)</span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">'Res_Tab4.RData'</span>)}</span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a><span class="fu">row.names</span>(cpt) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"L hat"</span>, <span class="st">"Lmax"</span>, <span class="st">"Lstar"</span>, <span class="st">"Ltilde"</span>, <span class="st">"L.CV"</span>, <span class="st">"L.L0"</span>)</span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true" tabindex="-1"></a>cpt <span class="sc">%&gt;%</span></span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="st">"latex"</span>, <span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_header_above</span>(<span class="fu">c</span>(<span class="st">"model"</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">"Legendre"</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">"Fourier"</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">"Splines"</span> <span class="ot">=</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tbl-levLstar2" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-levLstar2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3: Illustrative example. We display the level of confidence over 100 repetitions for the proposed confidence band CB3, for several model selection criterion in rows and several basis in columns, for alpha=0.05.
</figcaption>
<div aria-describedby="tbl-levLstar2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">

</div>
</div>
</figure>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">'Res_Tab3_Lhat.RData'</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> dfLhat, <span class="fu">aes</span>(<span class="at">x =</span> L, <span class="at">y =</span> Lhat)) <span class="sc">+</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span><span class="st">"identity"</span>)<span class="sc">+</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>basis)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> dfLhat, <span class="fu">aes</span>(<span class="at">x =</span> L, <span class="at">y =</span> L.tilde)) <span class="sc">+</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span><span class="st">"identity"</span>)<span class="sc">+</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>basis)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> dfLhat, <span class="fu">aes</span>(<span class="at">x =</span> L, <span class="at">y =</span> Lhat.CV)) <span class="sc">+</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span><span class="st">"identity"</span>)<span class="sc">+</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>basis)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> dfLhat, <span class="fu">aes</span>(<span class="at">x =</span> L, <span class="at">y =</span> Lhat.L0)) <span class="sc">+</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span><span class="st">"identity"</span>)<span class="sc">+</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span>basis)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1, p2, p3, p4, <span class="at">nrow =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-modelsel" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-modelsel-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="ConfBand_files/figure-html/fig-modelsel-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-modelsel-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Illustrative example with <span class="math inline">\(N=40\)</span>. From 100 datasets, we calculate the distribution of the estimated dimension L, for four model selection criteria: from top to bottom, the debiased band proposed in CB2 with Lhat, the band CB3 with Ltilde, the cross validation and hard thresholding methods. The true dimension is <span class="math inline">\(L^* = 11\)</span>.
</figcaption>
</figure>
</div>
</div>
</div>
<p>The reformulation of the band around <span class="math inline">\(\underline{\hat f}_2^{ L_{\max}, L^*}\)</span> is close to the band presented in <a href="#sec-bandSun" class="quarto-xref">Section&nbsp;3</a> for <span class="math inline">\(L=L_{\max}\)</span>, that is a band centered around <span class="math inline">\(\underline{\hat f}^{ L_{\max}, L^*}\)</span>. A natural question is to understand what is the gain by doing so instead of using the band from <a href="#sec-bandSun" class="quarto-xref">Section&nbsp;3</a> with <span class="math inline">\(L=L_{\max}\)</span>, namely the band <span class="math inline">\(\left [\underline{\hat f}^{ L_{\max}, L^*}(t)-\hat d^{L_{\max}}(t); \underline{\hat f}^{ L_{\max}, L^*}(t)+\hat d^{L_{\max}}(t)\right]\)</span>. To do that, we have to understand the behavior of the different terms. As it is difficult to compare theoretically the width of the two bands, we compare them using simulations. For 100 repeated datasets, we compute several confidence bands: the <span class="math inline">\(CB_1\)</span> band constructed in <a href="#sec-bandSun" class="quarto-xref">Section&nbsp;3</a> with <span class="math inline">\(L_{\max}\)</span>, the <span class="math inline">\(CB_{2}\)</span> band defined in <a href="#prp-CBf" class="quarto-xref">Proposition&nbsp;5</a> with <span class="math inline">\(\hat L\)</span>, the <span class="math inline">\(CB_{3}\)</span> band defined in <a href="#sec-modsel" class="quarto-xref">Section&nbsp;5</a> with <span class="math inline">\(\tilde L\)</span> and the ideal (and not accessible) band constructed in <a href="#sec-bandSun" class="quarto-xref">Section&nbsp;3</a> with the true <span class="math inline">\(L^*\)</span>. In <a href="#fig-width-2" class="quarto-xref">Figure&nbsp;7</a>, we present boxplots of the norms of the band width with <span class="math inline">\(\hat L\)</span>, <span class="math inline">\(L_{\max}\)</span>, <span class="math inline">\(L^*\)</span> and <span class="math inline">\(\tilde{L}\)</span>. The width of the confidence band with the true <span class="math inline">\(L^*\)</span> is smaller, which is expected but unfortunately not achievable. The width of the confidence band <span class="math inline">\(CB_1\)</span> is smaller than that of the band <span class="math inline">\(CB_2\)</span>. This can be explained by the fact that we estimate two different quantities, on smaller datasets, for more conservative levels (<span class="math inline">\(1-\alpha\)</span> and <span class="math inline">\(1-\beta\)</span> respectively) in order to finally achieve the confidence level of <span class="math inline">\(1-\alpha\beta\)</span>. This also explains why the cross validation and hard-thresholding methods, which also divide the sample into two parts, do not give good results either. The model given by the heuristic model selection criterion <span class="math inline">\(\tilde crit\)</span> achieves good performance. Note that the width of the selected model <span class="math inline">\(\tilde L\)</span> is better than the width of the confidence band with a large level <span class="math inline">\(L_{\max}\)</span>, which one should have used to avoid model selection.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">'Res_Tab3_BandWidth.RData'</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dfBandWidth, <span class="fu">aes</span>(<span class="at">x =</span> dimension, <span class="at">y =</span> Band.width)) <span class="sc">+</span> </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span> </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>basis, <span class="at">scales =</span> <span class="st">"free_y"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-width-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-width-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="ConfBand_files/figure-html/fig-width-2-1.png" style="height:25.0%" width="672" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-width-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Illustrative example. We display within boxplots the confidence band‚Äôs width over 100 repetitions for the dimension selected by the several criterion introduced in this paper, for Fourier (left), Legendre (middle) and Splines (right) basis.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="sec-gen" class="level2">
<h2 class="anchored" data-anchor-id="sec-gen">Generalization out of the model</h2>
<p>We now illustrate the behaviour of the bands when the basis used for estimation is poorly specified. We simulate 1000 data sets with a spline basis and estimate the confidence bands with the Fourier and Legendre basis, for different values of <span class="math inline">\(n\)</span> and <span class="math inline">\(N\)</span>. The coverage rates are presented in <a href="#tbl-levelL-2" class="quarto-xref">Table&nbsp;4</a>. The Fourier basis does not give a correct rate. On the other hand, the Legendre basis gives very satisfactory coverage rates for <span class="math inline">\(L&gt;20\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>run <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>vec.L <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>,<span class="dv">15</span>,<span class="dv">21</span>, <span class="dv">25</span>, <span class="dv">31</span>, <span class="dv">35</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>vec.n <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">150</span>) </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (run <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  nb.repeat <span class="ot">=</span> <span class="dv">1000</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  n.test <span class="ot">=</span> <span class="dv">5000</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  vec.n <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">150</span>) </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  vec.N <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">40</span>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  basis <span class="ot">=</span> <span class="st">"Splines"</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  basis<span class="fl">.2</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">'Fourier'</span>, <span class="st">'Legendre'</span>)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">=</span> <span class="fu">seq</span>(<span class="fu">min</span>(data<span class="sc">$</span>time), <span class="fu">max</span>(data<span class="sc">$</span>time), <span class="at">length.out =</span> n.test)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  perf <span class="ot">=</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">c</span>(<span class="fu">max</span>(vec.L),<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (ind.n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(vec.n)){</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (L <span class="cf">in</span> vec.L){</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (ind.N <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(vec.N)){</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (ind.basis <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>){</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>          cpt <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (rep <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nb.repeat){</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>            <span class="fu">set.seed</span>(rep)</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (basis <span class="sc">==</span> <span class="st">"Splines"</span>){</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>              data <span class="ot">=</span> <span class="fu">dgp</span>(<span class="at">n=</span>vec.n[ind.n], <span class="at">N =</span> vec.N[ind.N], <span class="at">basis =</span> basis, <span class="at">sd =</span> <span class="dv">2</span>)</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>            } <span class="cf">else</span> {data <span class="ot">=</span> <span class="fu">dgp</span>(<span class="at">n=</span>vec.n[ind.n], <span class="at">N =</span> vec.N[ind.N], <span class="at">basis =</span> basis)}</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>            conf.band <span class="ot">=</span> <span class="fu">CB1</span>(data, basis<span class="fl">.2</span>[ind.basis], L)</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (basis <span class="sc">==</span> <span class="st">'Fourier'</span>){</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> (L<span class="sc">%%</span><span class="dv">2</span> <span class="sc">==</span> <span class="dv">0</span>){ L <span class="ot">=</span> L<span class="sc">+</span><span class="dv">1</span>}</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>            B.old <span class="ot">=</span> <span class="fu">func.basis</span>(data<span class="sc">$</span>time, <span class="at">L =</span> <span class="dv">11</span>, basis)</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>            B <span class="ot">=</span> <span class="fu">func.basis</span>(time, <span class="at">L =</span> <span class="dv">11</span>, basis)</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>            f.true <span class="ot">=</span> <span class="fu">t</span>(B <span class="sc">%*%</span> <span class="fu">solve</span>(<span class="fu">t</span>(B.old) <span class="sc">%*%</span> B.old) <span class="sc">%*%</span> <span class="fu">t</span>(B.old) <span class="sc">%*%</span> data<span class="sc">$</span>f.true)</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>            f.hat.up <span class="ot">=</span> stats<span class="sc">::</span><span class="fu">spline</span>(<span class="at">x =</span> data<span class="sc">$</span>time, <span class="at">y =</span> conf.band<span class="sc">$</span>f.hat.up, <span class="at">xout =</span> time, <span class="at">method =</span> <span class="st">"natural"</span>)<span class="sc">$</span>y</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>            f.hat.low <span class="ot">=</span> stats<span class="sc">::</span><span class="fu">spline</span>(<span class="at">x =</span> data<span class="sc">$</span>time, <span class="at">y =</span> conf.band<span class="sc">$</span>f.hat.low, <span class="at">xout =</span> time, <span class="at">method =</span> <span class="st">"natural"</span>)<span class="sc">$</span>y</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="fu">sum</span>(f.true<span class="sc">&lt;</span> f.hat.up)<span class="sc">+</span><span class="fu">sum</span>(f.true<span class="sc">&gt;</span> f.hat.low) <span class="sc">==</span> <span class="dv">2</span><span class="sc">*</span>n.test){</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>              cpt <span class="ot">=</span> cpt<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>            } </span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>          perf[L,ind.n, ind.N, ind.basis] <span class="ot">=</span> cpt<span class="sc">/</span>nb.repeat</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(perf, <span class="at">file =</span> <span class="st">"Res_Tab_other.RData"</span>)</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {<span class="fu">load</span>(<span class="st">"Res_Tab_other.RData"</span>) } <span class="do">### charger les donn√©es</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>perf.Fourier <span class="ot">=</span> <span class="fu">cbind</span>(perf[vec.L,,<span class="dv">1</span>,<span class="dv">1</span>],perf[vec.L,,<span class="dv">2</span>,<span class="dv">1</span>])</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(perf.Fourier) <span class="ot">=</span> vec.L</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(perf.Fourier) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">" 50/10"</span>, <span class="st">"150/10"</span>, <span class="st">"50/40"</span>, <span class="st">"150/40"</span>)</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>perf.Fourier <span class="sc">%&gt;%</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="st">"latex"</span>, <span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_header_above</span>(<span class="fu">c</span>(<span class="st">"L"</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">"n/N"</span> <span class="ot">=</span> <span class="dv">4</span>))</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>pref.Legendre <span class="ot">=</span> <span class="fu">cbind</span>(perf[vec.L,,<span class="dv">1</span>,<span class="dv">2</span>],perf[vec.L,,<span class="dv">2</span>,<span class="dv">2</span>])</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(pref.Legendre) <span class="ot">=</span> vec.L</span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(pref.Legendre) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">" 50/10"</span>, <span class="st">"150/10"</span>, <span class="st">"50/40"</span>, <span class="st">"150/40"</span>)</span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>pref.Legendre <span class="sc">%&gt;%</span></span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="st">"latex"</span>, <span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_header_above</span>(<span class="fu">c</span>(<span class="st">"L"</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">"n/N"</span> <span class="ot">=</span> <span class="dv">4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tbl-levelL-2" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-levelL-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;4: Illustrative example. The confidence level of the confidence band is evaluated from 1000 repetitions. Data is generated using a Splines basis, and confidence bands are calculated with the Fourier (a) and Legendre (b) families, for several L in rows and several n and N in columns.
</figcaption>
<div aria-describedby="tbl-levelL-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">

</div>
<div class="cell-output-display">

</div>
</div>
</figure>
</div>
</div>
<p>Next, we illustrate the <span class="math inline">\(\tilde L\)</span> dimension selection method and compare it to the cross-validation method. <a href="#tbl-levelL-3" class="quarto-xref">Table&nbsp;5</a> presents the coverage rates of the corresponding confidence bands estimated with the Fourier and Legendre basis, in the case <span class="math inline">\(N=40\)</span> and <span class="math inline">\(n=150\)</span>. Once again, we see that the Fourier basis does not give good results, either by cross-validation or by <span class="math inline">\(\tilde L\)</span>. On the other hand, with the Legendre basis, the <span class="math inline">\(\tilde L\)</span> method gives a satisfactory coverage rate, even if it is underestimated, whereas the cross-validation method is very poor. Moreover, the widths of the confidence bands selected with <span class="math inline">\(\tilde L\)</span> and by cross validation are represented by boxplot in <a href="#fig-width-3" class="quarto-xref">Figure&nbsp;8</a>. It can be seen that the cross-validation approach provides wider bands, even though their confidence level is not guaranteed. The method proposed in this paper provides a narrower band with a correct level of confidence. We thus recommend to use the Legendre family with the criteria <span class="math inline">\(\tilde L\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>run <span class="ot">=</span> <span class="cn">FALSE</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>vec.L <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">11</span>,<span class="dv">15</span>,<span class="dv">21</span>, <span class="dv">25</span>, <span class="dv">31</span>, <span class="dv">35</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>vec.n <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">150</span>) </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (run <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  nb.repeat <span class="ot">=</span> <span class="dv">100</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  n.test <span class="ot">=</span> <span class="dv">5000</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  vec.n <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">150</span>) </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  vec.N <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">40</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  basis <span class="ot">=</span> <span class="st">"Splines"</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  basis<span class="fl">.2</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">'Fourier'</span>, <span class="st">'Legendre'</span>)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">=</span> <span class="fu">seq</span>(<span class="fu">min</span>(data<span class="sc">$</span>time), <span class="fu">max</span>(data<span class="sc">$</span>time), <span class="at">length.out =</span> n.test)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  perf.sel <span class="ot">=</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  err <span class="ot">=</span> coeff.L0 <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  L.mod.sel <span class="ot">=</span> mod.sel.CV <span class="ot">=</span> length.CBL.CV <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  mod.sel <span class="ot">=</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> nb.repeat, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  width <span class="ot">=</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(<span class="dv">2</span>, nb.repeat))</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  dfBandWidth <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">Band.width =</span> <span class="fu">double</span>(),</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>                           <span class="at">basis =</span> <span class="fu">character</span>(),</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>                           <span class="at">dimension =</span> <span class="fu">integer</span>())</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (ind.n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(vec.n)){</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (ind.N <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(vec.N)){</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (ind.basis <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>){</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>        cpt <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (rep <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nb.repeat){</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>          <span class="fu">set.seed</span>(rep)</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (basis <span class="sc">==</span> <span class="st">"Splines"</span>){</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>            data <span class="ot">=</span> <span class="fu">dgp</span>(<span class="at">n=</span>vec.n[ind.n], <span class="at">N =</span> vec.N[ind.N], <span class="at">basis =</span> basis, <span class="at">sd =</span> <span class="dv">2</span>)</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {data <span class="ot">=</span> <span class="fu">dgp</span>(<span class="at">n=</span>vec.n[ind.n], <span class="at">N =</span> vec.N[ind.N], <span class="at">basis =</span> basis)}</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>          data.train <span class="ot">=</span> data</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>          data.train<span class="sc">$</span>y <span class="ot">=</span> data<span class="sc">$</span>y[, <span class="dv">1</span><span class="sc">:</span>(<span class="fu">dim</span>(data<span class="sc">$</span>y)[<span class="dv">2</span>]<span class="sc">/</span><span class="dv">2</span>)]</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>          data.test <span class="ot">=</span> data</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>          data.test<span class="sc">$</span>y <span class="ot">=</span> data<span class="sc">$</span>y[,(<span class="fu">dim</span>(data<span class="sc">$</span>y)[<span class="dv">2</span>]<span class="sc">/</span><span class="dv">2</span>) <span class="sc">:</span> (<span class="fu">dim</span>(data<span class="sc">$</span>y)[<span class="dv">2</span>])]</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>          tot.VC <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">each =</span> <span class="fu">dim</span>(data.train<span class="sc">$</span>y)[<span class="dv">2</span>] <span class="sc">/</span> <span class="dv">10</span>)</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>          err <span class="ot">&lt;-</span> <span class="fu">sapply</span>(vec.L, <span class="cf">function</span>(L) {</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mean</span>(<span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="cf">function</span>(VC) {</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>              train <span class="ot">&lt;-</span> data.train</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>              train<span class="sc">$</span>y <span class="ot">&lt;-</span> train<span class="sc">$</span>y[,<span class="sc">-</span><span class="fu">which</span>(tot.VC <span class="sc">==</span> VC)]</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>              test <span class="ot">&lt;-</span> data.train</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>              test<span class="sc">$</span>y <span class="ot">&lt;-</span> test<span class="sc">$</span>y[, <span class="fu">which</span>(tot.VC <span class="sc">==</span> VC)]</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>              est.L <span class="ot">&lt;-</span> <span class="fu">estimator</span>(train, basis, L)</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>              <span class="fu">sqrt</span>(<span class="fu">mean</span>((test<span class="sc">$</span>y <span class="sc">-</span> est.L<span class="sc">$</span>f.hat)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>            }))</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>          })</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (L <span class="cf">in</span> vec.L){</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>            CB2.L <span class="ot">=</span> <span class="fu">CB2</span>(data, <span class="at">basis =</span> basis, L, <span class="at">Lmax =</span> <span class="dv">30</span>, <span class="at">alpha =</span> <span class="fu">sqrt</span>(<span class="fl">0.05</span>), <span class="at">beta =</span> <span class="fu">sqrt</span>(<span class="fl">0.05</span>))</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>            length.band <span class="ot">=</span> <span class="fu">c</span>(length.band, CB2.L<span class="sc">$</span>width)</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>            conf.band.L <span class="ot">=</span> <span class="fu">CB1</span>(data, basis, L, <span class="at">alpha =</span> (<span class="fl">0.05</span>))</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>            c.L[L] <span class="ot">=</span> <span class="fu">max</span>(conf.band.L<span class="sc">$</span>c.L)</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>          mod.sel[rep,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">min</span>(length.band), vec.L[<span class="fu">which.min</span>(length.band)])</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>          lambda <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>          crit <span class="ot">=</span> <span class="fu">abs</span>(<span class="fu">rep</span>(c.Lmax, <span class="fu">length</span>(vec.L)) <span class="sc">-</span> c.L[vec.L]) <span class="sc">+</span> lambda <span class="sc">*</span> vec.L<span class="sc">/</span>((<span class="fu">dim</span>(data<span class="sc">$</span>y)[<span class="dv">1</span>]))</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>          L.mod.sel[rep] <span class="ot">=</span> vec.L[<span class="fu">which.min</span>(crit)]</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>          CB3 <span class="ot">=</span> <span class="fu">CB1</span>(data, <span class="at">basis =</span> basis<span class="fl">.2</span>[ind.basis], <span class="at">L =</span> L.mod.sel[rep], <span class="at">alpha =</span> <span class="fl">0.05</span>)</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>          mod.sel.CV[rep] <span class="ot">=</span> vec.L[<span class="fu">which.min</span>(err)]</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>          conf.band.CV <span class="ot">=</span> <span class="fu">CB1</span>(data.test, <span class="at">basis =</span> basis<span class="fl">.2</span>[ind.basis], mod.sel.CV[rep], <span class="at">alpha =</span> (<span class="fl">0.05</span>))</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>          <span class="do">## coverage</span></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>          n.test <span class="ot">=</span> <span class="dv">5000</span></span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>          time <span class="ot">=</span> <span class="fu">seq</span>(<span class="fu">min</span>(data<span class="sc">$</span>time), <span class="fu">max</span>(data<span class="sc">$</span>time), <span class="at">length.out =</span> n.test)</span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>          B.old <span class="ot">=</span> <span class="fu">func.basis</span>(data<span class="sc">$</span>time, <span class="at">L =</span> <span class="dv">11</span>, basis)</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>          B <span class="ot">=</span> <span class="fu">func.basis</span>(time, <span class="at">L =</span> <span class="dv">11</span>, basis)</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>          f.true <span class="ot">=</span> <span class="fu">t</span>(B <span class="sc">%*%</span> <span class="fu">solve</span>(<span class="fu">t</span>(B.old) <span class="sc">%*%</span> B.old) <span class="sc">%*%</span> <span class="fu">t</span>(B.old) <span class="sc">%*%</span> data<span class="sc">$</span>f.true)</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>          models <span class="ot">=</span> <span class="fu">list</span>(CB3, conf.band.CV)</span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>          width[<span class="dv">1</span>,rep] <span class="ot">=</span> CB3<span class="sc">$</span>width</span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>          width[<span class="dv">2</span>,rep] <span class="ot">=</span> conf.band.CV<span class="sc">$</span>width</span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (mod <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>){</span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>            f.hat.up <span class="ot">=</span> stats<span class="sc">::</span><span class="fu">spline</span>(<span class="at">x =</span> data<span class="sc">$</span>time, <span class="at">y =</span> models[[mod]]<span class="sc">$</span>f.hat.up, <span class="at">xout =</span> time, <span class="at">method =</span> <span class="st">"natural"</span>)<span class="sc">$</span>y</span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>            f.hat.low <span class="ot">=</span> stats<span class="sc">::</span><span class="fu">spline</span>(<span class="at">x =</span> data<span class="sc">$</span>time, <span class="at">y =</span> models[[mod]]<span class="sc">$</span>f.hat.low, <span class="at">xout =</span> time, <span class="at">method =</span> <span class="st">"natural"</span>)<span class="sc">$</span>y</span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="fu">sum</span>(f.true<span class="sc">&lt;</span> f.hat.up)<span class="sc">+</span><span class="fu">sum</span>(f.true<span class="sc">&gt;</span> f.hat.low) <span class="sc">==</span> <span class="dv">2</span><span class="sc">*</span>n.test){perf.sel[mod,ind.n, ind.N, ind.basis] <span class="ot">=</span> perf.sel[mod,ind.n, ind.N, ind.basis] <span class="sc">+</span><span class="dv">1</span>}</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>        dfBandWidth <span class="ot">=</span> <span class="fu">rbind</span>(dfBandWidth, <span class="fu">data.frame</span>(<span class="at">Band.width =</span> <span class="fu">c</span>(width[<span class="dv">1</span>,], width[<span class="dv">2</span>,]),</span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">basis =</span> <span class="fu">rep</span>(basis<span class="fl">.2</span>[ind.basis], nb.repeat<span class="sc">*</span><span class="dv">2</span>), <span class="at">dimension =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"L tilde"</span>, <span class="st">"L.CV"</span>), </span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>                                                                                             <span class="at">each =</span> nb.repeat))) </span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>  perf.sel <span class="ot">=</span> perf.sel <span class="sc">/</span> nb.repeat  </span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(perf.sel, <span class="at">file =</span> <span class="st">"Res_Tab_other_2.RData"</span>)</span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(dfBandWidth, <span class="at">file =</span> <span class="st">"Red_Tab_other_2_width.RData"</span>)</span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {<span class="fu">load</span>(<span class="st">"Res_Tab_other_2.RData"</span>) } <span class="do">### charger les donn√©es</span></span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a>perf.Fourier <span class="ot">=</span> <span class="fu">matrix</span>(perf.sel[,,,<span class="dv">1</span>], <span class="at">nrow=</span><span class="dv">2</span>, <span class="at">ncol=</span><span class="dv">1</span>)</span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(perf.Fourier) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">'L tilde'</span>, <span class="st">'L.CV'</span>)</span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a>perf.Fourier <span class="sc">%&gt;%</span></span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="st">"latex"</span>, <span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_header_above</span>(<span class="fu">c</span>(<span class="st">"L"</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">"n=150, N=40"</span> <span class="ot">=</span> <span class="dv">1</span>))</span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a>pref.Splines <span class="ot">=</span> <span class="fu">matrix</span>(perf.sel[,,<span class="dv">1</span>,<span class="dv">2</span>], <span class="at">nrow=</span><span class="dv">2</span>, <span class="at">ncol=</span><span class="dv">1</span>)</span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(pref.Splines) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">'L tilde'</span>, <span class="st">'L.CV'</span>)</span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a>pref.Splines <span class="sc">%&gt;%</span></span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="st">"latex"</span>, <span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_header_above</span>(<span class="fu">c</span>(<span class="st">"L"</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">"n=150, N=40"</span> <span class="ot">=</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tbl-levelL-3" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-levelL-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;5: Illustrative example. The confidence level of the confidence band is evaluated from 100 repetitions. Data is generated using a Splines basis, and confidence bands are calculated with the Fourier (a) and Legendre (b) families, for several model selection criterion in rows, L in rows and several n and N in columns.
</figcaption>
<div aria-describedby="tbl-levelL-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">

</div>
<div class="cell-output-display">

</div>
</div>
</figure>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"Red_Tab_other_2_width.RData"</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dfBandWidth, <span class="fu">aes</span>(<span class="at">x =</span> dimension, <span class="at">y =</span> Band.width)) <span class="sc">+</span> </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span> </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>basis, <span class="at">scales =</span> <span class="st">"free_y"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-width-3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-width-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="ConfBand_files/figure-html/fig-width-3-1.png" style="height:25.0%" width="672" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-width-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Illustrative example. The confidence level of the confidence band is evaluated from 100 repetitions. Data is generated using a Splines basis, and confidence bands are calculated with the Fourier (a) and Legendre (b) families, for several model selection criterion in rows, L in rows and several n and N in columns.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="sec-realdata" class="level1">
<h1>Real data analysis</h1>
<p>In this section, we illustrate the proposed method on the Berkeley Growth Study data. It consists of the heights in centimeters of 39 boys at 31 ages from 1 to 18. We approximate these curves by the 3 basis Legendre, Splines and Fourier. We select the level of each basis using the method introduced in <a href="#sec-modsel" class="quarto-xref">Section&nbsp;5</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(growth)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>time <span class="ot">=</span> (growth<span class="sc">$</span>age <span class="sc">-</span> <span class="fu">min</span>(growth<span class="sc">$</span>age))<span class="sc">/</span>(<span class="fu">max</span>(growth<span class="sc">$</span>age) <span class="sc">-</span> <span class="fu">min</span>(growth<span class="sc">$</span>age))</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>y <span class="ot">=</span> growth<span class="sc">$</span>hgtm</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>L.max <span class="ot">=</span> <span class="dv">25</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>vec.L <span class="ot">=</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">24</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">=</span> <span class="fl">0.2</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>dfBandlow <span class="ot">=</span> dfBandup <span class="ot">=</span> df.max <span class="ot">=</span> res_growth <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (basis <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"Legendre"</span>, <span class="st">"Splines"</span>, <span class="st">"Fourier"</span>)){</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  mod.sel<span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (basis <span class="sc">==</span> <span class="st">'Fourier'</span>){vec.L <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">3</span>,<span class="dv">24</span>, <span class="at">by=</span><span class="dv">2</span>)}</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  c.L <span class="ot">=</span> c.L.Lmax <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  conf.band.L.max <span class="ot">=</span> <span class="fu">CB1</span>(data, basis, <span class="at">L =</span> L.max, <span class="at">alpha =</span> alpha)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  c.L.Lmax <span class="ot">=</span> <span class="fu">max</span>(conf.band.L.max<span class="sc">$</span>c.L)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  df.max <span class="ot">=</span> <span class="fu">rbind</span>(df.max, <span class="fu">data.frame</span>(<span class="at">Time =</span> growth<span class="sc">$</span>age, </span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">band.up =</span> <span class="fu">t</span>(conf.band.L.max<span class="sc">$</span>f.hat.up),</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">band.low =</span> <span class="fu">t</span>(conf.band.L.max<span class="sc">$</span>f.hat.low),</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">basis =</span> <span class="fu">rep</span>(basis, <span class="fu">length</span>(data<span class="sc">$</span>time))))</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (L <span class="cf">in</span> vec.L){</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    conf.band.L <span class="ot">=</span> <span class="fu">CB1</span>(data, basis, L, <span class="at">alpha =</span> (alpha))</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    c.L[L] <span class="ot">=</span> <span class="fu">max</span>(conf.band.L<span class="sc">$</span>c.L)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>  lambda <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>  crit <span class="ot">=</span> <span class="fu">abs</span>(<span class="fu">rep</span>(c.Lmax, <span class="fu">length</span>(vec.L)) <span class="sc">-</span> c.L[vec.L]) <span class="sc">+</span> lambda <span class="sc">*</span> vec.L<span class="sc">/</span>((<span class="fu">dim</span>(data<span class="sc">$</span>y)[<span class="dv">1</span>]))</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>  mod.sel <span class="ot">=</span> vec.L[<span class="fu">which.min</span>(crit)]</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(paste0('model selected:', mod.sel))</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>  conf.band.L.star<span class="fl">.2</span> <span class="ot">=</span> <span class="fu">CB1</span>(data, basis, mod.sel, <span class="at">alpha =</span> alpha)</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>  dfBandup <span class="ot">=</span> <span class="fu">rbind</span>(dfBandup, <span class="fu">data.frame</span>(<span class="at">Time =</span> growth<span class="sc">$</span>age,</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">bandup =</span> <span class="fu">t</span>(conf.band.L.star<span class="fl">.2</span><span class="sc">$</span>f.hat.up),</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">basis =</span> <span class="fu">rep</span>(basis, <span class="fu">length</span>(data<span class="sc">$</span>time))))</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>  dfBandlow <span class="ot">=</span> <span class="fu">rbind</span>(dfBandlow, <span class="fu">data.frame</span>(<span class="at">Time =</span> growth<span class="sc">$</span>age,</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">bandlow =</span> <span class="fu">t</span>(conf.band.L.star<span class="fl">.2</span><span class="sc">$</span>f.hat.low),</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">basis =</span> <span class="fu">rep</span>(basis, <span class="fu">length</span>(data<span class="sc">$</span>time))))</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(paste0('length L sel:', conf.band.L.star.2$c.L))</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>  res_growth <span class="ot">=</span> <span class="fu">round</span>(<span class="fu">cbind</span>(res_growth, <span class="fu">c</span>(conf.band.L.max<span class="sc">$</span>c.L, conf.band.L.star<span class="fl">.2</span><span class="sc">$</span>c.L, mod.sel)),<span class="dv">2</span>)</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(res_growth) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Legendre"</span>, <span class="st">"Splines"</span>, <span class="st">"Fourier"</span>)</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a><span class="fu">row.names</span>(res_growth) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Width Lmax"</span>, <span class="st">"Width selected"</span>, <span class="st">"Model selected"</span>)</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>df.data <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">Time =</span> <span class="fu">rep</span>(growth<span class="sc">$</span>age,<span class="fu">dim</span>(data<span class="sc">$</span>y)[<span class="dv">2</span>]), <span class="at">f =</span> <span class="fu">c</span>(data<span class="sc">$</span>y), <span class="at">ind =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>(<span class="fu">dim</span>(data<span class="sc">$</span>y)[<span class="dv">2</span>]), <span class="at">each =</span> <span class="fu">dim</span>(data<span class="sc">$</span>y)[<span class="dv">1</span>]))</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>()<span class="sc">+</span> <span class="fu">geom_line</span>(<span class="at">data=</span>df.data, <span class="fu">aes</span>(<span class="at">x=</span>Time, <span class="at">y =</span>f, <span class="at">group=</span>ind), <span class="at">color =</span> <span class="st">"lightgrey"</span>,<span class="at">linewidth=</span> <span class="fl">0.5</span>)<span class="sc">+</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> dfBandup, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> bandup,<span class="at">col =</span> basis, <span class="at">group =</span> basis), <span class="at">linewidth =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> dfBandlow, <span class="fu">aes</span>(<span class="at">x =</span> Time, <span class="at">y =</span> bandlow,<span class="at">col =</span> basis, <span class="at">group =</span> basis), <span class="at">linewidth =</span> <span class="fl">0.4</span>) <span class="sc">+</span> </span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> df.max, <span class="fu">aes</span>(<span class="at">x=</span>Time, <span class="at">y =</span> band.up, <span class="at">group=</span>basis), <span class="at">linewidth =</span> <span class="fl">0.4</span>) <span class="sc">+</span> </span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> df.max, <span class="fu">aes</span>(<span class="at">x=</span>Time, <span class="at">y =</span> band.low, <span class="at">group=</span>basis), <span class="at">linewidth =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="sc">~</span> basis)</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>p1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-realdata" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-realdata-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="ConfBand_files/figure-html/fig-realdata-1.png" style="height:25.0%" width="672" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-realdata-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: Real data analysis example. We display the confidence bands for Fourier (left), Legendre (middle) and Splines (right) basis on the Berkeley Growth Study data. Black curves correspond to the confidence bands with <span class="math inline">\(L_{max}\)</span>, while colored one are the confidence bands CBE.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>res_growth <span class="sc">%&gt;%</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="st">"latex"</span>, <span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_header_above</span>(<span class="fu">c</span>(<span class="st">" "</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">"Basis"</span> <span class="ot">=</span> <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tbl-realdata" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-realdata-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;6: Real data analysis example, Berkeley Growth Study data. We display the width of the confidence bands for Fourier, Legendre and Splines basis for the confidence band of <a href="#sec-bandSun" class="quarto-xref">Section&nbsp;3</a> with Lmax and the confidence band of <a href="#sec-modsel" class="quarto-xref">Section&nbsp;5</a>. We also precise the dimension of the selected model.
</figcaption>
<div aria-describedby="tbl-realdata-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">

</div>
</div>
</figure>
</div>
</div>
<p>In <a href="#fig-realdata" class="quarto-xref">Figure&nbsp;9</a>, we display the confidence bands associated <span style="color: red;">with</span> <!--to!--> <a href="#sec-bandSun" class="quarto-xref">Section&nbsp;3</a> in black and <span style="color: red;">those</span> <!--the one!--> associated <span style="color: red;">with</span> <!--to!--> <a href="#sec-modsel" class="quarto-xref">Section&nbsp;5</a>, for the three basis. As the data is not periodic, the Fourier basis is meaningless, <span style="color: red;">as is</span> <!--and so is!--> the associated confidence band, whatever the dimension considered. Splines and Legendre basis give similar confidence bands. <span style="color: red;">By</span> <!--When!--> analyzing the width of the bands in <a href="#tbl-realdata" class="quarto-xref">Table&nbsp;6</a>, compared <span style="color: red;">to that</span> <!--with the one!--> obtained with <span class="math inline">\(L_{\max}\)</span>, we <span style="color: red;">find</span> <!--see!--> that they are less smooth but also smaller, and from our empirical study we guess that it makes a trade-off between bias and variance.</p>
</section>
<section id="sec-conc" class="level1">
<h1>Conclusion</h1>
<p>This paper <span style="color: red;">deals with</span> <!--discusses!--> the construction of confidence bands when considering a <span style="color: red;">functional model.</span> <!--linear model over a functional family.!--> Depending on the nature of the family (an orthogonal or orthonormal basis, or simply a vector space), <span style="color: red;">the</span> theoretical guarantees of the linear estimator are <span style="color: red;">recalled</span> <!--reminded!--> and illustrated. Several confidence bands are then proposed. <!--Throughout the paper,!--> <span style="color: red;">An</span> extensive experimental study on Fourier, Legendre and Spline basis <!--have!--> illustrate<span style="color: red;">s</span> the theoretical and methodological propositions, and a real data study is proposed to conclude the paper.</p>
<p>First, when considering a functional family with fixed dimension, we discuss the confidence band derived from <span class="citation" data-cites="sun1994">@sun1994</span>. It is biased if the dimension is not high enough to approximate well the true function. <span style="color: red;">We then propose a</span> new confidence band <!--is proposed!--> that corrects this bias. To do this, the bias is estimated and the additional randomness is controlled. A selection criterion is proposed to select the best dimension. Unfortunately, the two <span style="color: red;">types</span> <!--kinds!--> of randomness <span style="color: red;">lead</span> <!--are leading!--> to a wider confidence band, and this result is <span style="color: red;">therefore no</span> <!--then not!--> more interesting than the naive one, which consists of taking the largest possible dimension <span class="math inline">\(L_{\max}\)</span>. Finally, a heuristic selection criterion is proposed to select the dimension on the first confidence band, <span style="color: red;">which has not corrected</span> <!--that did not correct!--> the bias. It takes into account the bias as well as the variance, to select a moderate dimension. <span style="color: red;">Numerical experiments show that this criterion, combined with the Legendre basis, achieve the best performance when considering the confidence level and the width of the corresponding simultaneous confidence band. </span></p>
<!--The last selection criterion is heuristic, <span style='color: red;'>and includes terms that are intuitive.</span> while each term is intuitive.!-->
<p>An interesting next step, but out of the scope of this paper, <span style="color: red;">is</span> <!--consists of!--> a theoretical study of this criterion. <span style="color: red;">To our knowledge, there are no results concerning the</span> <!--No result, to our knowledge, exist for!--> confidence band with the supremum norm. The euclidean norm <span style="color: red;">has been extensively studied,</span> <!--is well-studied in general,!--> but is not of interest here, where we want to ensure that the tube is valid as a whole. The supremum norm, on <span style="color: red;">the other hand,</span> <!--its side,!--> is difficult to study theoretically. <span style="color: red;">Futhermore, a</span> <!--A!--> keypoint here <!--also!--> is the randomness of the criterion, <span style="color: red;">which must also</span> <!--that has also to!--> be taken into account, through an oracle inequality for example.</p>
</section>
<section id="references" class="level1 unnumbered">
<h1 class="unnumbered">References</h1>
<div id="refs" role="list">

</div>
</section>
<section id="appendix-proofs" class="level1">
<h1>Appendix: proofs</h1>
<section id="proof-of-prp-error" class="level2">
<h2 class="anchored" data-anchor-id="proof-of-prp-error">Proof of <a href="#prp-error" class="quarto-xref">Proposition&nbsp;3</a></h2>
<p>Let us prove the first point. We have <span class="math display">\[ \mathbb{E}(\hat{\underline{\mu}}^{L,L^\star}) = (\mathbf{B}_L^T \mathbf{B}_L)^{-1} \mathbf{B}_L^T \mathbb{E}(\mathbf{y}) =(\mathbf{B}_L^T \mathbf{B}_L)^{-1} \mathbf{B}_L^T \mathbf{B}_{L^*}\mu^{L^*}=:\underline{\mu}^{L,L^\star}.\]</span></p>
<p>The theory of the linear model gives that the variance of <span class="math inline">\(\hat{\underline{\mu}}^L\)</span> is equal to <span class="math inline">\(\sigma^2 (\mathbf{B}^T\mathbf{B})^{-1} \mathbf{B}^T\Sigma \mathbf{B}(\mathbf{B}^T\mathbf{B})^{-1}\)</span> with <span class="math inline">\(\Sigma=Diag(\Sigma_1, \ldots, \Sigma_N)\)</span> the <span class="math inline">\(nN \times nN\)</span> covariance matrix of <span class="math inline">\(\mathbf{y}\)</span>. So finally, we have</p>
<p><span class="math display">\[
\hat{\underline{\mu}}^{L,L^\star}
\sim \mathcal{N}\left(\underline{\mu}^{L,L^\star}, \sigma^2\Sigma_{B}^{L, L^ \varepsilon}
\right).
\]</span></p>
<p>Now we can easily deduce the distribution of <span class="math inline">\(\hat{\underline{f}}^{L,L^*}(t)\)</span>, for each <span class="math inline">\(t\in [0,1]\)</span>: <span class="math display">\[\hat{\underline{f}}^{L,L^*}(t)- \mathbf f^{L,L^*}(t) \sim \mathcal{N}\left(0, \sigma^2 B(t)\Sigma_{B}^{L, L^\varepsilon} B(t)^T\right).\]</span></p>
<p><span style="color: red;">To prove that</span> <span class="math inline">\((\hat{\underline{f}}^{L, L^*}-f^{L,L^*})()\)</span> <span style="color: red;">is a Gaussian process, we consider any finite sequence of times</span>, <span class="math inline">\((t_1, \ldots, t_d)\in [0,1]\)</span>. <span style="color: red;">The sequence</span> <span class="math inline">\((\hat{\underline{f}}^{L, L^*}(t_1)-f^{L,L^*}(t_1), \ldots, \hat{\underline{f}}^{L, L^*}(t_d)-f^{L,L^*}(t_d))\)</span> <span style="color: red;">is Gaussian, centered and the covariance is equal to</span> <span class="math inline">\(cov(\hat{\underline{f}}^{L, L^*}(t_1)-f^{L,L^*}(t_1), \hat{\underline{f}}^{L, L^*}(t_2)-f^{L,L^*}(t_2)) = \sigma^2 B(t_1)\Sigma_{B}^{L, L^\varepsilon} B(t_2)^T\)</span>. <span style="color: red;">Thus the process is Gaussian.</span></p>
</section>
<section id="proof-of-thm-cb_liebl_asymptotic" class="level2">
<h2 class="anchored" data-anchor-id="proof-of-thm-cb_liebl_asymptotic">Proof of <a href="#thm-CB_Liebl_asymptotic" class="quarto-xref">Theorem&nbsp;2</a></h2>
<p>We have <span class="math display">\[P(\forall t \in [0,1], |\hat{\underline{f}}^{L, L^*}(t)-f^{L,L^*}(t)| \leq \hat d^L(t)) = P(\forall t \in [0,1], |\hat{\underline{f}}^{L, L^*}(t)-\underline{f}^{L, L^*}(t)+ \underline{f}^{L, L^*}(t)- f^{L,L^*}(t)| \leq \hat d^L(t))\]</span></p>
<p>Set Assumption 1 and Assumption 3 and a probability <span class="math inline">\(\alpha\in [0,1]\)</span>. Then, we have, <span class="math display">\[\lim_{n \rightarrow +\infty} P(\forall t \in [0,1], |\hat{\underline{f}}^{L, L^*}(t)-f^{L,L^*}(t)| \leq \hat d^L(t)) = 1-\alpha\]</span> with <span class="math inline">\(\hat d^L(t) = \hat c^L \sqrt{\hat C_L(t,t)/N}\)</span> and <span class="math inline">\(\hat c^L\)</span> defined as the solution of <a href="#eq-cL" class="quarto-xref">Equation&nbsp;4</a>.</p>
</section>
<section id="proof-of-prp-cbf" class="level2">
<h2 class="anchored" data-anchor-id="proof-of-prp-cbf">Proof of <a href="#prp-CBf" class="quarto-xref">Proposition&nbsp;5</a></h2>
<p>To simplify the notations, let us denote <span class="math inline">\(a(t) = \underline{f}^{L,L^*}(t) - \underline{\hat{f}}_1^{L,L^*}(t)\)</span> and <span class="math inline">\(b(t) = \underline{f}^{L_{\max},L^*}(t)- \underline{f}^{L,L^*}(t)-(\underline{\hat f}_2^{L_{\max}, L^*}(t)-\underline{\hat f}_2^{L,L^*}(t))\)</span>. We have <span class="math display">\[\begin{align*}
P\left( \exists t |a(t)+b(t)|\geq \hat d_1^L(t) + \hat d_2^{L,L_{\max}}(t)\right) &amp;\leq
P\left( \exists t |a(t)|+|b(t)|\geq \hat d_1^L(t) + \hat d_2^{L,L_{\max}}(t)\right)\\
&amp;= P\left( \exists t |a(t)| \geq \hat d_1^L(t) \right)P\left( \exists t |b(t)|\geq \hat d_2^{L,L_{\max}}(t)\right) = \alpha\beta.
\end{align*}\]</span></p>
<p>The last equality holds thanks to the independence of the two sub-samples.</p>
</section>
</section>
<section id="appendix-more-experiments" class="level1">
<h1>Appendix: more experiments</h1>
<p><a href="#prp-proj" class="quarto-xref">Proposition&nbsp;1</a> and <a href="#prp-proj2" class="quarto-xref">Proposition&nbsp;2</a> are illustrated in <a href="#fig-coefficients" class="quarto-xref">Figure&nbsp;10</a>. The true dimension is <span class="math inline">\(L^*=11\)</span>. Three families are considered, Fourier, Legendre and Splines. The plots display the absolute difference between the coefficients <span class="math inline">\(\mu_\ell^{L^*}\)</span> and the projected coefficients <span class="math inline">\(\underline{\mu}^{L,L^*}\)</span>, for different <span class="math inline">\(\ell\)</span> in x-axis and for different values of <span class="math inline">\(L\)</span> and <span class="math inline">\(n\)</span> in the y-axis, namely a case with <span class="math inline">\(L&lt;L^*\)</span> and two values of <span class="math inline">\(n\)</span>: <span class="math inline">\(L=7, n=20\)</span> and <span class="math inline">\(L=7, n=100\)</span>; and a case with <span class="math inline">\(L&gt;L^*\)</span> and two values of <span class="math inline">\(n\)</span>: <span class="math inline">\(L=15, n=20\)</span> and <span class="math inline">\(L=15, n=100\)</span>. The absolute difference is represented as a gradient of color, this gradient being adapted to each functional family. We can see that as Legendre (resp. Fourier) are orthonormal (resp. orthogonal) families, the differences are close to <span class="math inline">\(0\)</span> when <span class="math inline">\(L=15\)</span>, whatever the values of <span class="math inline">\(n\)</span>. When <span class="math inline">\(L&lt;L^*\)</span>, the difference is close to <span class="math inline">\(0\)</span> when <span class="math inline">\(n\)</span> is large. This property does not hold for the spline family, which is not orthogonal.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>cols <span class="ot">=</span> <span class="fu">brewer.pal</span>(<span class="dv">9</span>, <span class="st">"BuPu"</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">colorRampPalette</span>(cols)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>L.star <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>Time <span class="ot">=</span> <span class="fu">seq</span>(data<span class="sc">$</span>time[<span class="dv">1</span>], data<span class="sc">$</span>time[<span class="fu">length</span>(data<span class="sc">$</span>time)], <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>L.star <span class="ot">=</span> <span class="dv">11</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>vec.L <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">7</span>,<span class="dv">15</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">1</span>))</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (basis <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"Fourier"</span>, <span class="st">"Legendre"</span>, <span class="st">"Splines"</span>)){</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (basis <span class="sc">==</span> <span class="st">"Splines"</span>){</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">=</span> <span class="fu">dgp</span>(<span class="at">n=</span><span class="dv">20</span>,<span class="at">N=</span><span class="dv">40</span>,<span class="at">sd=</span><span class="dv">2</span><span class="sc">*</span><span class="dv">1</span>,<span class="at">L.star=</span>L.star, <span class="at">L.eps =</span> <span class="dv">20</span>, <span class="at">alpha.mu =</span> <span class="cn">NULL</span>, <span class="at">basis =</span> basis, <span class="at">f.true =</span> <span class="cn">NULL</span>)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> { data <span class="ot">=</span> <span class="fu">dgp</span>(<span class="at">n=</span><span class="dv">20</span>,<span class="at">N=</span><span class="dv">40</span>,<span class="at">sd=</span><span class="dv">1</span>,<span class="at">L.star=</span>L.star, <span class="at">L.eps =</span> <span class="dv">20</span>, <span class="at">alpha.mu =</span> <span class="cn">NULL</span>, <span class="at">basis =</span> basis, <span class="at">f.true =</span> <span class="cn">NULL</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  alpha.tot <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (L <span class="cf">in</span> vec.L){</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    B <span class="ot">=</span> <span class="fu">func.basis</span>(data<span class="sc">$</span>time, L, basis)</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    B.n.large <span class="ot">=</span> <span class="fu">func.basis</span>(Time, L, basis)</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    B.Lstar.n.large <span class="ot">=</span> <span class="fu">func.basis</span>(Time, L.star, basis)</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    alpha.true.L <span class="ot">=</span> <span class="fu">solve</span>(<span class="fu">t</span>(B) <span class="sc">%*%</span> B) <span class="sc">%*%</span> <span class="fu">t</span>(B) <span class="sc">%*%</span> data<span class="sc">$</span>f.true</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    alpha.true.L.n.large <span class="ot">=</span> <span class="fu">solve</span>(<span class="fu">t</span>(B.n.large) <span class="sc">%*%</span> B.n.large) <span class="sc">%*%</span> <span class="fu">t</span>(B.n.large) <span class="sc">%*%</span> B.Lstar.n.large <span class="sc">%*%</span> data<span class="sc">$</span>alpha.mu</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    alpha.tot <span class="ot">=</span> <span class="fu">cbind</span>(alpha.tot, alpha.true.L[<span class="dv">1</span><span class="sc">:</span><span class="fu">min</span>(<span class="fu">c</span>(L.star, vec.L))]<span class="sc">-</span>data<span class="sc">$</span>alpha.mu[<span class="dv">1</span><span class="sc">:</span><span class="fu">min</span>(<span class="fu">c</span>(L.star, vec.L))], alpha.true.L.n.large[<span class="dv">1</span><span class="sc">:</span><span class="fu">min</span>(<span class="fu">c</span>(L.star, vec.L))] <span class="sc">-</span> data<span class="sc">$</span>alpha.mu[<span class="dv">1</span><span class="sc">:</span><span class="fu">min</span>(<span class="fu">c</span>(L.star, vec.L))])</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">image.plot</span>(<span class="fu">abs</span>(alpha.tot), <span class="at">main =</span> <span class="fu">paste0</span>(basis, <span class="st">"'s basis"</span>), <span class="at">col =</span> <span class="fu">pal</span>(<span class="dv">20</span>), <span class="at">yaxt=</span><span class="st">"n"</span>, <span class="at">xaxt =</span> <span class="st">"n"</span>, <span class="at">xlab =</span> <span class="st">"index of the basis"</span> )</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axis</span>(<span class="dv">2</span>, <span class="at">at =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length =</span> <span class="fu">ncol</span>(alpha.tot)), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"L=7, n=20"</span>, <span class="st">"L=7, n=100"</span>, <span class="st">"L=15, n=20"</span>, <span class="st">"L=15, n=100"</span>), <span class="at">las =</span> <span class="dv">2</span>, <span class="at">cex.axis =</span> <span class="fl">0.6</span>)</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">axis</span>(<span class="dv">1</span>, <span class="at">at =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="at">length.out =</span> <span class="dv">7</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"1"</span>, <span class="st">"2"</span>, <span class="st">"3"</span>, <span class="st">"4"</span>, <span class="st">"5"</span>, <span class="st">"6"</span>, <span class="st">"7"</span>))</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-coefficients" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-coefficients-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="ConfBand_files/figure-html/fig-coefficients-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-coefficients-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10: Illustrative example. The true dimension is 11, we generate the coefficients with three families, Fourier (which is orthogonal), Legendre (which is orthonormal) and the splines (which are not orthogonal wrt the standard scalar product). In the y-axis, two dimensions of the family (7 or 15) and two numbers of timepoints (20 or 100) are compared. We plot in x-axis the value of the absolute difference between the true coefficients and their approximations for the first 7 coefficients of the basis. The color scale is adapted to each functional basis.
</figcaption>
</figure>
</div>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>